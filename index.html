<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHS Outlet Operations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand-hue: 231;
            --brand-saturation: 62%;
            --brand-lightness: 51%;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            /* Lighter background for a cleaner look */
            background-color: #f8fafc; /* slate-50 */
        }
        
        /* Sidebar Tab Navigation */
        .tab-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* gap-3 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem 1rem; /* px-4 py-3 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            color: #475569; /* slate-600 */
            transition: all 0.2s ease-in-out;
            width: 100%;
            text-align: left;
        }
        .tab-btn:hover {
            background-color: #f1f5f9; /* hover:bg-slate-100 */
            color: #0f172a; /* hover:text-slate-900 */
        }
        .tab-active {
            background-color: #eef2ff; /* bg-indigo-50 */
            color: #4f46e5; /* text-indigo-600 */
            font-weight: 600; /* semibold */
        }
        .tab-active:hover {
            background-color: #eef2ff; /* bg-indigo-50 */
            color: #4f46e5; /* text-indigo-600 */
        }

        .view { display: none; }
        .view-active { display: block; }

        /* Elegant Status Badges */
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; text-transform: capitalize; border-width: 1px; border-style: solid; }
        .status-pending, .status-no { background-color: #fefce8; color: #a16207; border-color: #fde047; }
        .status-wip, .status-partially-completed { background-color: #eff6ff; color: #1d4ed8; border-color: #93c5fd; }
        .status-approval-pending { background-color: #fff7ed; color: #c2410c; border-color: #fdba74;}
        .status-approved, .status-verified, .status-acknowledged, .status-yes { background-color: #f0fdf4; color: #15803d; border-color: #86efac; }
        .status-rejected { background-color: #f1f5f9; color: #475569; border-color: #cbd5e1; }
        .status-launched { background-color: #eef2ff; color: #4338ca; border-color: #a5b4fc; }
        .status-cancelled, .status-withdrawn { background-color: #f1f5f9; color: #64748b; border-color: #cbd5e1; }
        .status-completed { background-color: #f0fdf4; color: #15803d; border-color: #86efac; }
        
        .btn-disabled { opacity: 0.5; cursor: not-allowed; }
        .mandatory-star { color: #ef4444; display: none; }

        /* Modal backdrop with blur */
        .modal-backdrop { 
            backdrop-filter: blur(2px); 
            background-color: rgba(15, 23, 42, 0.6); 
            -webkit-backdrop-filter: blur(2px);
        }

        /* Custom Link Styling */
        .app-link {
            text-decoration: none;
            color: #4f46e5; /* text-indigo-600 */
            transition: color 0.2s ease-in-out;
        }
        .app-link:hover {
            text-decoration: none;
            color: #3730a3; /* text-indigo-800 */
        }

        /* Inner tabs for Proposals view */
        .inner-tab-btn {
            border-bottom: 2px solid transparent;
            padding: 1rem 0.25rem; /* py-4 px-1 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* semibold */
            color: #475569; /* text-slate-600 */
            transition: all 0.2s ease-in-out;
        }
        .inner-tab-btn:hover {
            border-color: #cbd5e1; /* hover:border-slate-300 */
            color: #0f172a; /* hover:text-slate-900 */
        }
        .inner-tab-active {
            border-color: #4f46e5; /* border-indigo-600 */
            color: #4f46e5; /* text-indigo-600 */
        }
        .inner-tab-active:hover {
            border-color: #4f46e5; /* border-indigo-600 */
            color: #4f46e5; /* text-indigo-600 */
        }
        .inner-panel { display: none; }
        .inner-panel-active { display: block; }
        
        /* NEW STYLES FOR SUMMARY TABLE */
        .summary-stage-col {
            display: none;
        }
        .summary-table-expanded .summary-stage-col {
            display: table-cell;
        }
        /* Global table normalization: consistent look across views */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            color: #0f172a;
        }
        table thead th {
            background-color: #f8fafc; /* light slate */
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.03em;
            color: #475569;
            border-bottom: 1px solid #e6eef5;
        }
        table th, table td {
            padding: 0.65rem 0.75rem;
            vertical-align: middle;
            border-bottom: 1px solid #eef2f7;
        }
        table tbody tr:hover {
            background-color: rgba(79,70,229,0.03); /* subtle indigo hover */
        }
        table tbody td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Allow specific cells to opt-out to wrap text */
        .whitespace-normal { white-space: normal !important; }

        /* Inputs inside tables should be compact and consistent */
        table input[type="text"], table input[type="search"], table input[type="date"], table input[type="number"], table select {
            box-sizing: border-box;
            padding: 0.4rem 0.5rem;
            border: 1px solid #e6edf3;
            border-radius: 6px;
            font-size: 0.9rem;
            background: #fff;
        }
        /* Responsive wrapper utility (some tables already use overflow wrappers) */
        .table-responsive { overflow-x: auto; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="dashboard-view">
        <!-- Header: Changed to white bg with border for a more modern app feel -->
        <header class="bg-white text-slate-800 p-4 flex items-center shadow-sm border-b border-slate-200/80">
            <button class="mr-4 text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold text-indigo-700">OHS Outlet Operations</h1>
        </header>
        <main class="p-4 md:p-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-5">
                <!-- Card: Workflow -->
                <!-- Dashboard Card: Re-styled for a cleaner, left-aligned look -->
                <div class="bg-green-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-green-200/60 hover:shadow-md hover:border-green-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-green-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 00-1-1v-1a2 2 0 10-4 0v1a1 1 0 00-1 1H7a1 1 0 01-1-1v-3a1 1 0 011-1h1a2 2 0 100-4H7a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-green-800">Workflow</h2>
                </div>

                <!-- Card: Roster -->
                <div class="bg-blue-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-blue-200/60 hover:shadow-md hover:border-blue-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-blue-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-blue-800">Roster</h2>
                </div>

                <!-- Card: Movement Register -->
                 <div class="bg-red-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-red-200/60 hover:shadow-md hover:border-red-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-red-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-3.072a3 3 0 00-3-3H9a3 3 0 00-3 3V21" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-red-800">Movement Register</h2>
                </div>

                <!-- Card: Alerts Management -->
                 <div class="bg-cyan-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-cyan-200/60 hover:shadow-md hover:border-cyan-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-cyan-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-cyan-800">Alerts Management</h2>
                </div>

                <!-- Card: Referrals -->
                 <div class="bg-gray-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-gray-200/60 hover:shadow-md hover:border-gray-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-gray-800">Referrals</h2>
                </div>

                 <!-- Card: Complaints Register -->
                 <div class="bg-red-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-red-200/60 hover:shadow-md hover:border-red-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-red-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-red-800">Complaints Register</h2>
                </div>
                
                 <!-- Card: SC Performance Tracker -->
                <div class="bg-purple-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-purple-200/60 hover:shadow-md hover:border-purple-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-purple-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-purple-800">SC Performance Tracker</h2>
                </div>
                
                 <!-- Card: Appraisal -->
                <div class="bg-orange-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-orange-200/60 hover:shadow-md hover:border-orange-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-orange-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-orange-800">Appraisal</h2>
                </div>
                
                 <!-- Card: Registers -->
                <div class="bg-blue-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-blue-200/60 hover:shadow-md hover:border-blue-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-blue-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-blue-800">Registers</h2>
                </div>
                
                 <!-- Card: Store Visit Reports -->
                <div class="bg-green-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-green-200/60 hover:shadow-md hover:border-green-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-green-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-green-800">Store Visit Reports</h2>
                </div>
                
                 <!-- Card: Store Business Review -->
                <div class="bg-purple-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-purple-200/60 hover:shadow-md hover:border-purple-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-purple-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7v3m0 0v3m0-3h3m-3 0H9" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-purple-800">Store Business Review</h2>
                </div>

                <!-- Card: NPD Tracker -->
                <div id="npd-card-main" class="bg-indigo-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-indigo-200/60 hover:shadow-md hover:border-indigo-400/80 transition-all cursor-pointer">
                  <div class="w-12 h-12 rounded-full bg-indigo-200 flex items-center justify-center flex-shrink-0">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                     </svg>
                  </div>
                  <h2 class="font-semibold text-indigo-800">NPD Tracker</h2>
                </div>
                 
                 <!-- Card: Others -->
                <div class="bg-gray-50 p-5 rounded-xl shadow-sm flex items-center gap-4 border border-gray-200/60 hover:shadow-md hover:border-gray-400/80 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                        </svg>
                    </div>
                    <h2 class="font-semibold text-gray-800">Others</h2>
                </div>
            </div>
        </main>
    </div>

    <div id="tracker-view" style="display: none;">
        <!-- New Main Sidebar & Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity opacity-0 duration-300 ease-in-out"></div>
        <div id="main-sidebar" class="fixed top-0 left-0 h-full w-72 bg-white shadow-xl z-50 p-4 transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-indigo-700">Menu</h2>
                <button id="close-main-sidebar-btn" class="p-2 rounded-full hover:bg-slate-100 text-slate-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <nav class="flex flex-col space-y-1">
                <button id="sidebar-home-btn" class="tab-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span>Home Dashboard</span>
                </button>
                <!-- Other main menu items could be added here -->
                <hr class="my-2 border-slate-200" />
                <button id="tab-summary" class="tab-btn tab-active">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m3 6V9a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h14a2 2 0 002-2z" /></svg>
                    <span>Summary</span>
                </button>
                <button id="tab-proposals" class="tab-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    <span>Proposals</span>
                </button>
                <!-- This button was redundant and has been removed -->
                <!-- 
                <button id="tab-approved-proposals" class="tab-btn">
                    ...
                </button>
                 -->
                <button id="tab-new-products" class="tab-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    <span>New Products List</span>
                </button>
            </nav>
        </div>

        <!-- Wrapped the tracker in a card for visual separation -->
        <div id="app" class="max-w-7xl mx-auto bg-white rounded-xl border border-slate-200/80 shadow-sm my-8 overflow-hidden">

            <!-- Header: Added padding and border -->
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center p-4 md:px-6 lg:px-8 border-b border-slate-200">
                <div class="flex items-center gap-4">
                     <button id="menu-btn" title="Open Menu" class="p-2 rounded-full hover:bg-slate-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <div>
                        <h1 class="text-2xl font-bold text-indigo-700">NPD Tracker</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-2 mt-4 md:mt-0">
                    <div> <!-- WRAPPED EXISTING SELECTOR -->
                        <label for="roleSelector" class="text-sm font-medium text-slate-600">View</label>
                        <select id="roleSelector" class="block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                            <option>Employee(Alice)</option>
                            <option>Manager</option>
                        </select>
                    </div>
                </div>
            </header>

            <!-- New Flex container for sidebar + main -->
            <!-- <div class="flex flex-row"> --> <!-- This wrapper is removed -->
                <!-- Sidebar -->
                <!-- 
                <aside class="w-64 flex-shrink-0 bg-white border-r border-slate-200 p-4">
                    <nav class="flex flex-col space-y-1" aria-label="Tabs">
                        <button id="tab-summary" class="tab-btn tab-active">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m3 6V9a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h14a2 2 0 002-2z" /></svg>
                            <span>Summary</span>
                        </button>
                        <button id="tab-proposals" class="tab-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <span>Product Proposals</span>
                        </button>
                        <button id="tab-approved-proposals" class="tab-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            <span>Approved Proposal</span>
                        </button>
                        <button id="tab-new-products" class="tab-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                            <span>New Products List</span>
                        </button>
                    </nav>
                </aside>
                --> <!-- The entire static aside block is removed -->

                <!-- Main Content Area -->
                <main id="views-container" class="p-6 md:p-8 bg-slate-50/70 overflow-y-auto">
                    <!-- Summary View -->
                    <div id="view-summary" class="view view-active">
                        <div class="flex justify-between items-center mb-4">
                            <h2 id="summary-title" class="text-xl font-semibold text-indigo-700">Employee Product Progress Summary</h2>
                             <div class="flex space-x-4">
                                <div>
                                    <label for="summary-fy-filter" class="block text-sm font-medium text-slate-700">Financial Year</label>
                                    <select id="summary-fy-filter" multiple size="5" class="mt-1 block w-48 pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="clear-filters-summary" type="button" class="ml-2 inline-flex items-center gap-2 bg-slate-200 text-slate-700 font-medium py-2 px-3 rounded-md hover:bg-slate-300 transition">Clear Filters</button>
                                </div>
                             </div>
                        </div>
                         <div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden">
                            <div class="overflow-x-auto">
                                <!-- MODIFICATION: Added id="summary-table" -->
                                <table id="summary-table" class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50/75">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Emp ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Emp Name</th>
                                            <!-- MODIFICATION: Added id="wip-expand-th" -->
                                            <th id="wip-expand-th" class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">WIP <button type="button" id="wip-expand-btn" class="normal-case">&lt;&gt;</button></th>
                                            
                                            <!-- MODIFICATION: Added all stage columns with class="summary-stage-col" -->
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider summary-stage-col">Agreement Completed</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider summary-stage-col">Art Work Completed</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider summary-stage-col">Pricing Completed</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider summary-stage-col">Branding Completed</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider summary-stage-col">Vendor KYC Completed</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider summary-stage-col">PO released</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider summary-stage-col">Production Started</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider summary-stage-col">Raw Materials Procured</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider summary-stage-col">Packing Materials Procured</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider summary-stage-col">GRN Completed</th>
                                            
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Launched</th>
                                        </tr>
                                        <!-- MODIFICATION: Added all filter cells -->
                                        <tr class="bg-white">
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-summary-empId" type="text" placeholder="Filter ID" class="w-full form-input border border-slate-200 rounded px-2 py-1" />
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-summary-empName" type="text" placeholder="Filter name" class="w-full form-input border border-slate-200 rounded px-2 py-1" />
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs"><!-- no filter for counts --></th>
                                            
                                            <!-- MODIFICATION: Added empty cells for stage columns -->
                                            <th class="summary-stage-col px-6 py-2"></th>
                                            <th class="summary-stage-col px-6 py-2"></th>
                                            <th class="summary-stage-col px-6 py-2"></th>
                                            <th class="summary-stage-col px-6 py-2"></th>
                                            <th class="summary-stage-col px-6 py-2"></th>
                                            <th class="summary-stage-col px-6 py-2"></th>
                                            <th class="summary-stage-col px-6 py-2"></th>
                                            <th class="summary-stage-col px-6 py-2"></th>
                                            <th class="summary-stage-col px-6 py-2"></th>
                                            <th class="summary-stage-col px-6 py-2"></th>
                                            
                                            <th class="px-6 py-2 text-left text-xs"><!-- no filter for counts --></th>
                                        </tr>
                                    </thead>
                                    <tbody id="summary-table-body" class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                <!-- Proposal List View -->
                <div id="view-proposals" class="view">
                    <!-- New Inner Tab Navigation -->
                    <div class="border-b border-slate-200 mb-6">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="inner-tab-current" class="inner-tab-btn inner-tab-active" aria-current="page">
                                Current Proposals
                            </button>
                            <button id="inner-tab-approved" class="inner-tab-btn">
                                Approved Proposals
                            </button>
                            <button id="inner-tab-archived" class="inner-tab-btn">
                                Rejected/Withdrawn
                            </button>
                        </nav>
                    </div>

                    <!-- Inner Panel for Current Proposals -->
                    <div id="inner-panel-current" class="inner-panel inner-panel-active">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold text-indigo-700">Current Proposals</h2>
                            <button id="btn-create-proposal" class="inline-flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-all duration-200 hover:shadow-md focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Create Proposal
                            </button>
                        </div>

                        <!-- Filters (Financial Year retained; column filters moved to table header) -->
                        <div class="flex space-x-4 mb-4 bg-white p-4 rounded-lg border border-slate-200/80 shadow-sm justify-end">
                            <div>
                                <label for="filter-proposal-fy" class="block text-sm font-medium text-slate-700">Financial Year</label>
                                <select id="filter-proposal-fy" multiple size="5" class="mt-1 block w-48 pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                            </div>
                            <div class="flex items-end">
                                <button id="clear-filters-current" type="button" class="ml-4 inline-flex items-center gap-2 bg-slate-200 text-slate-700 font-medium py-2 px-3 rounded-md hover:bg-slate-300 transition">Clear Filters</button>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50/75">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Proposal ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Type</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Description</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Pending Commercials</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Owner</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created On</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created by</th>
                                        </tr>
                                        <tr class="bg-white">
                                            <th class="px-6 py-2 text-left text-xs"><!-- empty for id --></th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <select id="col-filter-productType" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                                    <option value="">All</option>
                                                    <option>Pharma</option>
                                                    <option>FMCG</option>
                                                    <option>Surgical</option>
                                                    <option>Device</option>
                                                </select>
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-description" type="search" placeholder="Search description" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <select id="col-filter-status" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                                    <option value="">All</option>
                                                    <option>Pending</option>
                                                    <option>WIP</option>
                                                    <option>Approval Pending</option>
                                                </select>
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs"><!-- no filter for counts --></th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-owner" type="search" placeholder="Search owner" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs"><!-- date filter removed --></th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-createdBy" type="search" placeholder="Search created by" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="proposals-table-body" class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Inner Panel for Approved Proposals -->
                    <div id="inner-panel-approved" class="inner-panel">
                         <div class="flex justify-between items-center mb-4">
                             <h2 class="text-xl font-semibold text-indigo-700">Approved Proposals</h2>
                             <div class="flex space-x-4">
                                <div>
                                    <label for="filter-approved-fy" class="block text-sm font-medium text-slate-700">Financial Year</label>
                                    <select id="filter-approved-fy" multiple size="5" class="mt-1 block w-48 pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                                </div>
                                <div class="flex items-end">
                                    <button id="clear-filters-approved" type="button" class="ml-2 inline-flex items-center gap-2 bg-slate-200 text-slate-700 font-medium py-2 px-3 rounded-md hover:bg-slate-300 transition">Clear Filters</button>
                                </div>
                             </div>
                         </div>
                          <div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50/75">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Proposal ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Type</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Description</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Owner</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Approved Commercials</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Pending Commercials</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created On</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created by</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Approved By</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Approved On</th>
                                        </tr>
                                        <tr class="bg-white">
                                            <th class="px-6 py-2 text-left text-xs"><!-- empty for id --></th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <select id="col-filter-approved-productType" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                                    <option value="">All</option>
                                                    <option>Pharma</option>
                                                    <option>FMCG</option>
                                                    <option>Surgical</option>
                                                    <option>Device</option>
                                                </select>
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-approved-description" type="search" placeholder="Search description" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-approved-owner" type="search" placeholder="Search owner" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs"><!-- no filter for counts --></th>
                                            <th class="px-6 py-2 text-left text-xs"><!-- no filter for counts --></th>
                                            <th class="px-6 py-2 text-left text-xs"><!-- date filter removed --></th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-approved-createdBy" type="search" placeholder="Search created by" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-approved-approvedBy" type="search" placeholder="Search approved by" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs"><!-- date filter removed --></th>
                                        </tr>
                                    </thead>
                                    <tbody id="approved-proposals-table-body" class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Inner Panel for Archived Proposals -->
                    <div id="inner-panel-archived" class="inner-panel">
                         <div class="flex justify-between items-center mb-4">
                             <h2 class="text-xl font-semibold text-indigo-700">Rejected/Withdrawn Proposals</h2>
                             <div class="flex space-x-4">
                                <div>
                                    <label for="filter-archived-fy" class="block text-sm font-medium text-slate-700">Financial Year</label>
                                    <select id="filter-archived-fy" multiple size="5" class="mt-1 block w-48 pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                                </div>
                                    <div class="flex items-end">
                                        <button id="clear-filters-archived" type="button" class="ml-2 inline-flex items-center gap-2 bg-slate-200 text-slate-700 font-medium py-2 px-3 rounded-md hover:bg-slate-300 transition">Clear Filters</button>
                                    </div>
                             </div>
                         </div>
                          <div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50/75">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Proposal ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Type</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Description</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Owner</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created On</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created by</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Rejected/Withdrawn By</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Rejected/Withdrawn On</th>
                                        </tr>
                                        <tr class="bg-white">
                                            <th class="px-6 py-2 text-left text-xs"><!-- empty for id --></th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <select id="col-filter-arch-productType" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                                    <option value="">All</option>
                                                    <option>Pharma</option>
                                                    <option>FMCG</option>
                                                    <option>Surgical</option>
                                                    <option>Device</option>
                                                </select>
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-arch-description" type="search" placeholder="Search description" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <select id="col-filter-arch-status" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                                    <option value="">All</option>
                                                    <option>Rejected</option>
                                                    <option>Withdrawn</option>
                                                </select>
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-arch-owner" type="search" placeholder="Search owner" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs"><!-- date filter removed --></th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-arch-createdBy" type="search" placeholder="Search created by" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs">
                                                <input id="col-filter-arch-rejectedBy" type="search" placeholder="Search rejected/withdrawn by" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-slate-200 rounded">
                                            </th>
                                            <th class="px-6 py-2 text-left text-xs"><!-- date filter removed --></th>
                                        </tr>
                                    </thead>
                                    <tbody id="archived-proposals-table-body" class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Approved Proposal List View (REMOVED) -->
                <!-- <div id="view-approved-proposals" class="view"> ... </div> -->

                <!-- New Products List View -->
                <div id="view-new-products-list" class="view">
                     <!-- REMOVED: <h2 class="text-xl font-semibold text-indigo-700 mb-4">New Products List</h2> -->

                     <!-- MODIFICATION START: Added header with button -->
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-indigo-700">New Products List</h2>
                        <button id="btn-transfer-wip-owner-bulk" class="inline-flex items-center gap-2 bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-slate-700 transition-all duration-200 hover:shadow-md focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z" />
                            </svg>
                            Transfer Ownership
                        </button>
                    </div>
                    <!-- MODIFICATION END -->

                     <!-- MODIFICATION START: Removed Filter Section -->
                     <!-- The filter block that was here has been removed. -->
                     <!-- MODIFICATION END -->

                     <!-- MODIFICATION: Inner Tab Navigation + Filter -->
                    <div class="flex justify-between items-center border-b border-slate-200 mb-6">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="inner-tab-wip" class="inner-tab-btn inner-tab-active" aria-current="page">
                                WIP/Approval Pending
                            </button>
                            <button id="inner-tab-launched" class="inner-tab-btn">
                                Launched
                            </button>
                            <button id="inner-tab-withdrawn" class="inner-tab-btn">
                                Withdrawn
                            </button>
                        </nav>
                        <!-- Filter on the right, aligned with tabs -->
                        <div class="flex items-center space-x-2">
                            <label for="filter-new-products-fy" class="block text-sm font-medium text-slate-700">Financial Year</label>
                            <select id="filter-new-products-fy" multiple size="5" class="mt-1 block w-48 pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <!-- Options will be populated by JS -->
                            </select>
                            <div class="ml-3">
                                <button id="clear-filters-new-products" type="button" class="inline-flex items-center gap-2 bg-slate-200 text-slate-700 font-medium py-2 px-3 rounded-md hover:bg-slate-300 transition">Clear Filters</button>
                            </div>
                        </div>
                    </div>

                    <!-- ADDED: Inner Panel for WIP Products -->
                    <div id="inner-panel-wip" class="inner-panel inner-panel-active">
                        <div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50/75">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Id</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Proposal Id</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Commercial ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vendor Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Owner</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created On</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created By</th>
                                        </tr>
                                            <tr>
                                                <td class="px-6 py-2"></td>
                                                <td class="px-6 py-2"><input id="col-filter-wip-productName" type="text" placeholder="Filter product" class="w-full form-input" /></td>
                                                <td class="px-6 py-2"><input id="col-filter-wip-proposalId" type="text" placeholder="Filter proposal id" class="w-full form-input" /></td>
                                                <td class="px-6 py-2"></td>
                                                <td class="px-6 py-2"><input id="col-filter-wip-vendorName" type="text" placeholder="Filter vendor" class="w-full form-input" /></td>
                                                <td class="px-6 py-2">
                                                    <select id="col-filter-wip-status" class="w-full form-select">
                                                        <option value="">All</option>
                                                        <option value="WIP">WIP</option>
                                                        <option value="Approval Pending">Approval Pending</option>
                                                    </select>
                                                </td>
                                                <td class="px-6 py-2"><input id="col-filter-wip-owner" type="text" placeholder="Filter owner" class="w-full form-input" /></td>
                                                <td class="px-6 py-2"><!-- date filter removed --></td>
                                                <td class="px-6 py-2"><input id="col-filter-wip-createdBy" type="text" placeholder="Filter created by" class="w-full form-input" /></td>
                                            </tr>
                                    </thead>
                                    <!-- CHANGED ID -->
                                    <tbody id="new-products-table-body-wip" class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ADDED: Inner Panel for Launched Products -->
                    <div id="inner-panel-launched" class="inner-panel">
                        <div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50/75">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Id</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Proposal Id</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Commercial ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vendor Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Owner</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created On</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created By</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Launched On</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Launched By</th>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-2"></td>
                                            <td class="px-6 py-2"><input id="col-filter-launched-productName" type="text" placeholder="Filter product" class="w-full form-input" /></td>
                                            <td class="px-6 py-2"><input id="col-filter-launched-proposalId" type="text" placeholder="Filter proposal id" class="w-full form-input" /></td>
                                            <td class="px-6 py-2"></td>
                                            <td class="px-6 py-2"><input id="col-filter-launched-vendorName" type="text" placeholder="Filter vendor" class="w-full form-input" /></td>
                                            <td class="px-6 py-2"><input id="col-filter-launched-owner" type="text" placeholder="Filter owner" class="w-full form-input" /></td>
                                            <td class="px-6 py-2"><!-- date filter removed --></td>
                                            <td class="px-6 py-2"><input id="col-filter-launched-createdBy" type="text" placeholder="Filter created by" class="w-full form-input" /></td>
                                            <td class="px-6 py-2"><!-- date filter removed --></td>
                                            <td class="px-6 py-2"><input id="col-filter-launched-launchedBy" type="text" placeholder="Filter launched by" class="w-full form-input" /></td>
                                        </tr>
                                    </thead>
                                    <!-- ADDED ID -->
                                    <tbody id="new-products-table-body-launched" class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ADDED: Inner Panel for Withdrawn Products -->
                    <div id="inner-panel-withdrawn" class="inner-panel">
                        <div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-200">
                                    <thead class="bg-slate-50/75">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Id</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Proposal Id</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Commercial ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vendor Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Owner</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created On</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created By</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Withdrawn On</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Withdrawn By</th>
                                            </tr>
                                            <tr>
                                                <td class="px-6 py-2"></td>
                                                <td class="px-6 py-2"><input id="col-filter-withdrawn-productName" type="text" placeholder="Filter product" class="w-full form-input" /></td>
                                                <td class="px-6 py-2"><input id="col-filter-withdrawn-proposalId" type="text" placeholder="Filter proposal id" class="w-full form-input" /></td>
                                                <td class="px-6 py-2"></td>
                                                <td class="px-6 py-2"><input id="col-filter-withdrawn-vendorName" type="text" placeholder="Filter vendor" class="w-full form-input" /></td>
                                                <td class="px-6 py-2"><input id="col-filter-withdrawn-owner" type="text" placeholder="Filter owner" class="w-full form-input" /></td>
                                                <td class="px-6 py-2"><!-- date filter removed --></td>
                                                <td class="px-6 py-2"><input id="col-filter-withdrawn-createdBy" type="text" placeholder="Filter created by" class="w-full form-input" /></td>
                                                <td class="px-6 py-2"><!-- date filter removed --></td>
                                                <td class="px-6 py-2"><input id="col-filter-withdrawn-withdrawnBy" type="text" placeholder="Filter withdrawn by" class="w-full form-input" /></td>
                                            </tr>
                                        </thead>
                                    <!-- ADDED ID -->
                                    <tbody id="new-products-table-body-withdrawn" class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Proposal Task List View -->
                <div id="view-proposal-tasks" class="view">
                    <button class="back-to-approved-list-btn mb-4 font-medium app-link">&larr; Back to Approved Proposals</button>
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="proposal-tasks-title" class="text-xl font-semibold text-indigo-700"></h2>
                        <button id="btn-add-commercials" class="inline-flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-all duration-200 hover:shadow-md focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M8.433 7.418c.158-.103.346-.196.567-.267v1.698a2.5 2.5 0 00-.567-.267zM11.567 7.151c.22.07.408.164.567.267v-1.698a2.5 2.5 0 00-.567.267z" />
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.484.328.958.684 1.123 1.003.142.276.121.614-.054.852a1.75 1.75 0 01-1.206.883c-.502.138-1.018.024-1.426-.298a1.75 1.75 0 00-2.573 2.063c1.138.992 2.61.903 3.532.448.97-.472 1.34-1.543.83-2.565-.211-.42-.51-1.002-.51-1.486 0-.61.288-1.125.86-1.533.424-.29 1.052-.52 1.676-.662V5z" clip-rule="evenodd" />
                            </svg>
                            Add New Commercials
                        </button>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50/75">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vendor</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Owner</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created On</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created by</th>
                                    </tr>
                                </thead>
                                <tbody id="proposal-tasks-table-body" class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Proposal Detail View -->
                <div id="view-proposal-detail" class="view">
                     <button id="proposal-detail-back-btn" class="mb-4 font-medium app-link">&larr; Back to Proposals</button>
                     <div class="bg-white p-6 rounded-xl border border-slate-200/80 shadow-sm mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-start mb-4">
                            <div>
                               <h2 id="detail-proposal-id" class="text-2xl font-bold text-indigo-700"></h2>
                               <p id="detail-proposal-type" class="text-slate-500"></p>
                            </div>
                        </div>
                        <div id="detail-proposal-info" class="border-t border-slate-200 pt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"></div>
                        <div id="detail-proposal-actions" class="mt-6 flex flex-wrap gap-3"></div>
                    </div>

                    <!-- Stages -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <!-- Cards -->
                        <div id="card-vendor" class="stage-card bg-white p-5 rounded-xl border border-slate-200/80 shadow-sm transition-all duration-300 hover:shadow-lg hover:-translate-y-1 cursor-pointer">
                            <div class="flex items-start space-x-4">
                                <div class="p-3 rounded-lg bg-blue-100 text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5c0-.907-.383-1.74-.984-2.282A3.753 3.753 0 0010.5 10.5H3.75c-1.12 0-2.16.44-2.92 1.165A4.004 4.004 0 000 14.25v.003c.001.01.002.02.003.03v5.214a2.25 2.25 0 002.25 2.25h8.25a2.25 2.25 0 002.25-2.25z" /><path stroke-linecap="round" stroke-linejoin="round" d="M18 21v-7.5a2.25 2.25 0 012.25-2.25h.003a2.25 2.25 0 012.25 2.25V21m0 0h-4.5m4.5 0v.003c0 .017 0 .034-.002.051a2.25 2.25 0 01-2.248 2.199h-1.004a2.25 2.25 0 01-2.248-2.199c-.002-.017-.002-.034-.002-.051v-14.25a2.25 2.25 0 012.25-2.25h1.004a2.25 2.25 0 012.248 2.199c.002.017.002.034.002.051V21" /></svg></div>
                                <div><p id="vendor-count" class="text-3xl font-bold text-slate-800">0</p><h3 class="font-semibold text-sm text-slate-600">Vendor Identification</h3></div>
                            </div>
                        </div>
                        <div id="card-sample" class="stage-card bg-white p-5 rounded-xl border border-slate-200/80 shadow-sm transition-all duration-300 hover:shadow-lg hover:-translate-y-1 cursor-pointer">
                             <div class="flex items-start space-x-4">
                                <div class="p-3 rounded-lg bg-green-100 text-green-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.5h-8.01a1.5 1.5 0 01-1.5-1.5V7.5a1.5 1.5 0 011.5-1.5h8.01a1.5 1.5 0 011.5 1.5v11.25a1.5 1.5 0 01-1.5 1.5z" /></svg></div>
                                <div><p id="sample-count" class="text-3xl font-bold text-slate-800">0</p><h3 class="font-semibold text-sm text-slate-600">Sample</h3></div>
                            </div>
                        </div>
                        <div id="card-commercials" class="stage-card bg-white p-5 rounded-xl border border-slate-200/80 shadow-sm transition-all duration-300 hover:shadow-lg hover:-translate-y-1 cursor-pointer">
                            <div class="flex items-start space-x-4">
                                <div class="p-3 rounded-lg bg-yellow-100 text-yellow-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.75A.75.75 0 013 4.5h.75m0 0h.75A.75.75 0 015.25 6v.75m0 0v-.75A.75.75 0 015.25 4.5h-.75m0 0h.75A.75.75 0 016.75 6v.75m0 0v-.75A.75.75 0 016.75 4.5h.75m.75 13.5c.75-.621 1.5-1.242 2.25-1.863a25.02 25.02 0 012.25-1.863m-4.5 3.726c.75-.621 1.5-1.242 2.25-1.863a25.02 25.02 0 012.25-1.863m0 0A25.02 25.02 0 0115 13.5m0 0c.75-.621 1.5-1.242 2.25-1.863a25.02 25.02 0 012.25-1.863m0 0A25.02 25.02 0 0119.5 9m0 0c.75-.621 1.5-1.242 2.25-1.863a25.02 25.02 0 012.25-1.863M21 4.5m0 0A25.02 25.02 0 0115 13.5m6-9c.75-.621 1.5-1.242 2.25-1.863A25.02 25.02 0 0121 4.5m-6 9A25.02 25.02 0 019 13.5" /></svg></div>
                                <div><p id="commercials-count" class="text-3xl font-bold text-slate-800">0</p><h3 class="font-semibold text-sm text-slate-600">Commercials</h3></div>
                            </div>
                        </div>
                        <div id="card-agreement-proposal" class="stage-card bg-white p-5 rounded-xl border border-slate-200/80 shadow-sm transition-all duration-300 hover:shadow-lg hover:-translate-y-1 cursor-pointer">
                            <div class="flex items-start space-x-4">
                                <div class="p-3 rounded-lg bg-blue-100 text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                                <div><p id="agreement-proposal-count" class="text-3xl font-bold text-slate-800">0</p><h3 class="font-semibold text-sm text-slate-600">Agreement (proposal)</h3></div>
                            </div>
                        </div>
                    </div>
                    <!-- Container for products table in approved view -->
                    <div id="products-for-approved-proposal-container" class="mt-8"></div>
                </div>

                <!-- Stage Detail Form Views -->
                <div id="view-stage-detail" class="view">
                     <button class="back-to-detail-btn mb-4 font-medium app-link">&larr; Back to Proposal Detail</button>
                     <div class="flex justify-between items-center mb-4">
                        <h2 id="stage-detail-title" class="text-xl font-semibold text-indigo-700"></h2>
                        <button id="btn-add-stage-entry" class="inline-flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-all duration-200 hover:shadow-md focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 hidden"></button>
                     </div>
                     <div class="bg-white p-6 rounded-xl border border-slate-200/80 shadow-sm">
                        <div id="stage-detail-content" class="overflow-x-auto"></div>
                    </div>
                </div>

                <!-- WIP Task Detail View -->
                <div id="view-wip-detail" class="view">
                    <button class="back-to-proposal-tasks-btn mb-4 font-medium app-link">&larr; Back to Product List</button>
                     <div class="bg-white p-6 rounded-xl border border-slate-200/80 shadow-sm mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-start">
                            <div>
                               <h2 id="wip-detail-name" class="text-2xl font-bold text-indigo-700"></h2>
                               <p id="wip-detail-vendor" class="text-slate-500"></p>
                            </div>
                            <div id="wip-detail-status" class="mt-2 md:mt-0"></div>
                        </div>
                        <div id="wip-detail-info" class="mt-4 border-t border-slate-200 pt-4 text-sm flex items-center justify-around gap-6 overflow-x-auto whitespace-nowrap"></div>
                        <div id="wip-detail-actions" class="mt-6 border-t border-slate-200 pt-4 flex flex-wrap gap-3"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200/80 shadow-sm">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Development Stages</h3>
                        <div id="wip-stages-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
                
                 <!-- WIP Stage Detail View -->
                <div id="view-wip-stage-detail" class="view">
                    <button class="back-to-wip-detail-btn mb-4 font-medium app-link">&larr; Back to Product Details</button>
                     <div class="flex justify-between items-center mb-4">
                        <h2 id="wip-stage-detail-title" class="text-xl font-semibold text-indigo-700"></h2>
                        <button id="btn-add-wip-entry" class="inline-flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-all duration-200 hover:shadow-md focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add Details</button>
                     </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200/80 shadow-sm">
                        <div id="wip-stage-detail-content" class="overflow-x-auto"></div>
                    </div>
                </div>

            </main>
        </div>
        </div>
    </div>
    
    <!-- Modals are outside the #app container to ensure they cover everything -->
    <div id="modals-container">
        <!-- Modals will be injected here if I refactor, for now they are here -->
        <div id="create-proposal-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-6 border-none w-full max-w-3xl shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 id="proposal-form-title-modal" class="text-xl font-semibold text-slate-800">Create New Product Proposal</h2>
                    <button id="close-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <form id="proposal-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="productType" class="block text-sm font-medium text-slate-700">Product Type <span class="text-red-500">*</span></label>
                        <select id="productType" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="description" class="block text-sm font-medium text-slate-700">Description <span class="text-red-500">*</span></label>
                        <textarea id="description" rows="3" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                    </div>
                    <div id="packSize-container" class="md:col-span-2 hidden">
                        <label for="packSize" class="block text-sm font-medium text-slate-700">Pack Size (Optional)</label>
                        <input type="number" id="packSize" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div id="pharma-fields" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="auditForm" class="block text-sm font-medium text-slate-700">Audit Form <span class="mandatory-star" data-req-for="Pharma">*</span></label>
                            <select id="auditForm" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm"></select>
                        </div>
                        <div>
                            <label for="composition" class="block text-sm font-medium text-slate-700">Composition <span class="mandatory-star" data-req-for="Pharma">*</span></label>
                            <input type="text" id="composition" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                        </div>
                    </div>
                    <div id="other-fields" class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="categoryL1" class="block text-sm font-medium text-slate-700">Category L1 <span class="mandatory-star" data-req-for="FMCG Surgical Device">*</span></label>
                            <select id="categoryL1" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm"></select>
                        </div>
                        <div>
                            <label for="categoryL2" class="block text-sm font-medium text-slate-700">Category L2 <span class="mandatory-star" data-req-for="FMCG Surgical Device">*</span></label>
                            <select id="categoryL2" disabled class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm bg-slate-100"></select>
                        </div>
                        <div>
                            <label for="categoryL3" class="block text-sm font-medium text-slate-700">Category L3 <span class="mandatory-star" data-req-for="FMCG Surgical Device">*</span></label>
                            <select id="categoryL3" disabled class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm bg-slate-100"></select>
                        </div>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition">Create</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="stage-entry-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-5 mx-auto p-6 border-none w-full max-w-3xl shadow-xl rounded-xl bg-white">
                 <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 id="stage-entry-modal-title" class="text-xl font-semibold text-slate-800"></h2>
                    <button id="close-stage-entry-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <div id="stage-entry-error-message" class="hidden text-sm text-red-600 bg-red-100 p-3 rounded-lg mb-4"></div>
                <form id="stage-entry-form" class="space-y-4"></form>
                <div class="mt-6 border-t border-slate-200 pt-4 flex justify-end">
                    <button id="save-stage-entry-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition">Add</button>
                </div>
            </div>
        </div>

        <div id="add-product-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-6 border-none w-full max-w-lg shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 class="text-xl font-semibold text-slate-800">Add New Product</h2>
                    <button id="close-add-product-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <form id="add-product-form" class="space-y-4">
                    <div>
                        <label for="productName" class="block text-sm font-medium text-slate-700">Product Name *</label>
                        <input type="text" id="productName" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mt-6 border-t border-slate-200 pt-4 flex justify-end">
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition">Save Product</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="vendor-selection-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-6 border-none w-full max-w-md shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 class="text-xl font-semibold text-slate-800">Select Final Vendor</h2>
                    <button id="close-vendor-selection-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <div id="vendor-selection-list" class="space-y-3 my-4"></div>
                <div class="mt-6 border-t border-slate-200 pt-4 flex justify-end">
                    <button id="proceed-to-final-approval-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition">Next</button>
                </div>
            </div>
        </div>

        <div id="final-approval-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-5 mx-auto p-6 border-none w-full max-w-7xl shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 class="text-xl font-semibold text-slate-800">Final Proposal Review & Approval</h2>
                    <button id="close-final-approval-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <div id="final-approval-content" class="space-y-4 my-4 max-h-[70vh] overflow-y-auto p-2"></div>
                <div class="mt-6 border-t border-slate-200 pt-4 flex justify-end gap-3">
                    <button id="cancel-final-approval-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <!-- MODIFICATION START: Added Reject Selected Button -->
                    <button id="reject-selected-commercials-btn" type="button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-red-700 transition">Reject Selected</button>
                    <!-- MODIFICATION END -->
                    <button id="confirm-final-approval-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-green-700 transition">Confirm Approval</button>
                </div>
            </div>
        </div>
        
        <div id="wip-stage-entry-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-5 mx-auto p-6 border-none w-full max-w-3xl shadow-xl rounded-xl bg-white">
                 <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 id="wip-stage-entry-modal-title" class="text-xl font-semibold text-slate-800"></h2>
                    <button id="close-wip-stage-entry-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <!-- MODIFICATION START: Added error message container -->
                <div id="wip-stage-entry-error-message" class="hidden text-sm text-red-600 bg-red-100 p-3 rounded-lg mb-4"></div>
                <!-- MODIFICATION END -->
                <form id="wip-stage-entry-form" class="grid grid-cols-1 md:grid-cols-2 gap-4"></form>
                <div class="mt-6 border-t border-slate-200 pt-4 flex justify-end">
                    <button id="save-wip-stage-entry-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition">Add</button>
                </div>
            </div>
        </div>

        <!-- Yes/No Selection Modal -->
        <div id="yes-no-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-6 border-none w-full max-w-sm shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 id="yes-no-modal-title" class="text-xl font-semibold text-slate-800"></h2>
                    <button id="close-yes-no-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <form id="yes-no-form">
                    <div>
                        <label for="yesNoSelect" class="block text-sm font-medium text-slate-700">Selection</label>
                        <select id="yesNoSelect" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option>No</option>
                            <option>Yes</option>
                        </select>
                    </div>
                    <div class="mt-6 border-t border-slate-200 pt-4 flex justify-end">
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition">Save</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- GRN MODAL -->
<div id="grn-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center border-b pb-3 mb-4">
      <h2 class="text-xl font-semibold text-slate-800">GRN Details</h2>
      <button id="close-grn-modal" class="text-slate-400 hover:text-slate-800 text-2xl font-bold leading-none">&times;</button>
    </div>

    <form id="grn-form" class="space-y-4">
      <div>
        <label for="optivalGrnId" class="block text-sm font-medium text-slate-700">Optival GRN ID</label>
        <input type="text" id="optivalGrnId" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
      </div>

      <div>
        <label for="grnDate" class="block text-sm font-medium text-slate-700">GRN Date</label>
        <input type="date" id="grnDate" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
      </div>

            <div>
                <label for="grnQuantity" class="block text-sm font-medium text-slate-700">GRN Quantity</label>
                <input type="number" id="grnQuantity" min="0" step="1" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
            </div>

      <div class="flex justify-end pt-4 border-t mt-4">
        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Save</button>
      </div>
    </form>
  </div>
</div>

        <!-- Generic Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            
            <div class="relative top-20 mx-auto p-6 border-none w-full max-w-6xl shadow-xl rounded-xl bg-white">
            
                <h2 id="confirmation-modal-title" class="text-xl font-semibold text-slate-800 mb-4">Confirm Action</h2>
                <p id="confirmation-modal-text" class="text-slate-600 mb-6"></p>
                <!-- MODIFICATION START: Added a details container -->
                <div id="confirmation-modal-details" class="text-sm text-slate-700 bg-slate-50 p-3 rounded-lg my-4 border border-slate-200 hidden"></div>
                <!-- MODIFICATION END -->
                <div class="mt-6 flex justify-end gap-3">
                    <button id="confirmation-modal-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <button id="confirmation-modal-confirm-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-red-700 transition">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Transfer Ownership Modal -->
        <div id="transfer-owner-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-6 border-none w-full max-w-lg shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 class="text-xl font-semibold text-slate-800">Transfer Ownership</h2>
                    <button id="close-transfer-owner-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <form id="transfer-owner-form">
                    <div>
                        <label for="newOwnerSearch" class="block text-sm font-medium text-slate-700">Search by Emp ID or Name *</label>
                        <div class="relative">
                            <input type="search" id="newOwnerSearch" autocomplete="off" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <div id="owner-search-results" class="absolute z-20 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-40 overflow-y-auto hidden shadow-lg"></div>
                        </div>
                        <input type="hidden" id="newOwnerName">
                    </div>
                    <div class="mt-6 border-t border-slate-200 pt-4 flex justify-end">
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition">Transfer</button>
                    </div>
                </form>
            </div>
        </div>

         <!-- MODIFICATION START: Added Product Selection Modal -->
        <div id="product-selection-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-6 border-none w-full max-w-lg shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 id="product-selection-modal-title" class="text-xl font-semibold text-slate-800">Select Products to Transfer</h2>
                    <button id="close-product-selection-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <form id="product-selection-form">
                    <div class="mb-4 p-3 bg-slate-50 border border-slate-200 rounded-lg">
                        <label class="flex items-center space-x-2 font-medium">
                            <input type="checkbox" id="select-all-products" class="h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500">
                            <span>Select All Products</span>
                        </label>
                    </div>
                    <div id="product-selection-list" class="space-y-3 my-4 max-h-60 overflow-y-auto">
                        <!-- Product list will be injected here -->
                    </div>
                    <div class="mt-6 border-t border-slate-200 pt-4 flex justify-end gap-3">
                        <button id="cancel-product-selection-btn" type="button" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                        <button id="product-selection-next-btn" type="button" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition">Next</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- MODIFICATION END -->

         <!-- Vendor Details Modal -->
        <div id="vendor-details-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-5 mx-auto p-6 border-none w-full max-w-3xl shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 id="vendor-details-modal-title" class="text-xl font-semibold text-slate-800">Vendor Details</h2>
                    <button id="close-vendor-details-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <div id="vendor-details-content" class="space-y-4 my-4 max-h-[80vh] overflow-y-auto p-2">
                    <!-- Content will be injected by JS -->
                </div>
            </div>
        </div>
        
        <!-- Proposal List by Status Modal -->
        <div id="proposal-list-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-6 border-none w-full max-w-5xl shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 id="proposal-list-modal-title" class="text-xl font-semibold text-slate-800">Proposals</h2>
                    <button id="close-proposal-list-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <div id="proposal-list-content" class="max-h-[60vh] overflow-y-auto"></div>
            </div>
        </div>

        <!-- Edit Product Name Modal -->
        <div id="edit-product-name-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-6 border-none w-full max-w-lg shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 class="text-xl font-semibold text-slate-800">Edit Product Name</h2>
                    <button id="close-edit-product-name-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <form id="edit-product-name-form" class="space-y-4">
                    <div>
                        <label for="editProductNameInput" class="block text-sm font-medium text-slate-700">Product Name *</label>
                        <input type="text" id="editProductNameInput" required class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mt-6 border-t border-slate-200 pt-4 flex justify-end">
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-7D0 transition">Save Name</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pending Variants Approval Modal -->
        <div id="pending-variants-approval-modal" class="fixed inset-0 modal-backdrop overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-5 mx-auto p-6 border-none w-full max-w-7xl shadow-xl rounded-xl bg-white">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200 mb-4">
                    <h2 class="text-xl font-semibold text-slate-800">Approve Pending Variants</h2>
                    <button id="close-pending-variants-modal-btn" class="text-slate-400 hover:text-slate-800 text-3xl font-bold leading-none -mt-2">&times;</button>
                </div>
                <div id="pending-variants-approval-content" class="space-y-4 my-4 max-h-[70vh] overflow-y-auto p-2">
                    <!-- Table will be injected here -->
                </div>
                <div class="mt-6 border-t border-slate-200 pt-4 flex justify-end gap-3">
                    <button id="cancel-pending-variants-approval-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <!-- MODIFICATION START: Added Reject Selected Button -->
                    <button id="reject-selected-pending-variants-btn" type="button" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-red-700 transition">Reject Selected</button>
                    <!-- MODIFICATION END -->
                    <button id="confirm-pending-variants-approval-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-green-700 transition">Approve Selected</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- VALIDATION HELPER FUNCTIONS ---
    const isValidPhoneNumber = (phone) => {
        // Indian phone number validation: 10 digits, can start with +91 or 0
        // Also accepts international format like +44, +1, etc.
        const phoneRegex = /^(\+\d{1,3}[-.]?)?\d{10}$/;
        const cleanPhone = phone.replace(/[\s\-().]/g, ''); // Remove common separators
        return phoneRegex.test(cleanPhone);
    };

    const isValidEmail = (email) => {
        // Standard email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email.trim());
    };

    // --- MOCK DATA & CONFIG ---
    let isManagerView = false;
    let currentProposalId = null;
    let currentWipId = null;
    let currentCommercialId = null;
    let currentStage = null;
    let currentEntryId = null;
    let confirmationAction = null;
    let isWipExpanded = false; // <-- New state for summary view
    let productsToTransfer = []; // <-- MODIFICATION: Added global variable
    let isBulkTransferMode = false; // When true, show checkboxes in product tables for bulk transfer
    let contextIsFromApprovedTab = false; // To track context for back button
    let currentWipDetailBackView = 'proposalTasks'; // <-- ADDED: To store back-button context
    let editProductNameContext = null; // <-- ADDED: To store context for product name edit
    let currentUser = { id: 'EMP001', name: 'Alice' }; // Assuming Alice is the logged-in employee

    
    const PRICING_FIELDS_CONFIG = [
        { key: 'productCost', label: 'Product Cost' },
        { key: 'logisticsCost', label: 'Logistics Cost' },
        { key: 'totalLandedCost', label: 'Total Landed Cost' },
        { key: 'tentativeMRP', label: 'Tentative MRP' },
        { key: 'probableSP', label: 'Probable SP' },
        { key: 'employeeIncentivePercentage', label: 'Employee Incentive %' },
        { key: 'margin', label: 'Margin' },
        { key: 'marginPercentage', label: 'Margin %' },
        { key: 'gstPercentage', label: 'GST %' },
        { key: 'moq', label: 'MOQ' },
        { key: 'expectedTotalInvestment', label: 'Expected Total Investment' },
        { key: 'upload', label: 'Uploaded File' }
    ];
    

    const indianStatesAndUTs = [ "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", "Delhi", "Jammu and Kashmir", "Ladakh", "Lakshadweep", "Puducherry" ];
    const countries = ["Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria", "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan", "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia", "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo, Democratic Republic of the", "Congo, Republic of the", "Costa Rica", "Cote d'Ivoire", "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt", "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon", "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana", "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel", "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Kosovo", "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania", "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius", "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar (Burma)", "Namibia", "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Korea", "North Macedonia", "Norway", "Oman", "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal", "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe", "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia", "South Africa", "South Korea", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan", "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan", "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"];
    const dummyEmployees = [ { id: 'EMP001', name: 'Alice' }, { id: 'EMP002', name: 'Bob' }, { id: 'EMP003', name: 'Charlie' }, { id: 'EMP004', name: 'David' }, { id: 'EMP005', name: 'Eve F.' }, { id: 'EMP006', name: 'Frank G.' }, ];
    // Dummy products used for PO selection/search
    const dummyProducts = [
        { id: 'PARA-500-T', name: 'Paracetamol 500mg' },
        { id: 'PARA-650-T', name: 'Paracetamol 650mg' },
        { id: 'JUICE-1L-APL', name: 'Apple Juice 1L Tetra Pack' },
        { id: 'BAND-001', name: 'Waterproof Adhesive Bandages' },
        { id: 'GEL-250', name: 'Aloe Vera Gel 250ml' }
    ];
    const categoryData = { 'Health & Nutrition': { 'Supplements': ['Vitamins', 'Proteins'], 'Health Foods': ['Organic', 'Gluten-Free'] }, 'Household Needs': { 'Cleaning': ['Floor', 'Kitchen'], 'Disposables': ['Tissues', 'Plates'] }, 'Baby Needs': { 'Diapers': ['Newborn', 'Toddler'], 'Food': ['Formula', 'Cereals'] }, 'OTC and Health Needs': { 'Pain Relief': ['Headache', 'Body Pain'], 'First Aid': ['Bandages', 'Antiseptics'] }, 'Snack Foods': { 'Chips': ['Potato', 'Corn'], 'Cookies': ['Chocolate', 'Oatmeal'] }, 'Jam Honey & Spreads': { 'Jams': ['Fruit', 'Mixed'], 'Honey': ['Natural', 'Flavored'] }, 'Beverage': { 'Juices': ['Apple', 'Orange'], 'Tea': ['Green', 'Black'] }, 'Personal Care': { 'Skin Care': ['Moisturizers', 'Sunscreens'], 'Hair Care': ['Shampoo', 'Conditioner'] } };

    // --- INITIAL DATA ---
    let proposals = [
        // --- Approved Proposals (now in FY 2025-26) ---
        {
            id: 'P2025-001',
            productType: 'Pharma', packSize: '100', auditForm: 'Tablets', composition: 'Paracetamol 500mg', description: 'Standard 500mg Paracetamol tablets for fever and pain relief.',
            createdDate: '15-05-2025', approvedDate: '01-06-2025', isApproved: true, approvedBy: 'Manager', finalizedVendorId: 1, owner: 'Alice', createdBy: 'Alice',
            approvedCommercialIds: [3, 16], // <-- MODIFIED THIS LINE
            vendorIdentification: { status: 'Completed', data: [
                { id: 1, vendorName: 'Global Pharma', vendorType: 'Domestic', vendorState: 'Maharashtra', pocs: [{pocName: 'John Doe', pocMobileNo: '1234567890', email: 'john@global.com', pocRole: 'Sales Head'}], categoryCompositionExpertise: 'Tablet formulations', keyPartnersBrands: 'Cipla, Sun Pharma', gstNo: 'GSTIN123', plantVisit: '20-05-2025', remarks: 'Initial contact positive.', status: 'Completed' },
                { id: 2, vendorName: 'Wellness Labs', vendorType: 'Domestic', vendorState: 'Gujarat', pocs: [{pocName: 'Jane Smith', pocMobileNo: '0987654321', email: 'jane@wellness.com', pocRole: 'Key Account Manager'}], categoryCompositionExpertise: 'APIs', keyPartnersBrands: 'Dr. Reddy\'s', gstNo: 'GSTIN456', plantVisit: '22-05-2025', remarks: 'Good facility.', status: 'Completed' }
            ]},
            sample: { status: 'Completed', data: [{ id: 1, vendorId: 1, vendorName: 'Global Pharma', sampleName: 'Paracetamol Batch A', receivedDate: '25-05-2025', labTesting: 'Tested & Passed', testedOn: 50, avgRating: 4.5, remarks: 'Sample passed all tests.', status: 'Completed' }]},
            commercials: { status: 'Completed', data: [
                { id: 3, vendorId: 1, sampleId: 1, productVariant: '500mg', vendorName: 'Global Pharma', productCost: '0.05', moq: '100000', logisticsCost: '0.01', totalLandedCost: '0.06', employeeIncentivePercentage: 5, probableSP: '0.10', margin: '0.035', marginPercentage: '35.00', tentativeMRP: '0.12', leadTime: '30', advancePercentage: 0, balancePaymentType: 'After Dispatch', creditDays: 60, gstPercentage: 12, expectedTotalInvestment: '6600.00', remarks: 'Final quote', status: 'Completed' },
                { id: 16, vendorId: 1, sampleId: 1, productVariant: '650mg', vendorName: 'Global Pharma', productCost: '0.07', moq: '100000', logisticsCost: '0.01', totalLandedCost: '0.08', employeeIncentivePercentage: 5, probableSP: '0.15', margin: '0.0625', marginPercentage: '41.67', tentativeMRP: '0.18', leadTime: '30', advancePercentage: 0, balancePaymentType: 'After Dispatch', creditDays: 60, gstPercentage: 12, expectedTotalInvestment: '8840.00', remarks: 'Higher dosage variant.', status: 'Completed' }
            ]},
            agreementProposal: { status: 'Pending', data: [] },
        },
        {
            id: 'P2025-002',
            productType: 'FMCG', categoryL1: 'Beverage', categoryL2: 'Juices', categoryL3: 'Apple', description: '1 liter tetra pack of fresh apple juice, no added sugar.',
            createdDate: '18-06-2025', approvedDate: '05-07-2025', isApproved: true, approvedBy: 'Manager', finalizedVendorId: 4, owner: 'Bob', createdBy: 'Bob',
            approvedCommercialIds: [6], // <-- THIS LINE WAS ADDED
            vendorIdentification: { status: 'Completed', data: [{ id: 4, vendorName: 'Fresh Juices Inc.', vendorType: 'Domestic', vendorState: 'Karnataka', pocs: [{pocName: 'Mike Ross', pocMobileNo: '5555555555', email: 'mike@fresh.com', pocRole: 'Sales Director'}], categoryCompositionExpertise: 'Fruit Juices', keyPartnersBrands: 'Tropicana', gstNo: 'GSTIN789', plantVisit: '25-06-2025', remarks: 'Excellent setup.', status: 'Completed' }]},
            sample: { status: 'Completed', data: [{ id: 5, vendorId: 4, vendorName: 'Fresh Juices Inc.', sampleName: 'Apple Juice Lot #123', receivedDate: '28-06-2025', labTesting: 'Tested & Passed', testedOn: 100, avgRating: 4.8, remarks: 'Great taste.', status: 'Completed' }]},
            commercials: { status: 'Completed', data: [{ id: 6, vendorId: 4, sampleId: 5, productVariant: '1L Tetra Pack', vendorName: 'Fresh Juices Inc.', productCost: '0.5', moq: '10000', logisticsCost: '0.02', totalLandedCost: '0.52', employeeIncentivePercentage: 10, probableSP: '1.00', margin: '0.38', marginPercentage: '38.00', tentativeMRP: '1.20', leadTime: '15', advancePercentage: 50, balancePaymentType: 'Before Dispatch', creditDays: null, gstPercentage: 18, expectedTotalInvestment: '6100.00', remarks: '', status: 'Completed' }]},
            agreementProposal: { status: 'Pending', data: [] },
        },

        // --- Current Proposals (Not Approved) ---
        { // Status: PENDING
            id: 'P2025-003',
            productType: 'Surgical', categoryL1: 'Household Needs', categoryL2: 'Disposables', categoryL3: 'Tissues', packSize: '1', description: 'Soft facial tissues, 2-ply.',
            createdDate: '10-10-2025', owner: 'Charlie', createdBy: 'Charlie', isApproved: false,
            vendorIdentification: { status: 'Pending', data: [] },
            sample: { status: 'Pending', data: [] },
            commercials: { status: 'Pending', data: [] },
            agreementProposal: { status: 'Pending', data: [] },
        },
        { // Status: WIP
            id: 'P2025-004',
            productType: 'Device', categoryL1: 'Personal Care', categoryL2: 'Skin Care', categoryL3: 'Sunscreens', packSize: '10', description: 'SPF 50+ Sunscreen lotion.',
            createdDate: '12-08-2025', owner: 'Alice', createdBy: 'Alice', isApproved: false,
            vendorIdentification: { status: 'WIP', data: [
                { id: 7, vendorName: 'MedTech Devices', vendorType: 'Domestic', vendorState: 'Telangana', pocs: [{pocName: 'David Chen', pocMobileNo: '1112223333', email: 'david@med.tech', pocRole: 'BDM'}], categoryCompositionExpertise: 'Medical Devices', keyPartnersBrands: 'Philips', gstNo: 'GSTIN101', plantVisit: '20-08-2025', remarks: 'Plant visit done', status: 'Completed' },
                { id: 13, vendorName: 'HealthGadgets', vendorType: 'Domestic', vendorState: 'Karnataka', pocs: [{pocName: 'Grace Hopper', pocMobileNo: '9876543210', email: 'grace@health.io', pocRole: 'CTO'}], categoryCompositionExpertise: 'Health Monitors', keyPartnersBrands: 'Omron', gstNo: 'GSTIN555', plantVisit: '', remarks: 'Initial talks only', status: 'WIP' },
                { id: 15, vendorName: 'Pharma Global AG', vendorType: 'International', vendorCountry: 'Germany', pocs: [{pocName: 'Hans Zimmer', pocMobileNo: '+4912345678', email: 'hans@pharma.de', pocRole: 'EU Sales'}], categoryCompositionExpertise: 'APIs', keyPartnersBrands: 'Bayer', gstNo: 'GSTIN444', plantVisit: '', remarks: 'Initial contact via email', status: 'WIP' }
            ]},
            sample: { status: 'Pending', data: [] },
            commercials: { status: 'Pending', data: [] },
            agreementProposal: { status: 'Pending', data: [] },
        },
        { // Status: Approval Pending
            id: 'P2025-005',
            productType: 'Pharma', packSize: '50', auditForm: 'Ointments', composition: 'Betamethasone 0.1%', description: 'Topical steroid ointment for skin conditions.',
            createdDate: '15-07-2025', owner: 'Bob', createdBy: 'Bob', isApproved: false,
            vendorIdentification: { status: 'Completed', data: [{ id: 8, vendorName: 'Derma Solutions', vendorType: 'Domestic', vendorState: 'Himachal Pradesh', pocs: [{pocName: 'Eva Green', pocMobileNo: '4445556666', email: 'eva@derma.com', pocRole: 'Manager'}], categoryCompositionExpertise: 'Dermatology', keyPartnersBrands: 'Glenmark', gstNo: 'GSTIN202', plantVisit: '22-07-2025', remarks: 'Facility approved', status: 'Completed' }]},
            sample: { status: 'Completed', data: [{ id: 9, vendorId: 8, vendorName: 'Derma Solutions', sampleName: 'Beta Ointment v2', receivedDate: '26-07-2025', labTesting: 'Tested & Passed', testedOn: 30, avgRating: 4.2, remarks: 'Effective formula', status: 'Completed' }]},
            commercials: { status: 'Completed', data: [{ id: 10, vendorId: 8, sampleId: 9, productVariant: '50g Tube', vendorName: 'Derma Solutions', productCost: '1.2', moq: '5000', logisticsCost: '0.03', totalLandedCost: '1.23', employeeIncentivePercentage: 8, probableSP: '2.50', margin: '1.07', marginPercentage: '42.80', tentativeMRP: '3.00', leadTime: '45', advancePercentage: 20, balancePaymentType: 'After Dispatch', creditDays: 45, gstPercentage: 5, expectedTotalInvestment: '6450.00', remarks: '', status: 'Completed' }]},
            agreementProposal: { status: 'Pending', data: [] },
        },
        { // Status: REJECTED
            id: 'P2025-006',
            productType: 'FMCG', packSize: '250', categoryL1: 'Snack Foods', categoryL2: 'Chips', categoryL3: 'Potato', description: 'Classic salted potato chips.',
            createdDate: '20-08-2025', owner: 'Charlie', createdBy: 'Charlie', isApproved: false, isRejected: true,
            rejectedDate: '05-10-2025', rejectedBy: 'Manager',
            vendorIdentification: { status: 'Completed', data: []},
            sample: { status: 'Completed', data: [] },
            commercials: { status: 'WIP', data: [] },
            agreementProposal: { status: 'Pending', data: [] },
        },
        { // Status: WITHDRAWN
            id: 'P2025-007',
            productType: 'Pharma', packSize: '30', auditForm: 'Inhalers', composition: 'Salbutamol', description: 'Asthma relief inhaler.',
            createdDate: '22-09-2025', owner: 'Alice', createdBy: 'Alice', isApproved: false, isWithdrawn: true,
            withdrawnDate: '30-09-2025', withdrawnBy: 'Manager',
            vendorIdentification: { status: 'Pending', data: [] },
            sample: { status: 'Pending', data: [] },
            commercials: { status: 'Pending', data: [] },
            agreementProposal: { status: 'Pending', data: [] },
        },
        { // Status: WIP (Sample stage started)
            id: 'P2025-008',
            productType: 'Device', packSize: '1', categoryL1: 'OTC and Health Needs', categoryL2: 'First Aid', categoryL3: 'Bandages', description: 'Waterproof adhesive bandages, assorted sizes.',
            createdDate: '25-07-2025', owner: 'David', createdBy: 'David', isApproved: false,
            vendorIdentification: { status: 'Completed', data: [
                { id: 11, vendorName: 'SecureStrips Co.', vendorType: 'Domestic', vendorState: 'Delhi', pocs: [{pocName: 'Frank Miller', pocMobileNo: '7778889999', email: 'frank@secure.com', pocRole: 'Owner'}], categoryCompositionExpertise: 'Adhesives', keyPartnersBrands: 'Hansaplast', gstNo: 'GSTIN303', plantVisit: '01-08-2025', remarks: 'First choice vendor', status: 'Completed' },
                { id: 12, vendorName: 'MediPlast', vendorType: 'Domestic', vendorState: 'Maharashtra', pocs: [{pocName: 'Grace Lee', pocMobileNo: '8889990000', email: 'grace@mediplast.com', pocRole: 'Director'}], categoryCompositionExpertise: 'Plasters', keyPartnersBrands: 'Johnson & Johnson', gstNo: 'GSTIN404', plantVisit: '05-08-2025', remarks: 'Backup vendor', status: 'Completed' }
            ]},
            sample: { status: 'WIP', data: [ { id: 14, vendorId: 11, vendorName: 'SecureStrips Co.', sampleName: 'Waterproof Strips - Initial', receivedDate: '15-08-2025', labTesting: 'Not Tested', testedOn: 0, avgRating: 0, remarks: 'Sample received, testing started.', status: 'WIP' } ] },
            commercials: { status: 'Pending', data: [] },
            agreementProposal: { status: 'Pending', data: [] },
        },
    ];
    let wipTasks = [
        { // Status: LAUNCHED (all stages complete)
            id: 'WIP-001',
            proposalId: 'P2025-001',
            commercialId: 3, // <-- ***** ADD THIS *****
            productId: 'PARA-500-T', productName: 'Standard 500mg Paracetamol tablets for fever and pain relief.-500mg', vendorName: 'Global Pharma', vendorId: 1, owner: 'Alice', createdBy: 'Alice',
            createdDate: '02-06-2025', isCancelled: false,
            stages: {
                agreement: { data: [{id: 1, upload: 'agreement_final_v1.pdf', status: 'Completed'}] },
                artWork: { data: [{id: 2, upload: 'product_artwork_v2.ai', status: 'Completed'}] },
                pricing: { data: [{id: 3, productCost: '0.05', logisticsCost: '0.01', totalLandedCost: '0.06', tentativeMRP: '0.12', probableSP: '0.10', employeeIncentivePercentage: '5', margin: '0.035', marginPercentage: '35.00', gstPercentage: '12', moq: '100000', expectedTotalInvestment: '6600.00', upload: 'pricing_sheet.xlsx', status: 'Completed' }] },
                branding: { data: [{id: 5, brandName: 'ParaRelief', brandingApproved: 'Yes', status: 'Completed', remarks: 'Finalized brand name.'}]},
                vendorKYC: { data: [{id: 6, vendorName: 'Global Pharma', gstNumber: 'GSTIN123', accountDetails: 'ACC123456', complianceCertificates: 'ISO9001.pdf', address: '123 Pharma Lane', poc: 'John Doe', pocContactNo: '1234567890', email: 'john@global.com', uploadedDocuments: 'all_kyc_docs.zip', status: 'Completed', verificationDate: '30-05-2025', remarks: ''}]},
                poReleased: { data: [{id: 7, productId: 'PARA-500-T',poId: '1', deliveryDate: '15-09-2025', tentativeLaunchDate: '01-10-2025', unitsOrdered: 50000, upload: 'PO-2025-001.pdf', status: 'Yes'}] },
                productionStarted: { data: [{ id: 1, value: 'Yes' }] },
                rawMaterialsProcured: { data: [{ id: 2, value: 'Yes' }] },
                packingMaterialProcured: { data: [{ id: 3, value: 'Yes' }] },
                grn: { data: [] }
            }
        },
        { // Status: WIP
            id: 'WIP-002',
            proposalId: 'P2025-002',
            commercialId: 6, // <-- ***** ADD THIS *****
            productId: '', productName: '1 liter tetra pack of fresh apple juice, no added sugar.-1L Tetra Pack', vendorName: 'Fresh Juices Inc.', vendorId: 4, owner: 'Bob', createdBy: 'Bob',
            createdDate: '06-07-2025', isCancelled: false,
            stages: {
                agreement: { data: [{id: 8, upload: 'juice_agreement.pdf', status: 'Completed'}] },
                artWork: { data: [{id: 9, upload: 'apple_juice_label.ai', status: 'Completed'}] }, // WIP
                pricing: { data: [] }, // Pending
                branding: { data: [] }, // Pending
                vendorKYC: { data: [{id: 10, vendorName: 'Fresh Juices Inc.', gstNumber: 'GSTIN789', status: 'Completed'}] },
                poReleased: { data: [] },
                productionStarted: { data: [] },
                rawMaterialsProcured: { data: [] },
                packingMaterialProcured: { data: [] },
                grn: { data: [] }
            }
        },
        { // Status: Project Approved
            id: 'WIP-005',
            proposalId: 'P2025-001',
            commercialId: 16, // <-- ***** ADD THIS *****
            productId: '', productName: 'Standard 500mg Paracetamol tablets for fever and pain relief.-650mg', vendorName: 'Global Pharma', vendorId: 1, owner: 'Alice', createdBy: 'Alice',
            createdDate: '08-07-2025', isCancelled: false,
            stages: {
                agreement: { data: [] }, artWork: { data: [] }, pricing: { data: [] }, branding: { data: [] }, vendorKYC: { data: [] },
                poReleased: { data: [] }, productionStarted: { data: [] }, rawMaterialsProcured: { data: [] }, packingMaterialProcured: { data: [] }, grn: { data: [] }
            }
        },
    ];

    // --- DOM ELEMENTS ---
    // These are now initialized inside DOMContentLoaded
    let roleSelector, tabs, views;
    let mainSidebar, sidebarOverlay; // <-- Declare globally

    // --- UTILITY FUNCTIONS ---
    const showView = (viewName) => { 
        // Auto-cancel bulk transfer mode when leaving newProductsList view
        if (viewName !== 'newProductsList' && isBulkTransferMode) {
            cancelBulkTransferMode();
        }
        Object.values(views).forEach(view => view.classList.remove('view-active')); 
        if (views[viewName]) views[viewName].classList.add('view-active'); 
    };
    const getStatusClass = (status) => { const statusMap = { 'Pending': 'status-pending', 'No': 'status-pending', 'WIP': 'status-wip', 'Partially Completed': 'status-wip', 'Approval Pending': 'status-approval-pending', 'Approved': 'status-approved', 'Yes': 'status-completed', 'Rejected': 'status-rejected', 'Withdrawn': 'status-withdrawn', 'Project Approved': 'status-approved', 'Launched': 'status-launched', 'Cancelled': 'status-cancelled', 'Completed': 'status-completed', }; return statusMap[status] || 'bg-slate-200 text-slate-800'; };
 
    <!-- --- MODIFICATION START: Updated status display logic --- -->
    const mapStageStatusForDisplay = (status) => { 
        if (status === 'WIP') return 'Partially Completed';
        return status; 
    };
    

    const calculateOverallStageStatus = (stageData) => { if (!stageData || stageData.length === 0) return 'Pending'; const allCompleted = stageData.every(entry => entry.status === 'Completed'); if (allCompleted) return 'Completed'; const anyProgress = stageData.some(entry => entry.status === 'WIP' || entry.status === 'Completed'); if (anyProgress) return 'WIP'; return 'Pending'; };
    const calculateProposalStatus = (p) => { if (p.isWithdrawn) return 'Withdrawn'; if (p.isRejected) return 'Rejected'; if (p.isApproved) return 'Approved'; const requiredStages = [p.vendorIdentification, p.sample, p.commercials, p.agreementProposal]; p.vendorIdentification.status = calculateOverallStageStatus(p.vendorIdentification.data); p.sample.status = calculateOverallStageStatus(p.sample.data); p.commercials.status = calculateOverallStageStatus(p.commercials.data); p.agreementProposal.status = calculateOverallStageStatus(p.agreementProposal.data); 
        
        // --- BUG FIX START ---
        // (Previous override logic removed)
        // --- BUG FIX END ---
        
        const hasApprovableVariant = p.commercials.data.some(comm => {
            if (comm.status !== 'Completed') return false;
            // --- MODIFICATION START: Exclude rejected commercials ---
            if (p.rejectedCommercialIds && p.rejectedCommercialIds.includes(comm.id)) return false;
            // --- MODIFICATION END ---
            const sample = p.sample.data.find(s => s.id == comm.sampleId && s.status === 'Completed');
            if (!sample) return false;
            const vendor = p.vendorIdentification.data.find(v => v.id == sample.vendorId && v.status === 'Completed');
            return !!vendor;
        });

        if (hasApprovableVariant) return 'Approval Pending';
        
        const allStagesPending = requiredStages.every(stage => stage.status === 'Pending'); if (allStagesPending) return 'Pending'; return 'WIP'; };
    const getWipEntryStatus = (entry) => {
        if (entry.hasOwnProperty('value')) return entry.value; // Returns 'Yes' or 'No'
        return entry.status || 'Pending';
    };
    
    const calculateWipStageOverallStatus = (stage, key) => {
        if (!stage || !stage.data || stage.data.length === 0) {
             // --- MODIFICATION START ---
            // If pricing stage is empty, it's considered "Completed" by default
            // as it pulls data from the approved proposal commercials.
            if (key === 'pricing') {
                return 'Completed';
            }
            // --- MODIFICATION END ---
            return 'Pending';
        }
        
        // Pricing has its own internal status
        if (key === 'pricing') {
             // --- MODIFICATION START ---
            // If data exists, check its status.
            // If no data, it's 'Completed' (handled above).
            if (!stage || !stage.data || stage.data.length === 0) {
                return 'Completed';
            }
            // --- MODIFICATION END ---
            
            if (stage.data.length > 0) {
                const entryStatus = stage.data[0].status;
                // No longer checking for 'Approval Pending' here, as the flag handles it.
                if (entryStatus === 'Completed') return 'Completed';
                if (entryStatus === 'WIP') return 'WIP';
            }
             // --- MODIFICATION START ---
            // Fallback for pricing is 'Completed'
            return 'Completed';
            // --- MODIFICATION END ---
        }

        // For all other stages (Agreement, ArtWork, Branding, KYC, and the Yes/No ones)
        const completedStates = ['Completed', 'Yes'];
        if (stage.data.every(d => completedStates.includes(getWipEntryStatus(d)) )) {
            return 'Completed';
        }
        if (stage.data.some(d => getWipEntryStatus(d) !== 'Pending' && getWipEntryStatus(d) !== 'No')) {
            return 'WIP';
        }
        return 'Pending';
    };

    const calculateWipStatus = (task) => {
        if (task.isCancelled) return 'Withdrawn';

        // 1. Check for pricing approval flag
        if (task.stages.pricing?.needsManagerApproval) {
            return 'Approval Pending';
        }

        // 2. Check for Launched status based on required stages
        const requiredStagesForLaunch = [
            'agreement',
            // 'artWork', // <-- REMOVED
            // 'pricing', // <-- REMOVED
            // 'branding', // <-- REMOVED
            // 'vendorKYC', // <-- REMOVED
            'poReleased',
            // 'rawMaterialsProcured', // <-- REMOVED BY USER REQUEST
            // 'packingMaterialProcured', // <-- REMOVED BY USER REQUEST
            // 'productionStarted', // <-- REMOVED BY USER REQUEST
            'grn'
        ];

        let allRequiredStagesComplete = true;
        for (const key of requiredStagesForLaunch) {
            const status = calculateWipStageOverallStatus(task.stages[key], key);
            
            // All stages must be 'Completed' (which includes 'Yes' for PO, GRN, and Yes/No stages)
            if (status !== 'Completed') {
                allRequiredStagesComplete = false;
                break;
            }
        }

        if (allRequiredStagesComplete) {
            return 'Launched';
        }

        // 3. If not Withdrawn, Approval Pending, or Launched, it's WIP.
        return 'WIP';
    };
    
    
   const formatDateToDDMMYYYY = (dateString) => { if (!dateString) return ''; if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) return dateString; const parts = dateString.split('-'); if (parts.length !== 3) return dateString; const [year, month, day] = parts; return `${day}-${month}-${year}`; };
    const formatDateToYYYYMMDD = (dateString) => { if (!dateString) return ''; if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString; const parts = dateString.split('-'); if (parts.length !== 3) return dateString; const [day, month, year] = parts; return `${year}-${month}-${day}`; };
    const parseDateForSorting = (dateString) => { 
        if (!dateString || typeof dateString !== 'string') return new Date(0);
        const parts = dateString.split('-');
        if (parts.length !== 3) return new Date(0);
        const [day, month, year] = parts;
        return new Date(`${year}-${month}-${day}`);
    };

    // --- NEW FUNCTIONS (moved to global scope) ---
    const openSidebar = () => {
        if (mainSidebar && sidebarOverlay) {
            sidebarOverlay.classList.remove('hidden');
            setTimeout(() => sidebarOverlay.classList.add('opacity-100'), 10); // For transition
            mainSidebar.classList.remove('-translate-x-full');
        }
    };

    const closeSidebar = () => {
        if (mainSidebar && sidebarOverlay) {
            mainSidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.remove('opacity-100');
            setTimeout(() => sidebarOverlay.classList.add('hidden'), 300); // Wait for transition
        }
    };
    // --- END NEW FUNCTIONS ---

    // --- MODIFICATION START: Added new function ---
    function openBulkProductTransferModal() {
        // 1. Get all transferrable tasks (exclude Withdrawn and Launched)
        let transferrableTasks = wipTasks.filter(task => {
            const status = calculateWipStatus(task);
            // Only include WIP and Approval Pending products, exclude Withdrawn and Launched
            return (status === 'WIP' || status === 'Approval Pending');
        });

        // 2. Filter by owner if in Employee view
        if (!isManagerView) {
            transferrableTasks = transferrableTasks.filter(task => task.owner === currentUser.name);
        }

        // 3. Get modal elements
        const listContainer = document.getElementById('product-selection-list');
        const modal = document.getElementById('product-selection-modal');
        const selectAllCheckbox = document.getElementById('select-all-products');
        const modalTitle = document.getElementById('product-selection-modal-title');
        
        // 4. Reset modal state
        selectAllCheckbox.checked = false;
        listContainer.innerHTML = '';
        modalTitle.innerText = 'Select Products to Transfer'; // Set title

        // 5. Populate list
        if (transferrableTasks.length === 0) {
            listContainer.innerHTML = `<p class="text-sm text-slate-500 text-center py-4">You have no WIP products to transfer.</p>`;
        } else {
            transferrableTasks.forEach(task => {
                listContainer.innerHTML += `
                    <label class="flex items-center space-x-3 p-3 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">
                        <input type="checkbox" name="selectedProduct" value="${task.id}" class="product-transfer-checkbox h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500">
                        <span class="text-sm font-medium text-slate-800">${task.productName} (Owner: ${task.owner})</span>
                    </label>
                `;
            });
        }
        
        // --- FIX START ---
        // Add listener for "Select All"
        selectAllCheckbox.onchange = (e) => {
            modal.querySelectorAll('.product-transfer-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        };
        
        // Check "Select All" if all individuals are checked
        const allCheckboxes = modal.querySelectorAll('.product-transfer-checkbox');
        allCheckboxes.forEach(checkbox => {
            checkbox.onchange = () => {
                const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
            };
        });
        // --- FIX END ---

        // 6. (Re)-attach checkbox logic (already done in DOMContentLoaded, but good to ensure it's fresh)
        // Note: The logic for 'Select All' and 'Next' button is already in DOMContentLoaded and should work.
        // We just need to make sure we clear any stale proposal/WIP IDs.
        currentProposalId = null;
        currentWipId = null;

        // 7. Show the modal
        modal.classList.remove('hidden');
    }
    // --- MODIFICATION END ---

    // --- NEW: Bulk transfer UI flow functions ---
    function startBulkTransferMode() {
        // Activate bulk-transfer mode: show checkboxes in tables and replace header button with Next/Cancel
        isBulkTransferMode = true;
        productsToTransfer = [];
        const bulkBtn = document.getElementById('btn-transfer-wip-owner-bulk');
        if (bulkBtn) bulkBtn.classList.add('hidden');

        // Create control container if not present
        let controls = document.getElementById('bulk-transfer-controls');
        if (!controls) {
            controls = document.createElement('div');
            controls.id = 'bulk-transfer-controls';
            controls.className = 'inline-flex items-center gap-2';
            bulkBtn.parentNode.appendChild(controls);
        }
        controls.innerHTML = '';

        const nextBtn = document.createElement('button');
        nextBtn.id = 'bulk-transfer-next-btn';
        nextBtn.type = 'button';
        nextBtn.className = 'inline-flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-all duration-200 hover:shadow-md';
        nextBtn.innerText = 'Next';
        nextBtn.addEventListener('click', proceedBulkTransferNext);

        const cancelBtn = document.createElement('button');
        cancelBtn.id = 'bulk-transfer-cancel-btn';
        cancelBtn.type = 'button';
        cancelBtn.className = 'inline-flex items-center gap-2 bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-all duration-200 hover:shadow-md';
        cancelBtn.innerText = 'Cancel';
        cancelBtn.addEventListener('click', cancelBulkTransferMode);

        controls.appendChild(nextBtn);
        controls.appendChild(cancelBtn);

        // Re-render product lists to show checkboxes
        renderNewProductsList();
    }

    function cancelBulkTransferMode(keepHidden) {
        // keepHidden may be an Event object when used as an event handler
        const keepHiddenFlag = (typeof keepHidden === 'boolean') ? keepHidden : false;
        isBulkTransferMode = false;
        productsToTransfer = [];
        const bulkBtn = document.getElementById('btn-transfer-wip-owner-bulk');
        if (bulkBtn) {
            if (!keepHiddenFlag) bulkBtn.classList.remove('hidden');
            else bulkBtn.classList.add('hidden');
        }
        const controls = document.getElementById('bulk-transfer-controls');
        if (controls) controls.remove();
        renderNewProductsList();
    }

    function proceedBulkTransferNext() {
        // Collect selected products from checkboxes in the tables
        const selected = Array.from(document.querySelectorAll('.bulk-transfer-checkbox:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            alert('Please select at least one product to transfer.');
            return;
        }
        productsToTransfer = selected;

        // Hide the bulk controls
        const controls = document.getElementById('bulk-transfer-controls');
        if (controls) controls.remove();
        const bulkBtn = document.getElementById('btn-transfer-wip-owner-bulk');
        if (bulkBtn) bulkBtn.classList.remove('hidden');
        isBulkTransferMode = false; // hide checkboxes while modal is open
        renderNewProductsList();

        // Open the transfer owner modal to pick recipient
        currentWipId = null; // indicate bulk context
        document.getElementById('newOwnerSearch').value = '';
        document.getElementById('newOwnerName').value = '';
        document.getElementById('owner-search-results').innerHTML = '';
        document.getElementById('owner-search-results').classList.add('hidden');
        document.getElementById('transfer-owner-modal').classList.remove('hidden');
    }


    // --- RENDER FUNCTIONS ---
    const renderProposalsTable = () => {
        const fyEl = document.getElementById('filter-proposal-fy');
        const selectedFYs = fyEl ? Array.from(fyEl.selectedOptions).map(o => o.value).filter(v => v) : [];
        const includeAllFy = selectedFYs.length === 0;
        const getFyFromDateStr = (dateStr) => {
            const d = parseDateForSorting(dateStr);
            const y = d.getFullYear(); const m = d.getMonth();
            return (m >= 3) ? `${y}-${y+1}` : `${y-1}-${y}`;
        };
        // Column level filters
        const colTypeEl = document.getElementById('col-filter-productType');
        const colDescEl = document.getElementById('col-filter-description');
        const colStatusEl = document.getElementById('col-filter-status');
        const colOwnerEl = document.getElementById('col-filter-owner');
        const colCreatedOnEl = document.getElementById('col-filter-createdOn');
        const colCreatedByEl = document.getElementById('col-filter-createdBy');

        const colType = colTypeEl ? colTypeEl.value : '';
        const colDesc = colDescEl ? colDescEl.value.trim().toLowerCase() : '';
        const colStatus = colStatusEl ? colStatusEl.value : '';
        const colOwner = colOwnerEl ? colOwnerEl.value.trim().toLowerCase() : '';
        const colCreatedOn = colCreatedOnEl ? colCreatedOnEl.value : '';
        const colCreatedBy = colCreatedByEl ? colCreatedByEl.value.trim().toLowerCase() : '';
        
        const tbody = document.getElementById('proposals-table-body');
        tbody.innerHTML = '';
        
        let filteredProposals = proposals.filter(p => !p.isApproved && !p.isRejected && !p.isWithdrawn);

        if (!isManagerView) {
            filteredProposals = filteredProposals.filter(p => p.owner === currentUser.name);
        }

        if (!includeAllFy) {
            filteredProposals = filteredProposals.filter(p => selectedFYs.includes(getFyFromDateStr(p.createdDate)));
        }

        // Apply column filters (all combined as AND)
        if (colType) {
            filteredProposals = filteredProposals.filter(p => p.productType === colType);
        }

        if (colDesc) {
            filteredProposals = filteredProposals.filter(p => ((p.description || '') + '').toLowerCase().includes(colDesc));
        }

        if (colStatus) {
            filteredProposals = filteredProposals.filter(p => calculateProposalStatus(p) === colStatus);
        }

        if (colOwner) {
            filteredProposals = filteredProposals.filter(p => ((p.owner || '') + '').toLowerCase().includes(colOwner));
        }

        // Date filter removed - date column filtering disabled

        if (colCreatedBy) {
            filteredProposals = filteredProposals.filter(p => ((p.createdBy || '') + '').toLowerCase().includes(colCreatedBy));
        }
        
        filteredProposals.sort((a, b) => parseDateForSorting(b.createdDate) - parseDateForSorting(a.createdDate));
        
        if (filteredProposals.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-slate-500">No proposals match the current filters.</td></tr>`;
            return;
        }

        filteredProposals.forEach(p => {
            const status = calculateProposalStatus(p);

            // Compute approvable/pending commercials for this proposal
            const allCommercials = (p.commercials && p.commercials.data) || [];
            const approvedIds = p.approvedCommercialIds || [];
            const approvableCommercials = allCommercials.filter(comm => {
                // only commercials marked completed are approvable
                if (comm.status !== 'Completed') return false;
                // exclude already-approved ids just in case
                if (approvedIds.includes(comm.id)) return false;
                // exclude rejected commercials
                if (p.rejectedCommercialIds && p.rejectedCommercialIds.includes(comm.id)) return false;
                // sample must exist and be completed
                const sample = (p.sample && p.sample.data) ? p.sample.data.find(s => s.id == comm.sampleId) : null;
                if (!sample || sample.status !== 'Completed') return false;
                // vendor must exist and be completed
                const vendor = (p.vendorIdentification && p.vendorIdentification.data) ? p.vendorIdentification.data.find(v => v.id == sample.vendorId) : null;
                if (!vendor || vendor.status !== 'Completed') return false;
                return true;
            });

            const pendingCount = approvableCommercials.length;

            const row = document.createElement('tr');
            row.className = 'hover:bg-indigo-100/50 cursor-pointer transition-colors duration-150';
            row.dataset.id = p.id;

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${p.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.productType}</td>
                <td class="px-6 py-4 text-sm text-slate-500 whitespace-normal max-w-xs truncate" title="${p.description || ''}">${p.description || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="status-badge ${getStatusClass(status)}">${status}</span></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-semibold text-orange-600">${pendingCount}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.owner}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.createdDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.createdBy}</td>
            `;

            row.addEventListener('click', () => {
                currentProposalId = p.id;
                renderProposalDetail();
                const proposalDetailBackBtn = document.getElementById('proposal-detail-back-btn');
                proposalDetailBackBtn.textContent = ' Back to Proposals';
                proposalDetailBackBtn.onclick = () => {
                    renderProposalsTable();
                    showView('proposals');
                    document.getElementById('inner-tab-current').click(); // ensure inner tab active
                };
                showView('proposalDetail');
            });

            tbody.appendChild(row);
        });
    };
    const renderApprovedProposalsTable = () => {
        const apprFyEl = document.getElementById('filter-approved-fy');
        const selectedApprovedFYs = apprFyEl ? Array.from(apprFyEl.selectedOptions).map(o => o.value).filter(v => v) : [];
        const includeAllApprovedFy = selectedApprovedFYs.length === 0;
        const getFyFromDateStr = (dateStr) => {
            const d = parseDateForSorting(dateStr);
            const y = d.getFullYear(); const m = d.getMonth();
            return (m >= 3) ? `${y}-${y+1}` : `${y-1}-${y}`;
        };
        const colType = (document.getElementById('col-filter-approved-productType') && document.getElementById('col-filter-approved-productType').value) || '';
        const colDesc = (document.getElementById('col-filter-approved-description') && document.getElementById('col-filter-approved-description').value.trim().toLowerCase()) || '';
        const colOwner = (document.getElementById('col-filter-approved-owner') && document.getElementById('col-filter-approved-owner').value.trim().toLowerCase()) || '';
        const colApprovedBy = (document.getElementById('col-filter-approved-approvedBy') && document.getElementById('col-filter-approved-approvedBy').value.trim().toLowerCase()) || '';
        // Date filters removed - colApprovedOn and colCreatedOn no longer used
        const colCreatedBy = (document.getElementById('col-filter-approved-createdBy') && document.getElementById('col-filter-approved-createdBy').value.trim().toLowerCase()) || '';
        const tbody = document.getElementById('approved-proposals-table-body');
        tbody.innerHTML = '';
        
        let approved = proposals.filter(p => p.isApproved);

        if (!isManagerView) {
            approved = approved.filter(p => p.owner === currentUser.name);
        }

        if (!includeAllApprovedFy) {
            approved = approved.filter(p => selectedApprovedFYs.includes(getFyFromDateStr(p.approvedDate)));
        }

        if (colType) {
            approved = approved.filter(p => p.productType === colType);
        }

        if (colDesc) {
            approved = approved.filter(p => ((p.description || '') + '').toLowerCase().includes(colDesc));
        }

        if (colOwner) {
            approved = approved.filter(p => ((p.owner || '') + '').toLowerCase().includes(colOwner));
        }

        if (colApprovedBy) {
            approved = approved.filter(p => ((p.approvedBy || '') + '').toLowerCase().includes(colApprovedBy));
        }

        if (colCreatedBy) {
            approved = approved.filter(p => ((p.createdBy || '') + '').toLowerCase().includes(colCreatedBy));
        }

        approved.sort((a, b) => parseDateForSorting(b.approvedDate) - parseDateForSorting(a.approvedDate));
        
        if(approved.length === 0) { tbody.innerHTML = `<tr><td colspan="10" class="text-center py-10 text-slate-500">No approved proposals match the current filters.</td></tr>`; return; }
        
        approved.forEach(p => { 
            const status = calculateProposalStatus(p);
            const approvedCount = (p.approvedCommercialIds && p.approvedCommercialIds.length) || 0;

            // Compute only those commercials that are actually available for approval:
            // - commercial.status must be 'Completed'
            // - commercial id must not already be in approvedCommercialIds
            // - commercial id must not be in rejectedCommercialIds
            // - linked sample must exist and be 'Completed'
            // - linked vendor must exist and be 'Completed'
            const allCommercials = (p.commercials && p.commercials.data) || [];
            const approvedIds = p.approvedCommercialIds || [];
            const approvableCommercials = allCommercials.filter(comm => {
                if (comm.status !== 'Completed') return false;
                if (approvedIds.includes(comm.id)) return false;
                if (p.rejectedCommercialIds && p.rejectedCommercialIds.includes(comm.id)) return false;
                const sample = (p.sample && p.sample.data) ? p.sample.data.find(s => s.id == comm.sampleId) : null;
                if (!sample || sample.status !== 'Completed') return false;
                const vendor = (p.vendorIdentification && p.vendorIdentification.data) ? p.vendorIdentification.data.find(v => v.id == sample.vendorId) : null;
                if (!vendor || vendor.status !== 'Completed') return false;
                return true;
            });
            const pendingCount = approvableCommercials.length;
            
            const row = document.createElement('tr'); 
            row.className = 'hover:bg-indigo-100/50 cursor-pointer transition-colors duration-150'; 
            row.dataset.id = p.id; 
            row.innerHTML = ` <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${p.id}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.productType}</td> <td class="px-6 py-4 text-sm text-slate-500 whitespace-normal max-w-xs truncate" title="${p.description || ''}">${p.description || ''}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.owner}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-semibold text-green-600">${approvedCount}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-semibold text-orange-600">${pendingCount}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.createdDate}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.createdBy}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.approvedBy || 'N/A'}</td> <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.approvedDate}</td> `; 
            row.addEventListener('click', () => { 
                currentProposalId = p.id; 
                renderProposalDetail(false, true); // isViewOnly=false, isFromApprovedTab=true
                const proposalDetailBackBtn = document.getElementById('proposal-detail-back-btn');
                proposalDetailBackBtn.textContent = ' Back to Approved Proposals';
                proposalDetailBackBtn.onclick = () => {
                    renderApprovedProposalsTable();
                    showView('proposals'); // <-- Show 'proposals' view
                    document.getElementById('inner-tab-approved').click(); // <-- Click inner tab
                };
                showView('proposalDetail'); 
            }); 
            tbody.appendChild(row); 
        });
    };
    const renderArchivedProposalsTable = () => {
        const archFyEl = document.getElementById('filter-archived-fy');
        const selectedArchivedFYs = archFyEl ? Array.from(archFyEl.selectedOptions).map(o => o.value).filter(v => v) : [];
        const includeAllArchivedFy = selectedArchivedFYs.length === 0;
        const getFyFromDateStr = (dateStr) => {
            const d = parseDateForSorting(dateStr);
            const y = d.getFullYear(); const m = d.getMonth();
            return (m >= 3) ? `${y}-${y+1}` : `${y-1}-${y}`;
        };
        const colType = (document.getElementById('col-filter-arch-productType') && document.getElementById('col-filter-arch-productType').value) || '';
        const colDesc = (document.getElementById('col-filter-arch-description') && document.getElementById('col-filter-arch-description').value.trim().toLowerCase()) || '';
        const colStatus = (document.getElementById('col-filter-arch-status') && document.getElementById('col-filter-arch-status').value) || '';
        const colOwner = (document.getElementById('col-filter-arch-owner') && document.getElementById('col-filter-arch-owner').value.trim().toLowerCase()) || '';
        const colRejectedBy = (document.getElementById('col-filter-arch-rejectedBy') && document.getElementById('col-filter-arch-rejectedBy').value.trim().toLowerCase()) || '';
        // Date filters removed - colRejectedOn and colCreatedOn no longer used
        const colCreatedBy = (document.getElementById('col-filter-arch-createdBy') && document.getElementById('col-filter-arch-createdBy').value.trim().toLowerCase()) || '';
        const tbody = document.getElementById('archived-proposals-table-body');
        tbody.innerHTML = '';
        
        let filteredProposals = proposals.filter(p => !p.isApproved && (p.isRejected || p.isWithdrawn));

        if (!isManagerView) {
            filteredProposals = filteredProposals.filter(p => p.owner === currentUser.name);
        }

        if (!includeAllArchivedFy) {
            filteredProposals = filteredProposals.filter(p => selectedArchivedFYs.includes(getFyFromDateStr(p.createdDate)));
        }

        if (colType) {
            filteredProposals = filteredProposals.filter(p => p.productType === colType);
        }

        if (colDesc) {
            filteredProposals = filteredProposals.filter(p => ((p.description || '') + '').toLowerCase().includes(colDesc));
        }

        if (colStatus) {
            if (colStatus === 'Rejected') filteredProposals = filteredProposals.filter(p => p.isRejected);
            else if (colStatus === 'Withdrawn') filteredProposals = filteredProposals.filter(p => p.isWithdrawn);
        }

        if (colOwner) {
            filteredProposals = filteredProposals.filter(p => ((p.owner || '') + '').toLowerCase().includes(colOwner));
        }

        if (colRejectedBy) {
            filteredProposals = filteredProposals.filter(p => {
                const rejectedBy = p.isRejected ? (p.rejectedBy || '') : (p.withdrawnBy || '');
                return rejectedBy.toLowerCase().includes(colRejectedBy);
            });
        }

        if (colCreatedBy) {
            filteredProposals = filteredProposals.filter(p => ((p.createdBy || '') + '').toLowerCase().includes(colCreatedBy));
        }

        filteredProposals.sort((a, b) => {
            const aDate = a.isRejected ? parseDateForSorting(a.rejectedDate) : parseDateForSorting(a.withdrawnDate);
            const bDate = b.isRejected ? parseDateForSorting(b.rejectedDate) : parseDateForSorting(b.withdrawnDate);
            return bDate - aDate;
        });
        
        if(filteredProposals.length === 0) { 
            tbody.innerHTML = `<tr><td colspan="9" class="text-center py-10 text-slate-500">No archived proposals match the current filters.</td></tr>`; 
            return; 
        }
        
        filteredProposals.forEach(p => { 
            const status = calculateProposalStatus(p);
            const rejectedBy = p.isRejected ? (p.rejectedBy || 'N/A') : (p.withdrawnBy || 'N/A');
            const rejectedOn = p.isRejected ? (p.rejectedDate || 'N/A') : (p.withdrawnDate || 'N/A');
            
            const row = document.createElement('tr'); 
            row.className = 'hover:bg-indigo-100/50 cursor-pointer transition-colors duration-150'; 
            row.dataset.id = p.id; 
            row.innerHTML = ` 
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${p.id}</td> 
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.productType}</td> 
                <td class="px-6 py-4 text-sm text-slate-500 whitespace-normal max-w-xs truncate" title="${p.description || ''}">${p.description || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="status-badge ${getStatusClass(status)}">${status}</span></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.owner}</td> 
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.createdDate}</td> 
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${p.createdBy}</td> 
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${rejectedBy}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${rejectedOn}</td>
            `; 
            
            row.addEventListener('click', () => { 
                currentProposalId = p.id; 
                renderProposalDetail(false, false); // isViewOnly=false, isFromApprovedTab=false
                const proposalDetailBackBtn = document.getElementById('proposal-detail-back-btn');
                proposalDetailBackBtn.textContent = ' Back to Rejected/Withdrawn Proposals';
                proposalDetailBackBtn.onclick = () => {
                    renderArchivedProposalsTable();
                    showView('proposals'); // <-- Show 'proposals' view
                    document.getElementById('inner-tab-archived').click(); // <-- Click inner tab
                };
                showView('proposalDetail'); 
            }); 
            tbody.appendChild(row); 
        });
    };
    const renderProposalDetail = (isViewOnly = false, isFromApprovedTab = false) => {
        contextIsFromApprovedTab = isFromApprovedTab; // Set context for back button
        const p = proposals.find(prop => prop.id === currentProposalId); if (!p) return; const status = calculateProposalStatus(p); document.getElementById('detail-proposal-id').innerText = `Proposal: ${p.id}`; document.getElementById('detail-proposal-type').innerText = p.productType; let infoHtml = ` <div><dt class="font-medium text-slate-600">Overall Status</dt><dd><span class="status-badge ${getStatusClass(status)}">${status}</span></dd></div> <div><dt class="font-medium text-slate-600">Owner</dt><dd class="text-slate-500">${p.owner}</dd></div> <div><dt class="font-medium text-slate-600">Created</dt><dd class="text-slate-500">${p.createdDate}</dd></div> <div><dt class="font-medium text-slate-600">Created By</dt><dd class="text-slate-500">${p.createdBy}</dd></div> ${p.packSize ? `<div><dt class="font-medium text-slate-600">Pack Size</dt><dd class="text-slate-500">${p.packSize}</dd></div>` : ''} `; if (p.productType === 'Pharma') { infoHtml += ` <div><dt class="font-medium text-slate-600">Audit Form</dt><dd class="text-slate-500">${p.auditForm}</dd></div> <div class="col-span-2"><dt class="font-medium text-slate-600">Composition</dt><dd class="text-slate-500">${p.composition}</dd></div> `; } else { infoHtml += `<div class="col-span-2"><dt class="font-medium text-slate-600">Category</dt><dd class="text-slate-500">${p.categoryL1} > ${p.categoryL2} > ${p.categoryL3}</dd></div>`; } if (p.description) { infoHtml += `<div class="col-span-2 md:col-span-4"><dt class="font-medium text-slate-600">Description</dt><dd class="text-slate-500 mt-1 whitespace-pre-wrap">${p.description}</dd></div>`; } document.getElementById('detail-proposal-info').innerHTML = infoHtml;
        const actionsContainer = document.getElementById('detail-proposal-actions'); 
        actionsContainer.innerHTML = '';
        if(!isViewOnly) {
            const isActionable = !p.isApproved && !p.isRejected && !p.isWithdrawn;
            if (isManagerView && isActionable) { 
                const approvableCommercials = p.commercials.data.filter(comm => {
                    if (comm.status !== 'Completed') return false;
                    // --- MODIFICATION START: Exclude rejected commercials ---
                    if (p.rejectedCommercialIds && p.rejectedCommercialIds.includes(comm.id)) return false;
                    // --- MODIFICATION END ---
                    const sample = p.sample.data.find(s => s.id == comm.sampleId && s.status === 'Completed');
                    if (!sample) return false;
                    const vendor = p.vendorIdentification.data.find(v => v.id == sample.vendorId && v.status === 'Completed');
                    return !!vendor;
                });
                const canApprove = approvableCommercials.length > 0;
                
                // --- MODIFICATION START: Only show buttons if there are approvable commercials ---
                if (canApprove) {
                    actionsContainer.innerHTML += `<button id="btn-approve-proposal" class="font-semibold py-2 px-4 rounded-lg shadow-sm transition-all duration-200 bg-green-600 text-white hover:bg-green-700 hover:shadow-md">Approve Proposal</button>`; 
                    actionsContainer.innerHTML += `<button id="btn-reject-proposal" class="font-semibold py-2 px-4 rounded-lg shadow-sm transition-all duration-200 bg-red-600 text-white hover:bg-red-700 hover:shadow-md">Reject Proposal</button>`;
                }
                // --- MODIFICATION END --- 
                actionsContainer.innerHTML += `<button id="btn-transfer-owner" class="bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-slate-600 transition hover:shadow-md">Transfer Ownership</button>`; 
            }
            if (isActionable && !isManagerView && p.owner === currentUser.name) { // <-- MODIFICATION: Added owner check
                actionsContainer.innerHTML += `<button id="btn-withdraw-proposal" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-yellow-600 transition hover:shadow-md">Withdraw Proposal</button>`; 
                actionsContainer.innerHTML += `<button id="btn-transfer-owner" class="bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-slate-600 transition hover:shadow-md">Transfer Ownership</button>`; 
            }

            
            // Allow manager and employee (if owner) to transfer ownership of an *approved* proposal
            
            

            // <!-- --- MODIFICATION START: Listener block moved from here --- -->
            // if (document.getElementById('btn-approve-proposal')) document.getElementById('btn-approve-proposal').addEventListener('click', handleInitiateApproval); 
            // if (document.getElementById('btn-reject-proposal')) document.getElementById('btn-reject-proposal').addEventListener('click', handleRejectProposal); 
            // if (document.getElementById('btn-withdraw-proposal')) document.getElementById('btn-withdraw-proposal').addEventListener('click', handleWithdrawProposal); 
            
            // 
        }

        const allCommercials = p.commercials.data;
        const approvedIds = p.approvedCommercialIds || [];
        
        // --- MODIFICATION START: Use stricter filter for pending commercials ---
        const pendingCommercials = allCommercials.filter(comm => {
            // Basic checks: Not already approved and the commercial entry itself is "Completed"
            if (approvedIds.includes(comm.id) || comm.status !== 'Completed') {
                return false;
            }
            
            // Find the linked sample
            const sample = p.sample.data.find(s => s.id == comm.sampleId);
            // Check if sample exists and is fully "Completed" (not "WIP")
            if (!sample || sample.status !== 'Completed') {
                return false;
            }
            
            // Find the linked vendor
            const vendor = p.vendorIdentification.data.find(v => v.id == sample.vendorId);
            // Check if vendor exists and is fully "Completed" (not "WIP")
            if (!vendor || vendor.status !== 'Completed') {
                return false;
            }
            
            // Check if commercial is rejected
            if (p.rejectedCommercialIds && p.rejectedCommercialIds.includes(comm.id)) {
                return false;
            }
            
            // If all checks pass, it's a valid pending commercial
            return true;
        });
        // --- MODIFICATION END ---
        
        
        // Allow manager and employee (if owner) to transfer ownership of an *approved* proposal
        if (p.isApproved && (isManagerView || p.owner === currentUser.name)) {
            actionsContainer.innerHTML += `<button id="btn-transfer-owner" class="bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-slate-600 transition hover:shadow-md">Transfer Ownership</button>`;
        }
        
        if (p.isApproved && isManagerView && pendingCommercials.length > 0) {
            actionsContainer.innerHTML += `
                <button id="btn-open-approve-pending-modal" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-green-700 transition hover:shadow-md">Approve Pending Variants</button>
            `;
            // <!-- --- MODIFICATION START: Listener moved from here --- -->
            // if (document.getElementById('btn-open-approve-pending-modal')) document.getElementById('btn-open-approve-pending-modal').addEventListener('click', openPendingVariantsApprovalModal);
            // 
        }

        // --- MODIFICATION START: ATTACH ALL LISTENERS HERE ---
        if(!isViewOnly) {
            if (document.getElementById('btn-approve-proposal')) document.getElementById('btn-approve-proposal').addEventListener('click', handleInitiateApproval); 
            if (document.getElementById('btn-reject-proposal')) document.getElementById('btn-reject-proposal').addEventListener('click', handleRejectProposal); 
            if (document.getElementById('btn-withdraw-proposal')) document.getElementById('btn-withdraw-proposal').addEventListener('click', handleWithdrawProposal); 
        }
        if (document.getElementById('btn-open-approve-pending-modal')) document.getElementById('btn-open-approve-pending-modal').addEventListener('click', openPendingVariantsApprovalModal);
        // This listener is now outside the isViewOnly block, so it works for both cases
        if (document.getElementById('btn-transfer-owner')) document.getElementById('btn-transfer-owner').addEventListener('click', handleTransferOwner);
        

        document.getElementById('vendor-count').innerText = p.vendorIdentification.data.length; document.getElementById('sample-count').innerText = p.sample.data.length; document.getElementById('commercials-count').innerText = p.commercials.data.length; document.getElementById('agreement-proposal-count').innerText = p.agreementProposal.data.length;

        const productsContainer = document.getElementById('products-for-approved-proposal-container');
        
        // --- MODIFICATION START: Show products if the proposal is approved ---
        // Changed this from `if (isFromApprovedTab)` to `if (p.isApproved)`
        if (p.isApproved) {
        // --- MODIFICATION END ---
            let tasksForProposal = wipTasks.filter(task => task.proposalId === currentProposalId);
            
            if (!isManagerView) {
                tasksForProposal = tasksForProposal.filter(task => task.owner === currentUser.name);
            }
            
            
            tasksForProposal.sort((a, b) => parseDateForSorting(b.createdDate) - parseDateForSorting(a.createdDate));
            
            let productsHtml = `
                <h3 class="text-xl font-semibold text-slate-800 mb-4">Products for Proposal</h3>
                <div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50/75">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Commercial ID</th>
                                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product ID</th>
                                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Product Name</th>
                                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Vendor</th>
                                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Owner</th>
                                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created On</th>
                                                    <th class="px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Created by</th>
                                                </tr>
                            </thead>
                            <tbody id="approved-proposal-products-tbody" class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            productsContainer.innerHTML = productsHtml;

            const tbody = document.getElementById('approved-proposal-products-tbody');
            if (tasksForProposal.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-10 text-slate-500">No products added for this proposal yet.</td></tr>`;
            } else {
                tasksForProposal.forEach(task => {
                    const status = calculateWipStatus(task); 
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-indigo-100/50 transition-colors duration-150';

                    const proposalOfTask = proposals.find(p => p.id === task.proposalId);
                    const vendorId = task.vendorId;
                    const vendorNameHtml = vendorId 
                        ? `<a href="#" onclick="event.stopPropagation(); showVendorDetailsPopup('${task.proposalId}', ${vendorId})" class="app-link">${task.vendorName}</a>`
                        : task.vendorName;
                    
                    // Create the edit button
                    // const editButton = (isManagerView || task.owner !== currentUser.name) ? '' : `
                    //     <button onclick="event.stopPropagation(); openEditProductNameModal('${task.id}', 'approvedProposalDetail')" class="ml-2 text-slate-400 hover:text-indigo-600 transition-colors">
                    //         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    //             <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    //         </svg>
                    //     </button>
                    // `;

                    // Render Commercial ID first (clickable) then Product ID and other columns
                    row.innerHTML = ` 
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.commercialId || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${task.productId || ''}</td> 
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 flex items-center">
                            <span>${task.productName}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${vendorNameHtml}</td> 
                        <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="status-badge ${getStatusClass(status)}">${status}</span></td> 
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.owner}</td> 
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.createdDate}</td> 
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.createdBy}</td> 
                    `;
 
                    
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'A' && !e.target.closest('button')) {
                            currentWipId = task.id; 
                            renderWipDetail('approvedProposalDetail');
                            showView('wipDetail');
                        }
                    });
                    tbody.appendChild(row);
                });
            }

        } else {
            productsContainer.innerHTML = ''; // Clear the container if not coming from approved tab
        }
    };
    const renderSummaryTable = () => {
        document.getElementById('summary-title').textContent = isManagerView ? 'Employee Product Progress Summary' : 'Product Progress Summary';

        const summaryFyEl = document.getElementById('summary-fy-filter');
        const selectedSummaryFYs = summaryFyEl ? Array.from(summaryFyEl.selectedOptions).map(o => o.value).filter(v => v) : [];
        const includeAllSummaryFy = selectedSummaryFYs.length === 0;
        const getFyFromDateStr = (dateStr) => { const d = parseDateForSorting(dateStr); const y = d.getFullYear(); const m = d.getMonth(); return (m >= 3) ? `${y}-${y+1}` : `${y-1}-${y}`; };

        // --- MODIFICATION START ---
        // 1. Read filter values. These inputs are static now.
        const filterEmpId = (document.getElementById('col-filter-summary-empId') ? document.getElementById('col-filter-summary-empId').value.trim().toLowerCase() : '');
        const filterEmpName = (document.getElementById('col-filter-summary-empName') ? document.getElementById('col-filter-summary-empName').value.trim().toLowerCase() : '');
        // --- MODIFICATION END ---

        const filteredWipTasks = includeAllSummaryFy ? wipTasks.slice() : wipTasks.filter(task => selectedSummaryFYs.includes(getFyFromDateStr(task.createdDate)));

        let employeesToDisplay = isManagerView ? dummyEmployees : [currentUser];
        
        // Apply employee filters
        employeesToDisplay = employeesToDisplay.filter(emp => {
            if (filterEmpId && !(emp.id.toLowerCase().includes(filterEmpId))) return false;
            if (filterEmpName && !(emp.name.toLowerCase().includes(filterEmpName))) return false;
            return true;
        });
        
        // --- MODIFICATION START ---
        // const thead = document.querySelector("#view-summary thead"); // No longer needed
        const tbody = document.getElementById('summary-table-body');
        // thead.innerHTML = ''; // DO NOT DO THIS
        tbody.innerHTML = '';

        // 1. Toggle expanded class on table
        const table = document.getElementById('summary-table');
        const wipExpandTh = document.getElementById('wip-expand-th');
        if (isWipExpanded) {
            table.classList.add('summary-table-expanded');
        } else {
            table.classList.remove('summary-table-expanded');
        }
        // --- MODIFICATION END ---

        if (isWipExpanded) {
            // --- EXPANDED VIEW ---
            const stageColumns = [
                { key: 'agreement', name: 'Agreement Completed' },
                { key: 'artWork', name: 'Art Work Completed' },
                { key: 'pricing', name: 'Pricing Completed' },
                { key: 'branding', name: 'Branding Completed' },
                { key: 'vendorKYC', name: 'Vendor KYC Completed' },
                { key: 'poReleased', name: 'PO released' },
                { key: 'productionStarted', name: 'Production Started' },
                { key: 'rawMaterialsProcured', name: 'Raw Materials Procured' },
                { key: 'packingMaterialProcured', name: 'Packing Materials Procured' },
                { key: 'grn', name: 'GRN Completed' }
            ];
            
            // const stageHeaders = ... // No longer needed
            // thead.innerHTML = ... // DO NOT DO THIS

            const summaryData = employeesToDisplay.map(emp => {
                const data = { id: emp.id, name: emp.name, wip: 0, launched: 0 };
                stageColumns.forEach(col => data[col.key] = 0);
                return data;
            });

            filteredWipTasks.forEach(task => {
                const ownerSummary = summaryData.find(e => e.name === task.owner);
                if (!ownerSummary) return;

                const status = calculateWipStatus(task);
                if (status === 'WIP' || status === 'Project Approved') {
                    ownerSummary.wip++;

                    stageColumns.forEach(col => {
                        const stage = task.stages[col.key];
                        let isStageComplete = false;
                        if (stage && stage.data.length > 0) {
                             if (['productionStarted', 'rawMaterialsProcured', 'packingMaterialProcured'].includes(col.key)) {
                                if (stage.data[0].value === 'Yes') isStageComplete = true;
                            } else if (col.key === 'poReleased') {
                                isStageComplete = true;
                            } else if (col.key === 'grn') {
                                if (stage.data.length > 0) isStageComplete = true;
                            }
                            else {
                                if (calculateWipStageOverallStatus(stage, col.key) === 'Completed') isStageComplete = true;
                            }
                        }
                        if (isStageComplete) ownerSummary[col.key]++;
                    });
                } else if (status === 'Launched') {
                    ownerSummary.launched++;
                }
            });

            // Always show filtered employees, even if they have 0 products

            summaryData.forEach(emp => {
                const row = document.createElement('tr');
                // --- MODIFICATION: Added class="summary-stage-col" to stage cells ---
                const stageCells = stageColumns.map(col => `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 text-center summary-stage-col">${emp[col.key]}</td>`).join('');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${emp.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${emp.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><a href="#" onclick="showEmployeeProductsByStatus('${emp.name}', 'WIP')" class="app-link">${emp.wip}</a></td>
                    ${stageCells}
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><a href="#" onclick="showEmployeeProductsByStatus('${emp.name}', 'Launched')" class="app-link">${emp.launched}</a></td>
                `;
                tbody.appendChild(row);
            });
            
        } else {
            // --- COLLAPSED VIEW ---
            const summaryData = employeesToDisplay.map(emp => ({ id: emp.id, name: emp.name, wip: 0, launched: 0 }));

            filteredWipTasks.forEach(task => {
                const ownerSummary = summaryData.find(e => e.name === task.owner);
                if (ownerSummary) {
                    const status = calculateWipStatus(task);
                    if (status === 'WIP' || status === 'Project Approved') {
                        ownerSummary.wip++;
                    } else if (status === 'Launched') {
                        ownerSummary.launched++;
                    }
                }
            });
            
            // --- MODIFICATION START: Update expand button in static TH ---
            const totalWip = summaryData.reduce((acc, emp) => acc + emp.wip, 0);
            const expandButton = totalWip > 0 
                ? `<button type="button" id="wip-expand-btn" class="normal-case">&lt;&gt;</button>` 
                : `<span class="normal-case text-slate-400">&gt;&lt;</span>`;
            if (wipExpandTh) {
                wipExpandTh.innerHTML = `WIP ${expandButton}`;
            }
            // thead.innerHTML = ... // DO NOT DO THIS
            // --- MODIFICATION END ---


            // Always show filtered employees, even if they have 0 products

            summaryData.forEach(emp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${emp.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${emp.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><a href="#" onclick="showEmployeeProductsByStatus('${emp.name}', 'WIP')" class="app-link">${emp.wip}</a></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm"><a href="#" onclick="showEmployeeProductsByStatus('${emp.name}', 'Launched')" class="app-link">${emp.launched}</a></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // --- MODIFICATION START ---
        // REMOVED ALL LOGIC for re-attaching listeners and restoring values.
        // It's no longer needed.
        // --- MODIFICATION END ---
    };

    function openEditProductNameModal(taskId, contextView = 'approvedProposalDetail') {
        currentWipId = taskId;
        editProductNameContext = contextView; // Store the context
        const task = wipTasks.find(t => t.id === taskId);
        if (!task) return;

        const modal = document.getElementById('edit-product-name-modal');
        document.getElementById('editProductNameInput').value = task.productName;
        modal.classList.remove('hidden');
    }

    function handleSaveProductName(e) {
        e.preventDefault();
        const task = wipTasks.find(t => t.id === currentWipId);
        if (!task) return;

        const newName = document.getElementById('editProductNameInput').value;
        if (newName.trim() === '') {
            // Using a custom alert/modal would be better, but for now this is fine based on existing patterns
            alert('Product name cannot be empty.');
            return;
        }

        task.productName = newName;
        document.getElementById('edit-product-name-modal').classList.add('hidden');
        
        // --- MODIFICATION START: Re-render detail view first, then list view ---
        // Re-render the detail view I'm currently on
        renderWipDetail(editProductNameContext);

        // Also re-render the list view I came from
        if (editProductNameContext === 'newProductsList') {
            renderNewProductsList();
        } else if (editProductNameContext === 'proposalTasks') {
            renderProposalTasksView();
        } else if (editProductNameContext === 'approvedProposalDetail') { 
            renderProposalDetail(false, true); 
        } else if (editProductNameContext === 'summary') {
            // Summary doesn't show product names, but good to be thorough
            renderSummaryTable();
        }
        // --- MODIFICATION END ---

        // currentWipId = null; // <-- BUG FIX: Removed this line, as it was clearing the context
        editProductNameContext = null; // Clear context
    }

    const renderNewProductsList = () => {
        // CHANGED: Get all three new tbody elements
        const tbodyWip = document.getElementById('new-products-table-body-wip');
        const tbodyLaunched = document.getElementById('new-products-table-body-launched');
        const tbodyWithdrawn = document.getElementById('new-products-table-body-withdrawn');
        
        // Clear all three
        tbodyWip.innerHTML = '';
        tbodyLaunched.innerHTML = '';
        tbodyWithdrawn.innerHTML = '';

        // Manage table header checkbox columns based on bulk mode
        const wipThead = document.querySelector('#inner-panel-wip table thead');
        const launchedThead = document.querySelector('#inner-panel-launched table thead');
        const withdrawnThead = document.querySelector('#inner-panel-withdrawn table thead');

        function ensureCheckboxHeader(thead, idPrefix, isWithdrawnTab = false) {
            if (!thead) return;
            const firstRow = thead.querySelector('tr:first-child');
            const secondRow = thead.querySelectorAll('tr')[1];
            if (isBulkTransferMode && !isWithdrawnTab) {
                // insert checkbox th in first row if missing
                if (!firstRow.querySelector('.bulk-header-cell')) {
                    const th = document.createElement('th');
                    th.className = 'px-6 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider bulk-header-cell';
                    th.innerHTML = `<input type="checkbox" id="select-all-${idPrefix}" class="h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500">`;
                    firstRow.insertBefore(th, firstRow.firstChild);
                }
                // insert empty cell in filter row for alignment
                if (secondRow && !secondRow.querySelector('.bulk-filter-cell')) {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-2 bulk-filter-cell';
                    secondRow.insertBefore(td, secondRow.firstChild);
                }
            } else {
                // remove if present
                const bh = firstRow && firstRow.querySelector('.bulk-header-cell');
                if (bh) bh.remove();
                const bf = secondRow && secondRow.querySelector('.bulk-filter-cell');
                if (bf) bf.remove();
            }
        }

        ensureCheckboxHeader(wipThead, 'wip', false);
        // ensureCheckboxHeader(launchedThead, 'launched', false);
        ensureCheckboxHeader(withdrawnThead, 'withdrawn', true);
        
        // --- MODIFICATION START ---
        const newProdFyEl = document.getElementById('filter-new-products-fy');
        const selectedNewProdFYs = newProdFyEl ? Array.from(newProdFyEl.selectedOptions).map(o => o.value).filter(v => v) : [];
        const includeAllNewProdFy = selectedNewProdFYs.length === 0;
        const getFyFromDateStr = (dateStr) => { const d = parseDateForSorting(dateStr); const y = d.getFullYear(); const m = d.getMonth(); return (m >= 3) ? `${y}-${y+1}` : `${y-1}-${y}`; };

        let baseFilteredTasks = isManagerView ? [...wipTasks] : wipTasks.filter(task => task.owner === currentUser.name);

        if (!includeAllNewProdFy) {
            baseFilteredTasks = baseFilteredTasks.filter(task => selectedNewProdFYs.includes(getFyFromDateStr(task.createdDate)));
        }

        // Keep baseFilteredTasks as the universal set (filtered by FY and owner/view).
        // Do not apply WIP column-level filters here so Launched/Withdrawn tabs are not affected.
        const filteredTasks = baseFilteredTasks; // Keep the name for consistency
        // --- MODIFICATION END ---
        
        // Create the row-building function to avoid repetition
        const createProductRowHtml = (task, extraCols = false) => {
            const status = calculateWipStatus(task);
            const proposal = proposals.find(p => p.id === task.proposalId);
            const vendorId = proposal ? proposal.finalizedVendorId : null;
            
            const productIdHtml = task.productId ? `<a href="#" onclick="viewWipTaskDetail('${task.id}', 'newProductsList')" class="app-link">${task.productId}</a>` : '';
            const proposalIdHtml = `<a href="#" onclick="event.stopPropagation(); viewProposalInReadOnly('${task.proposalId}', 'newProductsList')" class="app-link">${task.proposalId}</a>`;
            const vendorNameHtml = vendorId 
                ? `<a href="#" onclick="event.stopPropagation(); showVendorDetailsPopup('${task.proposalId}', ${vendorId})" class="app-link">${task.vendorName}</a>`
                : task.vendorName;

            // Create the edit button
            // const editButton = (isManagerView || task.owner !== currentUser.name) ? '' : `
            //     <button onclick="event.stopPropagation(); openEditProductNameModal('${task.id}', 'newProductsList')" class="ml-2 text-slate-400 hover:text-indigo-600 transition-colors">
            //         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            //             <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            //         </svg>
            //     </button>
            // `;

            let html = '';
            // If bulk transfer mode, prepend checkbox cell (but not for withdrawn or launched items)
            const isWithdrawn = extraCols === 'withdrawn';
            const isLaunched = extraCols === 'launched';
            if (isBulkTransferMode && !isWithdrawn && !isLaunched) {
                const checked = productsToTransfer.includes(task.id) ? 'checked' : '';
                html += `<td class="px-6 py-4 whitespace-nowrap text-sm">
                            <input type="checkbox" value="${task.id}" class="bulk-transfer-checkbox h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500" ${checked}>
                         </td>`;
            }

            html += `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${productIdHtml}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 flex items-center">
                    <span>${task.productName}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${proposalIdHtml}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.commercialId || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${vendorNameHtml}</td>
                ${status!=='Launched' && status!=='Withdrawn' ?
                `<td class="px-6 py-4 whitespace-nowrap text-sm"><span class="status-badge ${getStatusClass(status)}">${status}</span></td>`:''}
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.owner}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.createdDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.createdBy}</td>
            `;

            if (extraCols === 'launched') {
                const launchedOn = task.launchedOn || '';
                const launchedBy = task.launchedBy || '';
                html += `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${launchedOn}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${launchedBy}</td>
                `;
            } else if (extraCols === 'withdrawn') {
                const withdrawnOn = task.withdrawnOn || '';
                const withdrawnBy = task.withdrawnBy || '';
                html += `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${withdrawnOn}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${withdrawnBy}</td>
                `;
            }

            return html;
        };

        const attachRowClickListener = (row, task) => {
             row.addEventListener('click', (e) => {
                // Ignore clicks on links, buttons and inputs (checkboxes)
                const tag = e.target.tagName;
                if (tag !== 'A' && tag !== 'INPUT' && !e.target.closest('button')) {
                    viewWipTaskDetail(task.id, 'newProductsList');
                }
            });
        };

        // ADDED: Split tasks into three lists
        let wipTasksList = [];
        let launchedTasksList = [];
        let withdrawnTasksList = [];

        filteredTasks.forEach(task => {
            const status = calculateWipStatus(task);
            if (status === 'Withdrawn') {
                withdrawnTasksList.push(task);
            } else if (status === 'Launched') {
                launchedTasksList.push(task);
            } else {
                // Includes 'WIP', 'Project Approved', 'Approval Pending'
                wipTasksList.push(task);
            }
        });

        // --- WIP-specific column filters (apply only to WIP tab) ---
        const fProductName = document.getElementById('col-filter-wip-productName') ? document.getElementById('col-filter-wip-productName').value.trim().toLowerCase() : '';
        const fProposalId = document.getElementById('col-filter-wip-proposalId') ? document.getElementById('col-filter-wip-proposalId').value.trim().toLowerCase() : '';
        const fVendorName = document.getElementById('col-filter-wip-vendorName') ? document.getElementById('col-filter-wip-vendorName').value.trim().toLowerCase() : '';
        const fStatus = document.getElementById('col-filter-wip-status') ? document.getElementById('col-filter-wip-status').value : '';
        const fOwner = document.getElementById('col-filter-wip-owner') ? document.getElementById('col-filter-wip-owner').value.trim().toLowerCase() : '';
        const fCreatedOn = document.getElementById('col-filter-wip-createdOn') ? document.getElementById('col-filter-wip-createdOn').value : '';
        const fCreatedBy = document.getElementById('col-filter-wip-createdBy') ? document.getElementById('col-filter-wip-createdBy').value.trim().toLowerCase() : '';

        const formatDateInputToDDMMYYYY = (isoDate) => {
            if (!isoDate) return '';
            const parts = isoDate.split('-'); // yyyy-mm-dd
            if (parts.length !== 3) return '';
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        };

        const fCreatedOnFormatted = formatDateInputToDDMMYYYY(fCreatedOn);

        if (fProductName || fProposalId || fVendorName || fStatus || fOwner || fCreatedOnFormatted || fCreatedBy) {
            wipTasksList = wipTasksList.filter(task => {
                if (fProductName && !((task.productName || '').toLowerCase().includes(fProductName))) return false;
                if (fProposalId && !(String(task.proposalId || '').toLowerCase().includes(fProposalId))) return false;
                if (fVendorName && !((task.vendorName || '').toLowerCase().includes(fVendorName))) return false;
                const status = calculateWipStatus(task);
                if (fStatus && fStatus !== '') {
                    // When the WIP filter is 'WIP' we also want to include 'Project Approved' tasks
                    if (fStatus === 'WIP') {
                        if (!(status === 'WIP' || status === 'Project Approved')) return false;
                    } else {
                        if (status !== fStatus) return false;
                    }
                }
                if (fOwner && !((task.owner || '').toLowerCase().includes(fOwner))) return false;
                if (fCreatedOnFormatted && (parseDateForSorting(task.createdDate).getTime() !== parseDateForSorting(fCreatedOnFormatted).getTime())) return false;
                if (fCreatedBy && !((task.createdBy || '').toLowerCase().includes(fCreatedBy))) return false;
                return true;
            });
        }

        // Sort each list
        wipTasksList.sort((a, b) => parseDateForSorting(b.createdDate) - parseDateForSorting(a.createdDate));
        launchedTasksList.sort((a, b) => parseDateForSorting(b.createdDate) - parseDateForSorting(a.createdDate));
        withdrawnTasksList.sort((a, b) => parseDateForSorting(b.createdDate) - parseDateForSorting(a.createdDate));

        // --- Launched-specific column filters (per-tab filters) ---
        const fLProductName = document.getElementById('col-filter-launched-productName') ? document.getElementById('col-filter-launched-productName').value.trim().toLowerCase() : '';
        const fLProposalId = document.getElementById('col-filter-launched-proposalId') ? document.getElementById('col-filter-launched-proposalId').value.trim().toLowerCase() : '';
        const fLVendorName = document.getElementById('col-filter-launched-vendorName') ? document.getElementById('col-filter-launched-vendorName').value.trim().toLowerCase() : '';

        const fLOwner = document.getElementById('col-filter-launched-owner') ? document.getElementById('col-filter-launched-owner').value.trim().toLowerCase() : '';
        const fLCreatedOn = document.getElementById('col-filter-launched-createdOn') ? document.getElementById('col-filter-launched-createdOn').value : '';
        const fLCreatedBy = document.getElementById('col-filter-launched-createdBy') ? document.getElementById('col-filter-launched-createdBy').value.trim().toLowerCase() : '';
        const fLLaunchedOn = document.getElementById('col-filter-launched-launchedOn') ? (function(iso){ if(!iso) return ''; const parts=iso.split('-'); if(parts.length!==3) return ''; return `${parts[2]}-${parts[1]}-${parts[0]}`; })(document.getElementById('col-filter-launched-launchedOn').value) : '';
        const fLLaunchedBy = document.getElementById('col-filter-launched-launchedBy') ? document.getElementById('col-filter-launched-launchedBy').value.trim().toLowerCase() : '';

        const fLCreatedOnFormatted = (function(iso){ if(!iso) return ''; const parts=iso.split('-'); if(parts.length!==3) return ''; return `${parts[2]}-${parts[1]}-${parts[0]}`; })(fLCreatedOn);

        if (fLProductName || fLProposalId || fLVendorName || fLOwner || fLCreatedOnFormatted || fLCreatedBy || fLLaunchedOn || fLLaunchedBy) {
            launchedTasksList = launchedTasksList.filter(task => {
                if (fLProductName && !((task.productName || '').toLowerCase().includes(fLProductName))) return false;
                if (fLProposalId && !(String(task.proposalId || '').toLowerCase().includes(fLProposalId))) return false;
                if (fLVendorName && !((task.vendorName || '').toLowerCase().includes(fLVendorName))) return false;
                if (fLOwner && !((task.owner || '').toLowerCase().includes(fLOwner))) return false;
                if (fLCreatedOnFormatted && (parseDateForSorting(task.createdDate).getTime() !== parseDateForSorting(fLCreatedOnFormatted).getTime())) return false;
                if (fLCreatedBy && !((task.createdBy || '').toLowerCase().includes(fLCreatedBy))) return false;
                if (fLLaunchedOn && (parseDateForSorting(task.launchedOn).getTime() !== parseDateForSorting(fLLaunchedOn).getTime())) return false;
                if (fLLaunchedBy && !((task.launchedBy || '').toLowerCase().includes(fLLaunchedBy))) return false;
                return true;
            });
        }

        // --- Withdrawn-specific column filters (per-tab filters) ---
        const fWProductName = document.getElementById('col-filter-withdrawn-productName') ? document.getElementById('col-filter-withdrawn-productName').value.trim().toLowerCase() : '';
        const fWProposalId = document.getElementById('col-filter-withdrawn-proposalId') ? document.getElementById('col-filter-withdrawn-proposalId').value.trim().toLowerCase() : '';
        const fWVendorName = document.getElementById('col-filter-withdrawn-vendorName') ? document.getElementById('col-filter-withdrawn-vendorName').value.trim().toLowerCase() : '';

        const fWOwner = document.getElementById('col-filter-withdrawn-owner') ? document.getElementById('col-filter-withdrawn-owner').value.trim().toLowerCase() : '';
        const fWCreatedOn = document.getElementById('col-filter-withdrawn-createdOn') ? document.getElementById('col-filter-withdrawn-createdOn').value : '';
        const fWCreatedBy = document.getElementById('col-filter-withdrawn-createdBy') ? document.getElementById('col-filter-withdrawn-createdBy').value.trim().toLowerCase() : '';
        const fWWithdrawnOn = document.getElementById('col-filter-withdrawn-withdrawnOn') ? (function(iso){ if(!iso) return ''; const parts=iso.split('-'); if(parts.length!==3) return ''; return `${parts[2]}-${parts[1]}-${parts[0]}`; })(document.getElementById('col-filter-withdrawn-withdrawnOn').value) : '';
        const fWWithdrawnBy = document.getElementById('col-filter-withdrawn-withdrawnBy') ? document.getElementById('col-filter-withdrawn-withdrawnBy').value.trim().toLowerCase() : '';

        const fWCreatedOnFormatted = (function(iso){ if(!iso) return ''; const parts=iso.split('-'); if(parts.length!==3) return ''; return `${parts[2]}-${parts[1]}-${parts[0]}`; })(fWCreatedOn);

        if (fWProductName || fWProposalId || fWVendorName || fWOwner || fWCreatedOnFormatted || fWCreatedBy || fWWithdrawnOn || fWWithdrawnBy) {
            withdrawnTasksList = withdrawnTasksList.filter(task => {
                if (fWProductName && !((task.productName || '').toLowerCase().includes(fWProductName))) return false;
                if (fWProposalId && !(String(task.proposalId || '').toLowerCase().includes(fWProposalId))) return false;
                if (fWVendorName && !((task.vendorName || '').toLowerCase().includes(fWVendorName))) return false;
                if (fWOwner && !((task.owner || '').toLowerCase().includes(fWOwner))) return false;
                if (fWCreatedOnFormatted && (parseDateForSorting(task.createdDate).getTime() !== parseDateForSorting(fWCreatedOnFormatted).getTime())) return false;
                if (fWCreatedBy && !((task.createdBy || '').toLowerCase().includes(fWCreatedBy))) return false;
                if (fWWithdrawnOn && (parseDateForSorting(task.withdrawnOn).getTime() !== parseDateForSorting(fWWithdrawnOn).getTime())) return false;
                if (fWWithdrawnBy && !((task.withdrawnBy || '').toLowerCase().includes(fWWithdrawnBy))) return false;
                return true;
            });
        }

        // Populate WIP table
        if (wipTasksList.length === 0) {
            const colspan = isBulkTransferMode ? 10 : 9;
            tbodyWip.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-10 text-slate-500">No WIP products found.</td></tr>`;
        } else {
            wipTasksList.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-indigo-100/50 cursor-pointer transition-colors duration-150';
                row.innerHTML = createProductRowHtml(task, false);
                attachRowClickListener(row, task);
                tbodyWip.appendChild(row);
            });
        }

        // Populate Launched table
        if (launchedTasksList.length === 0) {
            const colspan = isBulkTransferMode ? 11 : 10;
            tbodyLaunched.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-10 text-slate-500">No launched products found.</td></tr>`;
        } else {
            launchedTasksList.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-indigo-100/50 cursor-pointer transition-colors duration-150';
                row.innerHTML = createProductRowHtml(task, 'launched');
                attachRowClickListener(row, task);
                tbodyLaunched.appendChild(row);
            });
        }

        // Populate Withdrawn table
        if (withdrawnTasksList.length === 0) {
            const colspan = isBulkTransferMode ? 11 : 10;
            tbodyWithdrawn.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-10 text-slate-500">No withdrawn products found.</td></tr>`;
        } else {
            withdrawnTasksList.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-indigo-100/50 cursor-pointer transition-colors duration-150';
                row.innerHTML = createProductRowHtml(task, 'withdrawn');
                attachRowClickListener(row, task);
                tbodyWithdrawn.appendChild(row);
            });
        }

        // Wire bulk-transfer checkbox logic (select-all and per-row) for each tab
        function wireBulkCheckboxes(idPrefix, tbody, isWithdrawnTab = false) {
            if (!isBulkTransferMode || isWithdrawnTab) return; // Don't wire for withdrawn tab
            const selectAll = document.getElementById(`select-all-${idPrefix}`);
            const checkboxes = tbody.querySelectorAll('.bulk-transfer-checkbox');
            
            if (selectAll) {
                // Initialize select-all based on current state
                const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
                selectAll.checked = allChecked;
                
                // Wire the select-all checkbox
                selectAll.addEventListener('change', (e) => {
                    const shouldCheck = e.target.checked;
                    Array.from(checkboxes).forEach(cb => {
                        cb.checked = shouldCheck;
                        // Manually update productsToTransfer
                        const val = cb.value;
                        if (shouldCheck) {
                            if (!productsToTransfer.includes(val)) productsToTransfer.push(val);
                        } else {
                            productsToTransfer = productsToTransfer.filter(id => id !== val);
                        }
                    });
                }, {once: false});
            }
            
            // Wire per-row checkboxes
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const val = cb.value;
                    if (cb.checked) {
                        if (!productsToTransfer.includes(val)) productsToTransfer.push(val);
                    } else {
                        productsToTransfer = productsToTransfer.filter(id => id !== val);
                    }
                    // Update select-all checkbox state
                    if (selectAll) {
                        const allCheckedNow = Array.from(checkboxes).every(c => c.checked);
                        selectAll.checked = allCheckedNow;
                    }
                }, {once: false});
            });
        }

        wireBulkCheckboxes('wip', tbodyWip, false);
        wireBulkCheckboxes('launched', tbodyLaunched, false);
        wireBulkCheckboxes('withdrawn', tbodyWithdrawn, true);
    };

    const renderProposalTasksView = () => {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) {
            showView('approvedProposals'); // Go back if no proposal is set
            return;
        }

        document.getElementById('proposal-tasks-title').innerText = `Products for ${p.id}`;
        
        const tbody = document.getElementById('proposal-tasks-table-body');
        tbody.innerHTML = '';

        let tasksForProposal = wipTasks.filter(task => task.proposalId === currentProposalId);
        tasksForProposal.sort((a, b) => parseDateForSorting(b.createdDate) - parseDateForSorting(a.createdDate));

        if (tasksForProposal.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-slate-500">No products added for this proposal yet.</td></tr>`;
            return;
        }
        
        tasksForProposal.forEach(task => {
            const status = calculateWipStatus(task); 
            const row = document.createElement('tr');
            row.className = 'hover:bg-indigo-100/50 cursor-pointer transition-colors duration-150';

            const proposalOfTask = proposals.find(p => p.id === task.proposalId);
            const vendorId = task.vendorId;
            const vendorNameHtml = vendorId 
                ? `<a href="#" onclick="event.stopPropagation(); showVendorDetailsPopup('${task.proposalId}', ${vendorId})" class="app-link">${task.vendorName}</a>`
                : task.vendorName;
            
            const productIdHtml = task.productId ? `<a href="#" onclick="viewWipTaskDetail('${task.id}', 'proposalTasks')" class="app-link">${task.productId}</a>` : '';

            // Create the edit button
            // const editButton = (isManagerView || task.owner !== currentUser.name) ? '' : `
            //     <button onclick="event.stopPropagation(); openEditProductNameModal('${task.id}', 'proposalTasks')" class="ml-2 text-slate-400 hover:text-indigo-600 transition-colors">
            //         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            //             <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            //         </svg>
            //     </button>
            // `;

            row.innerHTML = ` 
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${productIdHtml}</td> 
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 flex items-center">
                    <span>${task.productName}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${vendorNameHtml}</td> 
                <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="status-badge ${getStatusClass(status)}">${status}</span></td> 
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.owner}</td> 
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.createdDate}</td> 
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${task.createdBy}</td> 
            `; 
            
            row.addEventListener('click', (e) => {
                if (e.target.tagName !== 'A' && !e.target.closest('button')) {
                    currentWipId = task.id; 
                    renderWipDetail('proposalTasks'); // backView is 'proposalTasks'
                    showView('wipDetail');
                }
            });
            tbody.appendChild(row);
        });
    };

    function renderVendorIdentificationDetail(p) {
        const isProposalActionable = !p.isApproved && !p.isRejected && !p.isWithdrawn;
        const canAddDetails = !isManagerView && !p.isRejected && !p.isWithdrawn && p.owner === currentUser.name; // <-- MODIFICATION: Added owner check
        const stageConfig = { title: 'Vendor Identification', btn: 'Add Vendor' };
        let stageData = [...p.vendorIdentification.data];
        stageData.sort((a, b) => b.id - a.id);
        
        // --- BUG FIX START ---
        // const stageStatus = p.vendorIdentification.status; // <-- This was the bug (using old/stale data)
        // Re-calculate the status based on the fresh data we just fetched
        const stageStatus = calculateOverallStageStatus(stageData);
        p.vendorIdentification.status = stageStatus; // Also update the main object
        // --- BUG FIX END ---

        document.getElementById('stage-detail-title').innerHTML = `${stageConfig.title} <span class="status-badge ${getStatusClass(stageStatus)}">${mapStageStatusForDisplay(stageStatus)}</span>`;
        
        const addBtn = document.getElementById('btn-add-stage-entry');
        if (canAddDetails) {
            addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg> ${stageConfig.btn}`;
            addBtn.classList.remove('hidden');
        } else {
            addBtn.classList.add('hidden');
        }

        const contentContainer = document.getElementById('stage-detail-content');
        if (stageData.length === 0) {
            contentContainer.innerHTML = `<p class="text-slate-500">No data added yet.</p>`;
            return;
        }

        const headers = ['Vendor Name', 'Vendor Type', 'Location (State/Country)', 'POC Name', 'POC Mobile No', 'Email ID', 'POC Role', 'Category / Composition Expertise', 'Key Partners/Brands', 'GST No', 'Plant Visit', 'Remarks'];
        const showActionColumn = !isManagerView && !p.isRejected && !p.isWithdrawn && p.owner === currentUser.name; // <-- MODIFICATION: Added owner check

        let tableHtml = `<table class="min-w-full divide-y divide-slate-200 text-sm"> <thead class="bg-slate-50/75"><tr> ${headers.map(h => `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">${h}</th>`).join('')} <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Status</th> ${showActionColumn ? `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Action</th>` : ''} </tr></thead> <tbody class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"> ${stageData.map(row => { const isRowCompleted = row.status === 'Completed'; const location = row.vendorType === 'International' ? row.vendorCountry : row.vendorState; const pocNameHtml = row.pocs?.map(p => p.pocName || '').join('<hr class="my-1 border-slate-100">') || ''; const pocMobileHtml = row.pocs?.map(p => p.pocMobileNo || '').join('<hr class="my-1 border-slate-100">') || ''; const pocEmailHtml = row.pocs?.map(p => p.email || '').join('<hr class="my-1 border-slate-100">') || ''; const pocRoleHtml = row.pocs?.map(p => p.pocRole || '').join('<hr class="my-1 border-slate-100">') || ''; return `<tr> <td class="px-4 py-2 align-top whitespace-nowrap">${row.vendorName || ''}</td> <td class="px-4 py-2 align-top whitespace-nowrap">${row.vendorType || ''}</td> <td class="px-4 py-2 align-top whitespace-nowrap">${location || ''}</td> <td class="px-4 py-2 align-top">${pocNameHtml}</td> <td class="px-4 py-2 align-top">${pocMobileHtml}</td> <td class="px-4 py-2 align-top">${pocEmailHtml}</td> <td class="px-4 py-2 align-top">${pocRoleHtml}</td> <td class="px-4 py-2 align-top whitespace-nowrap">${row.categoryCompositionExpertise || ''}</td> <td class="px-4 py-2 align-top whitespace-nowrap">${row.keyPartnersBrands || ''}</td> <td class="px-4 py-2 align-top whitespace-nowrap">${row.gstNo || ''}</td> <td class="px-4 py-2 align-top whitespace-nowrap">${row.plantVisit || ''}</td> <td class="px-4 py-2 align-top whitespace-normal">${row.remarks || ''}</td> <td class="px-4 py-2 align-top whitespace-nowrap"><span class="status-badge ${getStatusClass(row.status)}">${mapStageStatusForDisplay(row.status)}</span></td> ${showActionColumn ? ` <td class="px-4 py-2 align-top whitespace-nowrap text-right space-x-2"> <button class="app-link text-xs font-semibold ${isRowCompleted ? 'hidden' : ''}" onclick="handleEditStageEntry(${row.id})">Edit</button> <button class="bg-green-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-green-600 transition ${isRowCompleted ? 'hidden' : ''}" onclick="handleSaveEntryStatus(${row.id}, 'Completed')">Completed</button> </td>` : ''} </tr>`; }).join('')} </tbody></table>`;
        
        contentContainer.innerHTML = tableHtml;
        // If user navigated here by clicking a commercial link, scroll and briefly highlight that commercial row
        if (currentStage === 'commercials' && currentCommercialId) {
            setTimeout(() => {
                const elRow = document.getElementById(`commercial-row-${currentCommercialId}`);
                if (elRow) {
                    try { elRow.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(e){}
                    const origBg = elRow.style.backgroundColor;
                    elRow.style.backgroundColor = '#eff6ff'; // light highlight
                    setTimeout(() => { elRow.style.backgroundColor = origBg; }, 1800);
                }
                // clear the marker
                currentCommercialId = null;
            }, 60);
        }
    }

    const renderStageDetail = () => {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p || !currentStage) return;

        calculateProposalStatus(p);

        if (currentStage === 'vendorIdentification') {
            renderVendorIdentificationDetail(p);
            return;
        }

        const isProposalActionable = !p.isApproved && !p.isRejected && !p.isWithdrawn;
        const canAddDetails = !isManagerView && !p.isRejected && !p.isWithdrawn && p.owner === currentUser.name; // <-- MODIFICATION: Added owner check
        const stageConfig = {
            sample: { title: 'Sample Details', btn: 'Add Sample Data' },
            commercials: { title: 'Commercials Details', btn: 'Add Commercials' },
            agreementProposal: { title: 'Agreement (proposal) Details', btn: 'Add Agreement' }
        };
        const config = stageConfig[currentStage];
        const stageData = [...p[currentStage].data];
        stageData.sort((a,b) => b.id - a.id);

        // const stageStatus = p[currentStage].status; // OLD
        // --- MODIFICATION START ---
        let stageStatus;
        if (currentStage === 'agreementProposal') {
            // Special rule: Completed if at least one entry exists
            stageStatus = (stageData.length > 0) ? 'Completed' : 'Pending';
        } else {
            // stageStatus = p[currentStage].status; // <-- This was the bug (using old/stale data)
            
            // --- BUG FIX START ---
            // Re-calculate the status based on the fresh data we just fetched
            stageStatus = calculateOverallStageStatus(stageData);
            p[currentStage].status = stageStatus; // Also update the main object
            // --- BUG FIX END ---
        }
        // --- MODIFICATION END ---

        document.getElementById('stage-detail-title').innerHTML = `${config.title} <span class="status-badge ${getStatusClass(stageStatus)}">${mapStageStatusForDisplay(stageStatus)}</span>`;
        const addBtn = document.getElementById('btn-add-stage-entry');
        if (canAddDetails) {
            addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg> ${config.btn}`;
            addBtn.classList.remove('hidden');
        } else {
            addBtn.classList.add('hidden');
        }
        const contentContainer = document.getElementById('stage-detail-content');
        let tableHtml = `<p class="text-slate-500">No data added yet.</p>`;
        if (stageData.length > 0) {
            if (currentStage === 'commercials') {
                const commercialHeaders = ['Commercial Id', 'Vendor Name', 'Sample', 'Product Variant', 'Product Cost (Per Unit)', 'Logistics Cost (Per Unit)', 'Total Landed Cost (Per Unit)', 'Employee Incentive %', 'Probable SP (Per Unit)', 'Margin', 'Margin %', 'Tentative MRP (Per Unit)', 'MOQ', 'GST %', 'Expected Total Investment', 'Lead Time', 'Advance %', 'Balance Payment', 'Credit Days', 'Remarks'];
                const showActionColumn = !isManagerView && !p.isRejected && !p.isWithdrawn && p.owner === currentUser.name; // <-- MODIFICATION: Added owner check
                tableHtml = `<table class="min-w-full divide-y divide-slate-200 text-sm">
                            <thead class="bg-slate-50/75"><tr>
                                ${commercialHeaders.map(h => `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">${h}</th>`).join('')}
                                <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Commercial Status</th>
                                <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Approval Status</th>
                                ${showActionColumn ? `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Action</th>` : ''}
                            </tr></thead>
                            <tbody class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50">
                                ${stageData.map(row => {
                                    const isRowCompleted = row.status === 'Completed';
                                    // --- MODIFICATION START ---
                                    const isRowRejected = (p.rejectedCommercialIds && p.rejectedCommercialIds.includes(row.id)); 
                                    // --- MODIFICATION END ---
                                    const sampleInfo = p.sample.data.find(s => s.id == row.sampleId);
                                    const sampleText = sampleInfo ? sampleInfo.sampleName : 'N/A';
                                    const creditDaysText = row.balancePaymentType === 'After Dispatch' ? (row.creditDays || '0') : 'N/A';
                                    return `<tr id="commercial-row-${row.id}">
                                        <td class="px-4 py-2 whitespace-nowrap">${row.id || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.vendorName || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${sampleText}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.productVariant || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.productCost || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.logisticsCost || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.totalLandedCost || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.employeeIncentivePercentage || '0'}%</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.probableSP || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.margin || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.marginPercentage || ''}${row.marginPercentage ? '%' : ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.tentativeMRP || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.moq || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.gstPercentage || '0'}%</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.expectedTotalInvestment || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.leadTime || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.advancePercentage || '0'}%</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.balancePaymentType || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${creditDaysText}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.remarks || ''}</td>
                                        <td class="px-4 py-2 whitespace-nowrap"><span class="status-badge ${getStatusClass(row.status)}">${mapStageStatusForDisplay(row.status)}</span></td>
                                        <td class="px-4 py-2 whitespace-nowrap"><span class="status-badge ${isRowRejected ? 'status-rejected' : (p.approvedCommercialIds && p.approvedCommercialIds.includes(row.id)) ? 'status-approved' : 'status-approval-pending'}">${isRowRejected ? 'Rejected' : (p.approvedCommercialIds && p.approvedCommercialIds.includes(row.id)) ? 'Approved' : 'Approval Pending'}</span></td>
                                        ${showActionColumn ? `
                                            <td class="px-4 py-2 whitespace-nowrap text-right space-x-2">
                                                ${(p.approvedCommercialIds && p.approvedCommercialIds.includes(row.id)) ? 
                                                    // Is approved: Show only Clone (hide Edit)
                                                    `<button class="text-blue-600 hover:text-blue-800 text-xs font-semibold" onclick="event.stopPropagation(); handleCloneCommercialEntry(${row.id})">Clone</button>`
                                                    :
                                                    (!isRowRejected ? 
                                                        // Not rejected: Show Edit and Clone
                                                        `<button class="app-link text-xs font-semibold" onclick="event.stopPropagation(); handleEditStageEntry(${row.id})">Edit</button>
                                                         <button class="text-blue-600 hover:text-blue-800 text-xs font-semibold" onclick="event.stopPropagation(); handleCloneCommercialEntry(${row.id})">Clone</button>`
                                                        : 
                                                        // Is rejected: Show only Clone
                                                        `<button class="text-blue-600 hover:text-blue-800 text-xs font-semibold" onclick="event.stopPropagation(); handleCloneCommercialEntry(${row.id})">Clone</button>`
                                                    )
                                                }
                                            </td>` : ''}
                                    </tr>`;
                                }).join('')}
                            </tbody></table>`;
            } else if (currentStage === 'sample') {
                const sampleHeaders = ['Vendor Name', 'Sample Name', 'Received Date', 'Lab Testing Status', 'No. of People Tested On', 'Avg. Rating (Out of 5)', 'Remarks'];
                const sampleHeaderKeys = ['vendorName', 'sampleName', 'receivedDate', 'labTesting', 'testedOn', 'avgRating', 'remarks'];
                const showActionColumn = !isManagerView && !p.isRejected && !p.isWithdrawn && p.owner === currentUser.name; // <-- MODIFICATION: Added owner check
                tableHtml = `<table class="min-w-full divide-y divide-slate-200 text-sm">
                            <thead class="bg-slate-50/75"><tr>
                                ${sampleHeaders.map(h => `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">${h}</th>`).join('')}
                                <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                ${showActionColumn ? `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Action</th>` : ''}
                            </tr></thead>
                            <tbody class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50">
                                ${stageData.map(row => {
                                    const isRowCompleted = row.status === 'Completed';
                                    return `<tr>
                                        ${sampleHeaderKeys.map(key => `<td class="px-4 py-2 whitespace-nowrap">${row[key] || ''}</td>`).join('')}
                                        <td class="px-4 py-2 whitespace-nowrap"><span class="status-badge ${getStatusClass(row.status)}">${mapStageStatusForDisplay(row.status)}</span></td>
                                        ${showActionColumn ? `
                                            <td class="px-4 py-2 whitespace-nowrap text-right space-x-2">
                                                <button class="app-link text-xs font-semibold ${isRowCompleted ? 'hidden' : ''}" onclick="handleEditStageEntry(${row.id})">Edit</button> 
                                                <button class="bg-green-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-green-600 transition ${isRowCompleted ? 'hidden' : ''}" onclick="handleSaveEntryStatus(${row.id}, 'Completed')">Completed</button>
                                            </td>` : ''}
                                    </tr>`;
                                }).join('')}
                            </tbody></table>`;
            }
            else if (currentStage === 'agreementProposal') { // <-- NEW BLOCK
                const agreementHeaders = ['Vendor Name', 'Uploaded File']; // <-- Simplified headers
                const showActionColumn = false; // <-- MODIFICATION: Set to false to hide action column
                tableHtml = `<table class="min-w-full divide-y divide-slate-200 text-sm">
                            <thead class="bg-slate-50/75"><tr>
                                ${agreementHeaders.map(h => `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">${h}</th>`).join('')}
                                <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                ${showActionColumn ? `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Action</th>` : ''}
                            </tr></thead>
                            <tbody class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50">
                                ${stageData.map(row => {
                                    const isRowCompleted = row.status === 'Completed';
                                    // <-- MODIFICATION: Changed back to a downloadable link per user request -->
                                    const uploadHtml = row.upload ? `<a href="data:text/plain;charset=utf-8,${encodeURIComponent('This is a dummy file for ' + row.upload)}" download="${row.upload}" class="app-link font-medium">${row.upload}</a>` : 'N/A';
                                    return `<tr>
                                        <td class="px-4 py-2 whitespace-nowrap">${row.vendorName || 'N/A'}</td>
                                        <td class="px-4 py-2 whitespace-nowrap">${uploadHtml}</td>
                                        <td class="px-4 py-2 whitespace-nowrap"><span class="status-badge ${getStatusClass(row.status)}">${mapStageStatusForDisplay(row.status)}</span></td>
                                        ${showActionColumn ? `
                                            <td class="px-4 py-2 whitespace-nowrap text-right space-x-2">
                                                <button class="app-link text-xs font-semibold ${isRowCompleted ? 'hidden' : ''}" onclick="handleEditStageEntry(${row.id})">Edit</button>
                                                <button class="bg-green-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-green-600 transition ${isRowCompleted ? 'hidden' : ''}" onclick="handleSaveEntryStatus(${row.id}, 'Completed')">Completed</button>
                                            </td>` : ''}
                                    </tr>`;
                                }).join('')}
                            </tbody></table>`;
            }
            else {
                const headers = Object.keys(stageData[0]).filter(key => key !== 'id' && key !== 'vendorId' && key !== 'status');
                const showActionColumn = !isManagerView && !p.isRejected && !p.isWithdrawn && p.owner === currentUser.name; // <-- MODIFICATION: Added owner check
                tableHtml = `<table class="min-w-full divide-y divide-slate-200 text-sm"> <thead class="bg-slate-50/75"><tr> ${headers.map(h => `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">${h.replace(/([A-Z])/g, ' $1').trim()}</th>`).join('')} <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Status</th> ${showActionColumn ? `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Action</th>` : ''} </tr></thead> <tbody class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"> ${stageData.map(row => { const isRowCompleted = row.status === 'Completed'; return `<tr> ${headers.map(h => {
                    let cellValue = row[h] || '';
                    if (h === 'upload' && cellValue) {
                        cellValue = `<a href="data:text/plain;charset=utf-8,${encodeURIComponent('This is a dummy file for ' + cellValue)}" download="${cellValue}" class="app-link font-medium">${cellValue}</a>`;
                    }
                    return `<td class="px-4 py-2 whitespace-nowrap">${cellValue}</td>`;
                }).join('')} <td class="px-4 py-2 whitespace-nowrap"><span class="status-badge ${getStatusClass(row.status)}">${mapStageStatusForDisplay(row.status)}</span></td> ${showActionColumn ? ` <td class="px-4 py-2 whitespace-nowrap text-right space-x-2"> <button class="app-link text-xs font-semibold ${isRowCompleted ? 'hidden' : ''}" onclick="handleEditStageEntry(${row.id})">Edit</button>  <button class="bg-green-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-green-600 transition ${isRowCompleted ? 'hidden' : ''}" onclick="handleSaveEntryStatus(${row.id}, 'Completed')">Completed</button> </td>` : ''} </tr>` }).join('')} </tbody></table>`;
            }
        }
        contentContainer.innerHTML = tableHtml;
    };

    const renderWipDetail = (backView = null) => {
        if (backView) {
            currentWipDetailBackView = backView; // Store the new backView if provided
        }
        const task = wipTasks.find(t => t.id === currentWipId);
        if (!task) return;
        const status = calculateWipStatus(task);

        // --- MODIFICATION START: Add edit button to header ---
        const wipNameEl = document.getElementById('wip-detail-name');
        const editButtonHtml = (!isManagerView && task.owner === currentUser.name && status !== 'Withdrawn') ? `
            <button onclick="openEditProductNameModal('${task.id}', '${currentWipDetailBackView}')" class="ml-3 p-1.5 text-slate-400 hover:text-indigo-600 transition-colors rounded-full hover:bg-indigo-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
            </button>
        ` : '';

        wipNameEl.innerHTML = `
            <span class="flex items-center">
                ${task.productName}
                ${editButtonHtml}
            </span>
        `;
        // --- MODIFICATION END ---

        document.getElementById('wip-detail-vendor').innerText = `Vendor: ${task.vendorName}`;
        document.getElementById('wip-detail-status').innerHTML = `<span class="status-badge ${getStatusClass(status)}">${status}</span>`;
        document.getElementById('wip-detail-info').innerHTML = `
            <div class="text-center">
                <dt class="font-medium text-slate-600">Product ID</dt>
                <dd class="text-slate-500">${task.productId || ''}</dd>
            </div>
            <div class="text-center">
                <dt class="font-medium text-slate-600">Owner</dt>
                <dd class="text-slate-500">${task.owner}</dd>
            </div>
            <div class="text-center">
                <dt class="font-medium text-slate-600">Proposal ID</dt>
                <dd><a href="#" onclick="viewProposalInReadOnly('${task.proposalId}', '${currentWipDetailBackView}')" class="app-link">${task.proposalId}</a></dd>
            </div>
            <div class="text-center">
                <dt class="font-medium text-slate-600">Commercial ID</dt>
                <dd class="text-slate-500">${task.commercialId || ''}</dd>
            </div>
            <div class="text-center">
                <dt class="font-medium text-slate-600">Created By</dt>
                <dd class="text-slate-500">${task.createdBy}</dd>
            </div>
        `;
        
        const backBtn = document.querySelector('#view-wip-detail .back-to-proposal-tasks-btn');
        // Use the stored backView
        switch (currentWipDetailBackView) {
            case 'summary':
                backBtn.textContent = ' Back to Summary';
                backBtn.onclick = () => showView('summary');
                break;
            case 'newProductsList':
                backBtn.textContent = ' Back to New Products List';
                backBtn.onclick = () => showView('newProductsList');
                break;
            case 'approvedProposalDetail':
                backBtn.textContent = ' Back to Proposal Details';
                backBtn.onclick = () => {
                    renderProposalDetail(false, true); // Re-render the approved detail view
                    showView('proposalDetail');
                };
                break;
            case 'proposalTasks':
            default:
                backBtn.textContent = ' Back to Product List';
                backBtn.onclick = () => showView('proposalTasks');
                break;
        }

        const actionsContainer = document.getElementById('wip-detail-actions');
        let actionsHtml = '';
        if (!task.isCancelled && !isManagerView && task.owner === currentUser.name && status !== 'Launched') { // <-- MODIFICATION: Hide withdraw for launched products
            actionsHtml += `<button class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-red-700 transition hover:shadow-md" onclick="handleCancelWipTask('${task.id}')">Withdraw Product</button>`;
        }
        
        // Allow transfer ownership for: (1) Employee who is the owner, or (2) Manager (any product, any owner)
        // but NOT for Launched products
        if (!task.isCancelled && (isManagerView || task.owner === currentUser.name) && status !== 'Launched') {
            actionsHtml += `<button class="bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-slate-600 transition ml-2 hover:shadow-md" onclick="handleTransferWipOwner('${task.id}')">Transfer Ownership</button>`;
        }
        
        // --- MODIFICATION START ---
        if (isManagerView && status === 'Approval Pending') {
            actionsHtml += `<button class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-green-700 transition hover:shadow-md" onclick="handleApproveWipPricing('${task.id}')">Reapprove Product</button>`;
            // actionsHtml += `<button class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-red-700 transition ml-2 hover:shadow-md" onclick="handleRejectWipPricing('${task.id}')">Reject Pricing</button>`;
        }
        // --- MODIFICATION END ---
        
        document.getElementById('wip-detail-actions').innerHTML = actionsHtml;

        const stagesContainer = document.getElementById('wip-stages-container');
        stagesContainer.innerHTML = '';
        const wipStageIcons = { agreement: { icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`, color: 'bg-blue-100 text-blue-600', name: 'Agreement'}, artWork: { icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>`, color: 'bg-purple-100 text-purple-600', name: 'Art Work'}, pricing: { icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>`, color: 'bg-green-100 text-green-600', name: 'Pricing'}, branding: { icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 8v-5z" /></svg>`, color: 'bg-red-100 text-red-600', name: 'Branding'}, vendorKYC: { icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>`, color: 'bg-teal-100 text-teal-600', name: 'Vendor KYC'}, poReleased: { icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>`, color: 'bg-cyan-100 text-cyan-600', name: 'PO Released'}, productionStarted: { icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5V4H4zm0 9h5v5H4v-5zm9-9h5v5h-5V4zm0 9h5v5h-5v-5z" /></svg>`, color: 'bg-slate-100 text-slate-600', name: 'Production Started'}, rawMaterialsProcured: { icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>`, color: 'bg-lime-100 text-lime-600', name: 'Raw Materials Procured'}, packingMaterialProcured: { icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" /></svg>`, color: 'bg-orange-100 text-orange-600', name: 'Packing Materials Procured'}, grn: { icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`, color: 'bg-amber-100 text-amber-600', name: 'GRN'}, };
        
        // --- MODIFIED CODE START ---
        // Define the desired order for the cards
        const stageOrder = [
            'agreement', 
            'artWork', 
            'pricing', 
            'branding', 
            'vendorKYC', 
            'poReleased', 
            'rawMaterialsProcured', // Moved here
            'packingMaterialProcured', 
            'productionStarted', // Now after rawMaterialsProcured
            'grn' 
        ];

        // Iterate through the defined order
        stageOrder.forEach(key => {
            if (!task.stages[key]) return; // Skip if a stage doesn't exist for this task

            const stage = task.stages[key];
        // --- MODIFIED CODE END ---
            const stageMeta = wipStageIcons[key] || { icon: '', color: 'bg-slate-100 text-slate-600', name: key };
            const isYesNoStage = ['productionStarted', 'rawMaterialsProcured', 'packingMaterialProcured'].includes(key);
            let stageStatus; // <-- MODIFICATION: Renamed from 'status'
            let cardClickHandler;

            if (isYesNoStage) {
                const entry = stage.data.length > 0 ? stage.data[0] : { value: 'No' };
                stageStatus = entry.value; // "Yes" or "No" // <-- MODIFICATION: Renamed
                cardClickHandler = `openYesNoModal('${key}')`;
            } else if (key === 'poReleased') {
                stageStatus = stage.data.length > 0 ? 'Yes' : 'Pending'; // <-- MODIFICATION: Renamed
                cardClickHandler = `handleWipStageClick('${key}')`;
            }
            else {
    stageStatus = calculateWipStageOverallStatus(stage, key); // <-- MODIFICATION: Renamed

    if (key === 'grn') {
        // Instead of opening a new page, open a pop-up modal
        cardClickHandler = `openGrnModal('${key}')`;
    } else {
        cardClickHandler = `handleWipStageClick('${key}')`;
    }
}

            const statusClass = getStatusClass(stageStatus); // <-- MODIFICATION: Use stageStatus
            
            // --- MODIFICATION START: Check if task is withdrawn or launched and disable card ---
            // const isTaskDisabled = (status === 'Withdrawn' || status === 'Launched'); // 'status' is the overall task status from top of function
            
            // let finalCardClickHandler = cardClickHandler;
            // let extraCardClasses = 'cursor-pointer hover:shadow-lg transition-all duration-300 hover:-translate-y-1';

            // if (isTaskDisabled) {
            //     finalCardClickHandler = ''; // No click handler
            //     extraCardClasses = 'opacity-50 cursor-not-allowed'; // Disabled styles
            // }
            // --- MODIFICATION END ---

            // --- USER REQUEST MODIFICATION START ---
            // If it's a Yes/No stage and already "Yes", make it non-clickable
            // if (isYesNoStage && stageStatus === 'Yes' && !isTaskDisabled) {
            //     finalCardClickHandler = ''; // No click handler
            //     extraCardClasses = 'opacity-75 cursor-not-allowed'; // Slightly different disabled style to show it's just this one
            // }
            // --- USER REQUEST MODIFICATION END ---

            // --- NEW LOGIC for Change 2 ---
            const isTaskWithdrawn = (status === 'Withdrawn');
            // const isTaskLaunched = (status === 'Launched'); // <-- REMOVED
            const isStageYes = (isYesNoStage && stageStatus === 'Yes');
            // --- ADDED THIS LINE ---
            const isPoReleasedComplete = calculateWipStageOverallStatus(task.stages.poReleased, 'poReleased') === 'Completed';
            // --- MODIFICATION START ---
            const isNotOwner = (!isManagerView && task.owner !== currentUser.name);
            // --- MODIFICATION END ---


            let finalCardClickHandler = cardClickHandler;
            let extraCardClasses = 'cursor-pointer hover:shadow-lg transition-all duration-300 hover:-translate-y-1';
            let isDisabled = false;
            let title = ''; // <-- ADDED for tooltip

            if (isTaskWithdrawn) {
                // Withdrawn tasks disable everything
                finalCardClickHandler = '';
                extraCardClasses = 'opacity-50 cursor-not-allowed';
                isDisabled = true;
            // --- MODIFICATION START ---
            } else if (isNotOwner) { // Check if user is not the owner
                finalCardClickHandler = '';
                extraCardClasses = 'opacity-50 cursor-not-allowed';
                isDisabled = true;
                title = 'You are not the owner of this product.';
            // --- MODIFICATION END ---
            } else if (key === 'grn' && !isPoReleasedComplete) {
                // --- ADDED THIS BLOCK ---
                // Disable GRN if PO is not released
                finalCardClickHandler = '';
                extraCardClasses = 'opacity-50 cursor-not-allowed';
                isDisabled = true;
                title = 'PO Released must be completed first.';
            } else if (isYesNoStage) {
                // It's one of the three special stages
                if (isStageYes) {
                    // It's set to "Yes", so disable it permanently
                    finalCardClickHandler = '';
                    extraCardClasses = 'opacity-75 cursor-not-allowed';
                    isDisabled = true;
                }
                // If it's "No", it remains clickable, even if Launched
                // No changes needed, default classes and handler are correct.
            } 
            /* // <-- REMOVED THIS BLOCK
            else if (isTaskLaunched) {
                // It's NOT one of the special stages (e.g., Agreement, Art Work), 
                // and the task is Launched, so disable it.
                finalCardClickHandler = '';
                extraCardClasses = 'opacity-50 cursor-not-allowed';
                isDisabled = true;
            }
            */
            // --- END NEW LOGIC ---
            
            const cardHtml = `
                <div class="bg-white p-4 rounded-xl border border-slate-200/80 shadow-sm flex flex-col justify-between ${extraCardClasses}" ${isDisabled ? `title="${title}"` : `onclick="${finalCardClickHandler}"`}>
                    <div class="flex items-start space-x-3">
                        <div class="p-2 rounded-lg ${stageMeta.color}">
                            ${stageMeta.icon}
                        </div>
                        <div>
                            <h4 class="font-semibold text-sm text-slate-700">${stageMeta.name}</h4>
                            <span class="status-badge ${statusClass} mt-1 inline-block">${stageStatus}</span> <!-- MODIFICATION: Use stageStatus -->
                        </div>
                    </div>
                </div>
            `;
            stagesContainer.innerHTML += cardHtml;
        });
    };
    
    // --- FORM & MODAL LOGIC ---
    const wipStageForms = {
        agreement: { title: 'Agreement Details', fields: [ { id: 'upload', label: 'Uploaded File', type: 'file', span: 2, required: true }, ] }, // <-- MODIFICATION
        artWork: { title: 'Art Work Details', fields: [ { id: 'upload', label: 'Upload Art', type: 'file', span: 2, required: true }, ] }, // <-- MODIFICATION
        pricing: {
            title: 'Pricing Details',
            fields: [
                { id: 'productCost', label: 'Product Cost (Per Unit)', type: 'number', step: 0.01, required: true },
                { id: 'logisticsCost', label: 'Logistics Cost (Per Unit)', type: 'number', step: 0.01 },
                { id: 'totalLandedCost', label: 'Total Landed Cost (Per Unit)', type: 'text', readonly: true },
                { id: 'tentativeMRP', label: 'Tentative MRP (Per Unit)', type: 'number', step: 0.01, required: true },
                { id: 'probableSP', label: 'Probable SP (Per Unit)', type: 'number', step: 0.01, required: true },
                { id: 'employeeIncentivePercentage', label: 'Employee Incentive %', type: 'number', step: 0.1 },
                { id: 'margin', label: 'Margin', type: 'text', readonly: true },
                { id: 'marginPercentage', label: 'Margin %', type: 'text', readonly: true },
                { id: 'gstPercentage', label: 'GST %', type: 'number', step: 0.1 },
                { id: 'moq', label: 'MOQ', type: 'number' },
                { id: 'expectedTotalInvestment', label: 'Expected Total Investment', type: 'text', readonly: true },
                { id: 'upload', label: 'Upload File', type: 'file', span: 2 }
            ]
        },
        branding: {
            title: 'Branding Details',
            fields: [
                { id: 'brandName', label: 'Brand Name', type: 'text' },
                { id: 'brandingApproved', label: 'Branding Approved', type: 'select', options: ['No', 'Yes'] },
                { id: 'brandLogo', label: 'Upload (Brand Logo)', type: 'file' },
                { id: 'remarks', label: 'Remarks', type: 'textarea', span: 2 },
            ]
        },
        vendorKYC: {
            title: 'Vendor KYC',
            fields: [
                { id: 'vendorid', label: 'Vendor ID', type: 'text', required: true }, // <-- MODIFICATION
                { id: 'vendorName', label: 'Vendor Name', type: 'text', readonly: true },
                { id: 'uploadedDocuments', label: 'Upload', type: 'file' },
            ]
        },
        poReleased: {
            title: 'PO Released Details',
            fields: [
                { id: 'productId', label: 'Select Product', type: 'search-select', required: true },
                { id: 'poId', label: 'Optival Po ID', type: 'text', required: true },
                { id: 'deliveryDate', label: 'PO Approval Date', type: 'date', required: true }, // <-- MODIFICATION: Label changed
                { id: 'tentativeLaunchDate', label: 'Tentative Launch Date', type: 'date', readonly: true, required: true },
                { id: 'unitsOrdered', label: 'Number of units ordered', type: 'number', required: true }
            ]
        },
        productionStarted: { title: 'Production Started' },
        rawMaterialsProcured: { title: 'Raw Materials Procured' },
        packingMaterialProcured: { title: 'Packing Materials Procured' },
        grn: {
            title: 'GRN Details',
            fields: [
                { id: 'optivalGrnId', label: 'Optival GRN Id', type: 'text' },
                { id: 'grnDate', label: 'GRN Date', type: 'date' }
            ]
        }
    };

    const renderWipStageTableView = () => {
        const task = wipTasks.find(t => t.id === currentWipId);
        if (!task || !currentStage) return;
        const config = wipStageForms[currentStage];
        if (!config) return;
        let stageData = [...task.stages[currentStage].data];
        stageData.sort((a,b) => b.id - a.id);
        
        const overallStageStatus = calculateWipStageOverallStatus(task.stages[currentStage], currentStage);
        document.getElementById('wip-stage-detail-title').innerHTML = `${config.title} <span class="status-badge ${getStatusClass(overallStageStatus)}">${mapStageStatusForDisplay(overallStageStatus)}</span>`;
        
        // --- MODIFICATION START ---
        let hideAddButton = isManagerView || task.owner !== currentUser.name; // <-- MODIFICATION: Added owner check
        
        if (currentStage === 'pricing' && stageData.length > 0) {
            hideAddButton = true;
        }
        if (currentStage === 'poReleased' && stageData.length > 0) {
            hideAddButton = true;
        }
        
        // For agreement, we always show the Add button for employees,
        // as it's for product-specific agreements.
        if (currentStage === 'agreement') {
             hideAddButton = isManagerView || task.owner !== currentUser.name; // <-- MODIFICATION: Added owner check
        }
        // --- MODIFICATION END ---

        document.getElementById('btn-add-wip-entry').style.display = hideAddButton ? 'none' : 'block';


        const contentContainer = document.getElementById('wip-stage-detail-content');
        
        // --- MODIFICATION START: SPECIAL RENDERING FOR AGREEMENT STAGE ---
        if (currentStage === 'agreement') {
            const allAgreements = stageData; // Already sorted by id
            const proposalAgreements = allAgreements.filter(a => a.source === 'proposal');
            const productAgreements = allAgreements.filter(a => a.source !== 'proposal'); // Catches 'product' and undefined

            let tableHtml = '';

            // --- Table 1: Proposal Agreements ---
            tableHtml += `<h3 class="text-lg font-semibold text-slate-800 mb-2">Proposal Agreements</h3>`;
            if (proposalAgreements.length === 0) {
                tableHtml += `<div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden"><p class="text-slate-500 text-center py-4">No proposal-level agreements found.</p></div>`;
            } else {
                tableHtml += `<div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden"><table class="min-w-full divide-y divide-slate-200 text-sm">
                                <thead class="bg-slate-50/75"><tr>
                                    <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Uploaded File</th>
                                    <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                </tr></thead>
                                <tbody class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50">`;
                proposalAgreements.forEach(row => {
                    const rowStatus = getWipEntryStatus(row);
                    const fileValue = row['upload'] || '';
                    const cellContent = fileValue ? `<a href="data:text/plain;charset=utf-8,${encodeURIComponent('This is a dummy file for ' + fileValue)}" download="${fileValue}" class="app-link font-medium">${fileValue}</a>` : '';
                    
                    tableHtml += `<tr>
                                    <td class="px-4 py-2 whitespace-nowrap">${cellContent}</td>
                                    <td class="px-4 py-2 whitespace-nowrap"><span class="status-badge ${getStatusClass(rowStatus)}">${mapStageStatusForDisplay(rowStatus)}</span></td>
                                  </tr>`;
                });
                tableHtml += `</tbody></table></div>`;
            }

            // --- Table 2: Product Agreements ---
            tableHtml += `<h3 class="text-lg font-semibold text-slate-800 mt-6 mb-2">Product-Specific Agreements</h3>`;
            
            if (productAgreements.length === 0) {
                tableHtml += `<div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden"><p class="text-slate-500 text-center py-8">No product-specific agreements added yet.</p></div>`;
                contentContainer.innerHTML = tableHtml; // Set content and return
                return; 
            }

            // If we have product agreements, build the table for them
            const fieldIds = config.fields.map(f => f.id).filter(id => id !== 'status' && !id.endsWith('Status'));
            
            // --- MODIFICATION START ---
            // Set to false as requested by user, to hide action column for product agreements.
            let showActionColumn = false; 
            // if (!isManagerView) {
            //     showActionColumn = true; // Employees can edit product agreements
            // }
            // --- MODIFICATION END ---

            tableHtml += `<div class="bg-white rounded-xl border border-slate-200/80 shadow-sm overflow-hidden"><table class="min-w-full divide-y divide-slate-200 text-sm"> <thead class="bg-slate-50/75"><tr> 
                <!-- MODIFICATION START: Hardcoded header to match proposal table -->
                <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Uploaded File</th>
                <!-- MODIFICATION END -->
                <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Status</th> ${showActionColumn ? `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Action</th>` : ''} </tr></thead> <tbody class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50">`;
            
            productAgreements.forEach(row => {
                const rowStatus = getWipEntryStatus(row);
                const isRowCompleted = ['Completed', 'Yes'].includes(rowStatus);
                
                let actionButtons = '';
                if (showActionColumn) { // Only if employee
                    if (isRowCompleted) {
                        actionButtons = `<button class="app-link text-xs font-semibold" onclick="handleEditWipEntry(${row.id})">Edit</button>`;
                    } else {
                        actionButtons = `
                            <button class="app-link text-xs font-semibold" onclick="handleEditWipEntry(${row.id})">Edit</button>
                            <button class="bg-green-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-green-600 transition" onclick="handleWipEntryStatusChange(${row.id}, 'Completed')">Completed</button>
                        `;
                    }
                }

                const cells = fieldIds.map(id => {
                    const fieldConfig = config.fields.find(f => f.id === id);
                    const value = row[id] || '';
                    let cellContent = value;
                    if (fieldConfig && fieldConfig.type === 'file' && value) {
                        cellContent = `<a href="data:text/plain;charset=utf-8,${encodeURIComponent('This is a dummy file for ' + value)}" download="${value}" class="app-link font-medium">${value}</a>`;
                    }
                    return `<td class="px-4 py-2 whitespace-nowrap">${cellContent}</td>`;
                }).join('');

                tableHtml += `<tr> ${cells} <td class="px-4 py-2 whitespace-nowrap"><span class="status-badge ${getStatusClass(rowStatus)}">${mapStageStatusForDisplay(rowStatus)}</span></td> ${showActionColumn ? ` <td class="px-4 py-2 whitespace-nowrap text-right space-x-2"> ${actionButtons} </td>` : ''} </tr>`
            });
            tableHtml += `</tbody></table></div>`;
            contentContainer.innerHTML = tableHtml;
            
            return; // <-- IMPORTANT: Exit function here
        }
        // --- END SPECIAL RENDERING ---

        if (stageData.length === 0) {
            contentContainer.innerHTML = `<p class="text-slate-500 text-center py-8">No details added yet.</p>`;
            return;
        }
        const fieldIds = config.fields.map(f => f.id).filter(id => id !== 'status' && !id.endsWith('Status'));
        
        // --- MODIFICATION START: Updated showActionColumn logic ---
        let showActionColumn = false;
        if (isManagerView) {
            // Manager no longer sees actions for pricing
        } else if (task.owner === currentUser.name) { // <-- MODIFICATION: Added owner check
            // Employee sees actions for everything EXCEPT poReleased
            if (currentStage !== 'poReleased' && currentStage !== 'artWork') { // <-- MODIFICATION
                showActionColumn = true;
            }
        }
        // --- MODIFICATION END ---

        let tableHtml = `<table class="min-w-full divide-y divide-slate-200 text-sm"> <thead class="bg-slate-50/75"><tr> ${fieldIds.map(id => {
            // --- MODIFICATION START ---
            let headerText = id.replace(/([A-Z])/g, ' $1').trim();
            // Custom headers for certain stages
            if (currentStage === 'branding' && id === 'brandLogo') {
                headerText = 'UPLOADED FILE(BRAND LOGO)';
            }
            if (currentStage === 'poReleased') {
                if (id === 'productId') headerText = 'Product';
                if (id === 'poId') headerText = 'OPTIVAL PO ID';
                if (id === 'deliveryDate') headerText = 'PO Approval Date';
            }
            return `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">${headerText}</th>`;
            // --- MODIFICATION END ---
        }).join('')} <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Status</th> ${showActionColumn ? `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Action</th>` : ''} </tr></thead> <tbody class="bg-white divide-y divide-slate-200 [&>tr:nth-child(even)]:bg-slate-50/50"> ${stageData.map(row => {
            const rowStatus = getWipEntryStatus(row);
            const isRowCompleted = ['Completed', 'Yes'].includes(rowStatus);

            let actionButtons = '';
            
            // --- MODIFICATION START ---
            const overallTaskStatus = calculateWipStatus(task); // Get overall task status
            
            if (isManagerView) {
            // --- MODIFICATION END ---
                // Manager View - No actions
            } else {
                // Employee View
                if (currentStage === 'pricing') {
                    
                    // --- MODIFICATION START ---
                    if (overallTaskStatus === 'Launched') {
                         actionButtons = ''; // No actions for pricing if product is launched
                    }
                    // --- MODIFICATION END ---
                    else if (rowStatus === 'WIP') {
                        // If "WIP", show "Edit" and "Completed"
                        actionButtons = `
                            <button class="app-link text-xs font-semibold" onclick="handleEditWipEntry(${row.id})">Edit</button>
                            <button class="bg-green-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-green-600 transition" onclick="handleWipEntryStatusChange(${row.id}, 'Completed')">Completed</button>
                        `;
                    } else if (rowStatus === 'Approval Pending') {
                        // If "Approval Pending", allow edit (which will save as WIP based on file logic)
                        actionButtons = `<button class="app-link text-xs font-semibold" onclick="handleEditWipEntry(${row.id})">Edit</button>`;
                    }
                    // --- MODIFICATION START ---
                    // If rowStatus is 'Completed', allow editing
                    else if (rowStatus === 'Completed') {
                        actionButtons = `<button class="app-link text-xs font-semibold" onclick="handleEditWipEntry(${row.id})">Edit</button>`;
                    }
                    // --- MODIFICATION END ---
                    
                } else {
                    // For other stages (Agreement, Art Work, Branding, KYC, etc.)
                    if (isRowCompleted) {
                        
                        // --- MODIFICATION START ---
                        if (currentStage === 'vendorKYC' || currentStage === 'branding') {
                            // For KYC and Branding, if completed, show no actions.
                            actionButtons = '';
                        } else {
                            // For other stages (like ArtWork, Agreement), allow Edit.
                            actionButtons = `
                                <button class="app-link text-xs font-semibold" onclick="handleEditWipEntry(${row.id})">Edit</button>
                            `;
                        }
                        // --- MODIFICATION END ---

                    } else {
                        // If not completed (e.g., "WIP"), show both buttons
                        actionButtons = `
                            <button class="app-link text-xs font-semibold" onclick="handleEditWipEntry(${row.id})">Edit</button>
                            <button class="bg-green-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-green-600 transition" onclick="handleWipEntryStatusChange(${row.id}, 'Completed')">Completed</button>
                        `;
                    }
                }
            }
            

            const cells = fieldIds.map(id => {
                const fieldConfig = config.fields.find(f => f.id === id);
                const value = row[id] || '';
                let cellContent = value;
                if (fieldConfig && fieldConfig.type === 'file' && value) {
                    cellContent = `<a href="data:text/plain;charset=utf-8,${encodeURIComponent('This is a dummy file for ' + value)}" download="${value}" class="app-link font-medium">${value}</a>`;
                }
                return `<td class="px-4 py-2 whitespace-nowrap">${cellContent}</td>`;
            }).join('');

            return `<tr> ${cells} <td class="px-4 py-2 whitespace-nowrap"><span class="status-badge ${getStatusClass(rowStatus)}">${mapStageStatusForDisplay(rowStatus)}</span></td> ${showActionColumn ? ` <td class="px-4 py-2 whitespace-nowrap text-right space-x-2"> ${actionButtons} </td>` : ''} </tr>`
        }).join('')} </tbody></table>`;
        contentContainer.innerHTML = tableHtml;
    };
    function handleWipStageClick(stageKey) { currentStage = stageKey;
    // --- MODIFICATION START: Auto-fetch and create pricing data if it doesn't exist ---
        if (stageKey === 'pricing') {
            const task = wipTasks.find(t => t.id === currentWipId);
            if (task && task.stages.pricing.data.length === 0) {
                // No pricing data exists, let's create it from commercials
                const proposal = proposals.find(p => p.id === task.proposalId);
                if (proposal) {
                    // --- MODIFICATION START ---
                    // const matchingCommercial = proposal.commercials.data.find(c => 
                    //     task.productName.endsWith('-' + c.productVariant) && 
                    //     proposal.approvedCommercialIds && 
                    //     proposal.approvedCommercialIds.includes(c.id)
                    // );
                    const matchingCommercial = proposal.commercials.data.find(c => c.id === task.commercialId);
                    // --- MODIFICATION END ---
                    
                    if (matchingCommercial) {
                        // We found the commercial data, now create a pricing entry from it
                        const newEntry = {
                            id: Date.now(),
                            productCost: matchingCommercial.productCost,
                            logisticsCost: matchingCommercial.logisticsCost,
                            tentativeMRP: matchingCommercial.tentativeMRP,
                            probableSP: matchingCommercial.probableSP,
                            employeeIncentivePercentage: matchingCommercial.employeeIncentivePercentage,
                            gstPercentage: matchingCommercial.gstPercentage,
                            moq: matchingCommercial.moq,
                            upload: '',
                            status: 'Completed' // <-- MODIFICATION: Was 'WIP'
                        };

                        // Perform calculations
                        const landedCost = (parseFloat(newEntry.productCost) || 0) + (parseFloat(newEntry.logisticsCost) || 0);
                        newEntry.totalLandedCost = landedCost.toFixed(2);
                        
                        const sp = parseFloat(newEntry.probableSP) || 0;
                        const incentive = parseFloat(newEntry.employeeIncentivePercentage) || 0;
                        if (sp > 0 && landedCost > 0) {
                            const incentiveAmount = (incentive / 100) * sp;
                            newEntry.margin = (sp - landedCost - incentiveAmount).toFixed(2);
                            // --- ADDED MARGIN % CALCULATION ---
                            newEntry.marginPercentage = ((parseFloat(newEntry.margin) / sp) * 100).toFixed(2);
                        } else {
                            newEntry.margin = '0.00';
                            // --- ADDED MARGIN % CALCULATION ---
                            newEntry.marginPercentage = '0.00';
                        }
                        
                        const productCost = parseFloat(newEntry.productCost) || 0;
                        const moq = parseFloat(newEntry.moq) || 0;
                        const logisticsCost = parseFloat(newEntry.logisticsCost) || 0;
                        const gst = parseFloat(newEntry.gstPercentage) || 0;
                        if (productCost > 0 && moq > 0) {
                             const totalBaseCost = productCost * moq;
                             const totalLogistics = logisticsCost * moq;
                             const totalGST = totalBaseCost * (gst / 100);
                             newEntry.expectedTotalInvestment = (totalBaseCost + totalLogistics + totalGST).toFixed(2);
                        } else {
                            newEntry.expectedTotalInvestment = '0.00';
                        }
                        
                        // Auto-save this new entry
                        task.stages.pricing.data.push(newEntry);
                    }
                }
            }
        }
        // --- MODIFICATION END ---

    renderWipStageTableView(); showView('wipStageDetail'); }
    
    function openYesNoModal(stageKey) {
        const task = wipTasks.find(t => t.id === currentWipId);
        // --- MODIFICATION START ---
        if (!task || isManagerView || task.owner !== currentUser.name) return; 
        // --- MODIFICATION END ---

        currentStage = stageKey;
        const stage = task.stages[stageKey];
        const config = wipStageForms[stageKey];

        const modal = document.getElementById('yes-no-modal');
        document.getElementById('yes-no-modal-title').innerText = config.title;

        const select = document.getElementById('yesNoSelect');
        const entry = stage.data.length > 0 ? stage.data[0] : { value: 'No' };
        
        // --- USER REQUEST MODIFICATION START ---
        // If the value is already 'Yes', do not open the modal.
        // The click handler in renderWipDetail should already prevent this,
        // but this is a good safeguard.
        if (entry.value === 'Yes') {
            return;
        }
        // --- USER REQUEST MODIFICATION END ---

        select.value = entry.value;

        modal.classList.remove('hidden');
    }

    function openWipStageEntryModal(entryData = null) {
        currentEntryId = entryData ? entryData.id : null;
        const config = wipStageForms[currentStage];
        if (!config) return;
        document.getElementById('wip-stage-entry-modal-title').innerText = (entryData ? 'Edit ' : 'Add ') + config.title;
        const form = document.getElementById('wip-stage-entry-form');
        form.innerHTML = '';
        
        // --- MODIFICATION START: Auto-population logic for Pricing ---
        let commercialData = null;
        if (currentStage === 'pricing' && !entryData) {
            const task = wipTasks.find(t => t.id === currentWipId);
            const proposal = proposals.find(p => p.id === task.proposalId);
            if (proposal) {
                // Find the commercial entry that matches this task's product variant
                // --- MODIFICATION START ---
                // const matchingCommercial = proposal.commercials.data.find(c => 
                //     task.productName.endsWith('-' + c.productVariant) && 
                //     proposal.approvedCommercialIds && 
                //     proposal.approvedCommercialIds.includes(c.id)
                // );
                const matchingCommercial = proposal.commercials.data.find(c => c.id === task.commercialId);
                // --- MODIFICATION END ---
                
                if (matchingCommercial) {
                    commercialData = matchingCommercial;
                }
            }
        }
        // --- MODIFICATION END ---

        config.fields.forEach(field => {
            const colSpan = field.span ? `md:col-span-${field.span}` : '';
            let fieldHtml = '';
            
            // --- MODIFICATION START: Prioritize entryData, then commercialData, then default ---
            let value = null;
            if (entryData) {
                value = entryData[field.id];
            } else if (commercialData) {
                // Map commercial fields to pricing fields
                const fieldMap = {
                    'productCost': commercialData.productCost,
                    'logisticsCost': commercialData.logisticsCost,
                    'tentativeMRP': commercialData.tentativeMRP,
                    'probableSP': commercialData.probableSP,
                    'employeeIncentivePercentage': commercialData.employeeIncentivePercentage,
                    'marginPercentage': commercialData.marginPercentage,
                    'gstPercentage': commercialData.gstPercentage,
                    'moq': commercialData.moq
                };
                value = fieldMap[field.id];
            }
            // --- MODIFICATION END ---
            
            if(currentStage === 'vendorKYC' && !entryData) {
                // --- MODIFICATION START: Removed auto-population ---
                // (Vendor ID and Name are no longer auto-populated on new entry)
                // --- MODIFICATION END ---
            }
            
            let inputElement = '';
            if (field.type === 'textarea') {
                inputElement = `<textarea id="${field.id}" rows="2" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">${value || ''}</textarea>`;
            } else if (field.type === 'select') {
                inputElement = `<select id="${field.id}" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">${field.options.map(o => `<option value="${o}" ${o == value ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
            } else if (field.type === 'file') {
                inputElement = `<div class="flex items-center space-x-2 mt-1"><input type="file" id="${field.id}" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/><span class="text-xs text-slate-500">${value ? `Current: ${value}`: ''}</span></div>`;
            } else if (field.type === 'date') {
                inputElement = `<input type="date" id="${field.id}" value="${formatDateToYYYYMMDD(value)}" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm ${field.readonly ? 'bg-slate-100' : ''}" ${field.readonly ? 'readonly' : ''}>`;
            } else if (field.type === 'search-select') {
                inputElement = `<div class="relative">
                                <input type="search" id="${field.id}" value="${value || ''}" autocomplete="off" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <div id="${field.id}-results" class="absolute z-20 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-40 overflow-y-auto hidden shadow-lg"></div>
                            </div>`;
            } else {
                inputElement = `<input type="${field.type}" id="${field.id}" value="${value || ''}" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm ${field.readonly ? 'bg-slate-100' : ''}" ${field.readonly ? 'readonly' : ''} ${field.step ? `step="${field.step}"`: ''}>`;
            }
            // --- MODIFICATION START: Added required star logic ---
            const requiredStar = field.required ? ' <span class="text-red-500">*</span>' : '';
            fieldHtml = `<div class="${colSpan}"><label for="${field.id}" class="block text-sm font-medium text-slate-700">${field.label}${requiredStar}</label>${inputElement}</div>`;
            // --- MODIFICATION END ---
            form.innerHTML += fieldHtml;
        });
        
        if (currentStage === 'pricing') {
            // --- MODIFICATION START: Update selectors for new fields ---
            const productCostInput = form.querySelector('#productCost');
            const logisticsCostInput = form.querySelector('#logisticsCost');
            const totalLandedCostInput = form.querySelector('#totalLandedCost');
            const tentativeMRPInput = form.querySelector('#tentativeMRP');
            const probableSPInput = form.querySelector('#probableSP');
            const incentiveInput = form.querySelector('#employeeIncentivePercentage');
            const marginInput = form.querySelector('#margin');
            const marginPercentageInput = form.querySelector('#marginPercentage'); // <-- This was already here
            const gstInput = form.querySelector('#gstPercentage');
            const moqInput = form.querySelector('#moq');
            const totalInvestmentInput = form.querySelector('#expectedTotalInvestment');
            // --- MODIFICATION END ---

            // --- MODIFICATION START: Replicate all calculation functions ---
            const calculateLandedCost = () => {
                const productCost = parseFloat(productCostInput.value) || 0;
                const logisticsCost = parseFloat(logisticsCostInput.value) || 0;
                const landedCostPerUnit = productCost + logisticsCost;
                totalLandedCostInput.value = landedCostPerUnit.toFixed(2);
                
                // Chain calculations
                calculateMargin();
                calculateExpectedInvestment();
            };

            const calculateMargin = () => {
                const sp = parseFloat(probableSPInput.value) || 0;
                const landedCost = parseFloat(totalLandedCostInput.value) || 0;
                const incentive = parseFloat(incentiveInput.value) || 0;

                if (sp > 0 && landedCost > 0) {
                    const incentiveAmount = (incentive / 100) * sp;
                    const margin = sp - landedCost - incentiveAmount;
                    marginInput.value = margin.toFixed(2);
                    
                    // --- MODIFICATION START: Calculate and set Margin % ---
                    if (sp > 0) {
                        const marginPercent = (margin / sp) * 100;
                        marginPercentageInput.value = marginPercent.toFixed(2);
                    } else {
                        marginPercentageInput.value = '';
                    }
                    // --- MODIFICATION END ---
                } else {
                    marginInput.value = '';
                    marginPercentageInput.value = ''; // <-- Also clear margin %
                }
            };
            
            const calculateExpectedInvestment = () => {
                const productCost = parseFloat(productCostInput.value) || 0;
                const moq = parseFloat(moqInput.value) || 0;
                const logisticsCost = parseFloat(logisticsCostInput.value) || 0;
                const gst = parseFloat(gstInput.value) || 0;
                
                if (productCost > 0 && moq > 0) {
                     const totalBaseCost = productCost * moq;
                     const totalLogistics = logisticsCost * moq;
                     const totalGST = totalBaseCost * (gst / 100);
                     const investment = totalBaseCost + totalLogistics + totalGST;
                     totalInvestmentInput.value = investment.toFixed(2);
                } else {
                    totalInvestmentInput.value = '';
                }
            };

            // Add event listeners
            [productCostInput, logisticsCostInput].forEach(input => input.addEventListener('input', calculateLandedCost));
            [probableSPInput, incentiveInput].forEach(input => input.addEventListener('input', calculateMargin));
            [moqInput, gstInput].forEach(input => input.addEventListener('input', calculateExpectedInvestment));
            
            // Initial calculation on load
            if(entryData || commercialData) calculateLandedCost();
            // --- MODIFICATION END ---
        }

        // --- MODIFICATION START: Added new logic for Vendor KYC auto-population ---
        if (currentStage === 'vendorKYC') {
            const vendorIdInput = form.querySelector('#vendorid');
            const vendorNameInput = form.querySelector('#vendorName');
            const task = wipTasks.find(t => t.id === currentWipId);

            if (task) {
                const correctVendorName = task.vendorName; // e.g., "Global Pharma"

                // If editing, populate and disable vendor ID
                if (currentEntryId) {
                    const entryData = task.stages.vendorKYC.data.find(e => e.id === currentEntryId);
                    if (entryData) {
                        vendorIdInput.value = entryData.vendorid || '';
                        vendorNameInput.value = entryData.vendorName || '';
                    }
                    vendorIdInput.setAttribute('readonly', true);
                    vendorIdInput.classList.add('bg-slate-100');
                } else {
                    // If creating new, add the listener
                    vendorIdInput.addEventListener('input', () => {
                        // Per user request: "when user enters any 4 didit number"
                        if (vendorIdInput.value.length === 4 && /^\d{4}$/.test(vendorIdInput.value)) {
                            // "populate the vendor name of that product"
                            vendorNameInput.value = correctVendorName;
                        } else {
                            vendorNameInput.value = ''; // Clear if it's not 4 digits
                        }
                    });
                }
            }
        }
        // --- MODIFICATION END ---

        if (currentStage === 'poReleased') {
            const task = wipTasks.find(t => t.id === currentWipId);
            const proposal = proposals.find(p => p.id === task.proposalId);
            
            let leadTime = 0;
            if (task && proposal) {
                // --- OLD LOGIC ---
                // const matchingCommercial = proposal.commercials.data.find(c => 
                //     task.productName.endsWith('-' + c.productVariant) && 
                //     proposal.approvedCommercialIds && 
                //     proposal.approvedCommercialIds.includes(c.id)
                // );
                
                // --- NEW LOGIC ---
                const matchingCommercial = proposal.commercials.data.find(c => c.id === task.commercialId);
                
                if (matchingCommercial && matchingCommercial.leadTime) {
                    leadTime = parseInt(matchingCommercial.leadTime, 10) || 0;
                }
            }

            const deliveryDateInput = form.querySelector('#deliveryDate');
            const launchDateInput = form.querySelector('#tentativeLaunchDate');

            const calculateLaunchDate = () => {
                const deliveryDateValue = deliveryDateInput.value; // YYYY-MM-DD
                if (deliveryDateValue && leadTime > 0) {
                    try {
                        const deliveryDate = new Date(deliveryDateValue + 'T00:00:00'); // Ensure it's treated as local
                        deliveryDate.setDate(deliveryDate.getDate() + leadTime);
                        
                        // Format to YYYY-MM-DD for the input field
                        const year = deliveryDate.getFullYear();
                        const month = String(deliveryDate.getMonth() + 1).padStart(2, '0');
                        const day = String(deliveryDate.getDate()).padStart(2, '0');
                        
                        launchDateInput.value = `${year}-${month}-${day}`;
                    } catch (e) {
                        console.error("Error calculating launch date:", e);
                        launchDateInput.value = '';
                    }
                } else {
                    launchDateInput.value = '';
                }
            };

            deliveryDateInput.addEventListener('input', calculateLaunchDate);
            // Run once on modal load to populate if deliveryDate is already set (on edit)
            calculateLaunchDate();
            
            // --- NEW: Searchable Select for Product ---
            const productInput = form.querySelector('#productId');
            const resultsContainer = form.querySelector('#productId-results');
            // Other inputs should be disabled until a product is selected
            const otherInputs = Array.from(form.querySelectorAll('input, select, textarea')).filter(el => el.id !== 'productId' && el.id !== 'productId-results');

            const enableOtherInputs = () => {
                otherInputs.forEach(el => { el.disabled = false; el.classList.remove('bg-slate-100'); });
            };
            const disableOtherInputs = () => {
                otherInputs.forEach(el => { el.disabled = true; el.classList.add('bg-slate-100'); });
            };

            // If editing and product already present, keep others enabled
            if (currentEntryId) {
                const existing = task.stages.poReleased.data.find(d => d.id === currentEntryId);
                if (existing && existing.productId) {
                    productInput.value = existing.productId;
                    const parts = existing.productId.split(' - ');
                    if (parts.length > 0) productInput.dataset.selectedId = parts[0];
                    enableOtherInputs();
                } else if (task.productId) {
                    productInput.value = task.productId;
                    const parts = task.productId.split(' - ');
                    if (parts.length > 0) productInput.dataset.selectedId = parts[0];
                    enableOtherInputs();
                } else {
                    disableOtherInputs();
                }
            } else {
                // New entry: disable until selection
                disableOtherInputs();
            }

            if (productInput) {
            productInput.addEventListener('input', (e) => {
                const q = (e.target.value || '').trim().toLowerCase();
                if (!q) { resultsContainer.classList.add('hidden'); resultsContainer.innerHTML = ''; return; }
                const matches = dummyProducts.filter(p => p.id.toLowerCase().includes(q) || p.name.toLowerCase().includes(q));
                if (matches.length === 0) {
                    resultsContainer.innerHTML = `<div class="p-2 text-sm text-slate-500">No products found</div>`;
                    resultsContainer.classList.remove('hidden');
                    return;
                }
                resultsContainer.innerHTML = matches.map(p => `<div class="px-3 py-2 hover:bg-slate-100 cursor-pointer" data-id="${p.id}" data-name="${p.name}">${p.id} - ${p.name}</div>`).join('');
                resultsContainer.classList.remove('hidden');
            });
            }

            // Delegate click on results
            if (resultsContainer) {
            resultsContainer.addEventListener('click', (ev) => {
                const target = ev.target.closest('[data-id]');
                if (!target) return;
                const id = target.dataset.id;
                const name = target.dataset.name;
                productInput.value = `${id} - ${name}`;
                productInput.dataset.selectedId = id;
                resultsContainer.classList.add('hidden');
                enableOtherInputs();
            });
            }

            // Hide results when clicking outside
            document.addEventListener('click', function hideProductResults(ev) {
                if (!resultsContainer || !productInput) return;
                if (ev.target === productInput || resultsContainer.contains(ev.target)) return;
                resultsContainer.classList.add('hidden');
            });
            // --- END NEW: Searchable Select ---
        }

        // Set WIP stage modal submit label to 'Save' when editing, 'Add' when creating
        const wipSaveBtn = document.getElementById('save-wip-stage-entry-btn');
        if (wipSaveBtn) wipSaveBtn.textContent = currentEntryId ? 'Save' : 'Add';
        document.getElementById('wip-stage-entry-modal').classList.remove('hidden');
    }
    
    function handleSaveWipStageEntry() {
        const task = wipTasks.find(t => t.id === currentWipId);
        const form = document.getElementById('wip-stage-entry-form');
        const config = wipStageForms[currentStage]; // Get config
        let isValid = true;
        let firstInvalidField = null;

        // --- NEW VALIDATION BLOCK ---
        if (config && config.fields) {
            for (const field of config.fields) {
                if (field.required) {
                    const input = form.querySelector(`#${field.id}`);
                    if (!input) continue;

                    let hasValue = false;
                    if (field.type === 'file') {
                        // For files, 'required' means a new file must be selected OR an old file must already exist (if editing)
                        if (input.files.length > 0) {
                            hasValue = true;
                        } else if (currentEntryId) { // We are editing
                            const existingEntry = task.stages[currentStage].data.find(e => e.id === currentEntryId);
                            if (existingEntry && existingEntry[field.id]) {
                                hasValue = true; // An existing file is present
                            }
                        }
                    } else {
                        // For other inputs
                        if (input.value && input.value.trim() !== '') {
                            hasValue = true;
                        }
                    }

                    // Special validation: For PO Released product selection, ensure selection came from search list
                    if (currentStage === 'poReleased' && field.id === 'productId') {
                        const selectedId = input.dataset && input.dataset.selectedId;
                        const isValidSelection = selectedId && dummyProducts.some(p => p.id === selectedId || `${p.id} - ${p.name}` === input.value);
                        if (!isValidSelection) {
                            hasValue = false;
                        }
                    }

                    if (!hasValue) {
                        isValid = false;
                        if (input.type !== 'file' && !firstInvalidField) { // Don't focus file inputs
                            firstInvalidField = input;
                        }
                        // For non-file inputs:
                        if (input.type !== 'file') {
                            input.classList.add('border-red-500');
                        }
                    } else {
                         if (input.type !== 'file') {
                            input.classList.remove('border-red-500');
                        }
                    }
                }
            }
        }

        if (!isValid) {
            const errorContainer = document.getElementById('wip-stage-entry-error-message');
            errorContainer.textContent = `Please fill all mandatory fields marked with an asterisk (*).`;
            errorContainer.classList.remove('hidden');
            setTimeout(() => {
                errorContainer.classList.add('hidden');
                errorContainer.textContent = '';
            }, 3000); // Hide after 3 seconds

            if (firstInvalidField) {
                firstInvalidField.focus();
            }
            return; // Stop submission
        } else {
            // Clear errors if valid
            const errorContainer = document.getElementById('wip-stage-entry-error-message');
            errorContainer.classList.add('hidden');
            errorContainer.textContent = '';
            form.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
        }
        // --- END NEW VALIDATION BLOCK ---

        const formData = {};
        let fileUploaded = false;
        form.querySelectorAll('input, textarea, select').forEach(input => {
            if (input.type === 'date' && input.value) {
                formData[input.id] = formatDateToDDMMYYYY(input.value);
            } else if (input.type === 'file' && input.files.length > 0) {
                formData[input.id] = input.files[0].name;
                fileUploaded = true;
            } else if (input.type !== 'file') {
                 formData[input.id] = input.value;
            }
        });

        if (currentStage === 'poReleased') {
            formData.status = 'Yes';
            if(formData.productId) {
                // Extract only the product ID (before the ' - ') for the task.productId field
                // but keep the full "ID - Name" in formData for PO Released table display
                const productIdOnly = formData.productId.split(' - ')[0];
                task.productId = productIdOnly; // Product Details page shows only ID
            }
        } else if (['agreement', 'artWork'].includes(currentStage) && fileUploaded) {
            formData.status = 'Completed';
        } 
        
        if (currentEntryId) {
            const entryIndex = task.stages[currentStage].data.findIndex(e => e.id === currentEntryId);
            const existingEntry = task.stages[currentStage].data[entryIndex];
            if (['agreement', 'artWork'].includes(currentStage) && !fileUploaded) {
                formData.upload = existingEntry.upload;
            }
            
            // --- MODIFICATION START ---
            if (currentStage === 'pricing') {
                // Before overwriting, check if we need to store the old data
                
                // --- NEW LOGIC ---
                // If the existing status is 'Completed' and we don't have a backup yet, create one.
                if (existingEntry.status === 'Completed' && !task.stages.pricing.oldData) {
                    // Store a copy of the 'Completed' data before it gets overwritten
                    task.stages.pricing.oldData = { ...existingEntry };
                }
                // --- END NEW LOGIC ---
                
                // When employee saves, KEEP status as 'Completed'
                formData.status = 'Completed'; 
                // Set flag for manager approval
                task.stages.pricing.needsManagerApproval = true;
            }
            // --- MODIFICATION END ---

            task.stages[currentStage].data[entryIndex] = { ...existingEntry, ...formData };
        } else {
            const newId = Date.now();
            const newEntry = { id: newId, ...formData };
             
            // --- MODIFICATION START ---
            if (currentStage === 'pricing') {
                 // When employee adds new, set to Completed
                 newEntry.status = 'Completed';
                 // Do NOT set approval flag, this is the initial auto-population
                 // task.stages.pricing.needsManagerApproval = true; // <-- REMOVED
            } else if (currentStage === 'agreement') {
                newEntry.source = 'product'; // <--- ADDED
                newEntry.status = 'Completed'; // <--- MODIFIED from 'WIP'
            } else if (!newEntry.status && !newEntry.hasOwnProperty('value')) {
            // --- MODIFICATION END ---
                 newEntry.status = 'WIP';
            }
            task.stages[currentStage].data.push(newEntry);
        }
        currentEntryId = null;
        document.getElementById('wip-stage-entry-modal').classList.add('hidden');
        renderWipStageTableView();
        renderWipDetail();
    }

    function handleEditWipEntry(entryId) { const task = wipTasks.find(t => t.id === currentWipId); const entry = task.stages[currentStage].data.find(e => e.id === entryId); openWipStageEntryModal(entry); }
    function handleWipEntryStatusChange(entryId, status) {
        const task = wipTasks.find(t => t.id === currentWipId);
        const entry = task.stages[currentStage].data.find(e => e.id === entryId);
        if (entry) {
            entry.status = status;
            renderWipStageTableView();
            renderWipDetail();
        }
    }
    
    const openStageEntryModal = (entryData = null) => {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;
        const formConfig = {
            vendorIdentification: {
                title: 'Vendor Details',
                fields: [
                    { id: 'vendorName', label: 'Vendor Name', type: 'text', required: true },
                    { id: 'vendorType', label: 'Vendor Type', type: 'select', options: [{value: 'Domestic', text: 'Domestic'}, {value: 'International', text: 'International'}], required: true },
                    { id: 'locationContainer', type: 'placeholder', required: true},
                    { id: 'categoryCompositionExpertise', label: 'Category / Composition Expertise', type: 'textarea', span: 2 },
                    { id: 'keyPartnersBrands', label: 'Key Partners/Brands', type: 'textarea', span: 2 },
                    { id: 'gstNo', label: 'GST No.', type: 'text', required: true },
                    { id: 'plantVisit', label: 'Plant Visit Date', type: 'date' },
                    { id: 'remarks', label: 'Remarks', type: 'textarea', span: 2 },
                ]
            },
            sample: {
                title: 'Sample Details',
                fields: [
                    { id: 'vendorId', label: 'Vendor', type: 'select', options: p.vendorIdentification.data.filter(v => v.status === 'Completed' || v.status === 'WIP').map(v => ({value: v.id, text: v.vendorName})), required: true },
                    { id: 'sampleName', label: 'Sample Name', type: 'text', required: true },
                    { id: 'receivedDate', label: 'Received Date', type: 'date' },
                    { id: 'labTesting', label: 'Lab Testing Status', type: 'select', options: [{value: 'Not Tested', text: 'Not Tested'}, {value: 'Tested & Passed', text: 'Tested & Passed'}, {value: 'Tested & Failed', text: 'Tested & Failed'}] },
                    { id: 'testedOn', label: 'No. of People Tested On', type: 'number' },
                    { id: 'avgRating', label: 'Avg. Rating (Out of 5)', type: 'number', step: 0.1 },
                    { id: 'remarks', label: 'Remarks', type: 'textarea', span: 2 }
                ]
            },
            commercials: {
                title: 'Commercials Details',
                fields: [
                    { id: 'vendorId', label: 'Vendor', type: 'select', options: p.vendorIdentification.data.filter(v => v.status === 'Completed' || v.status === 'WIP').map(v => ({value: v.id, text: v.vendorName})), required: true },
                    { id: 'sampleId', label: 'Sample', type: 'select', options: [], required: true }, // Options populated dynamically
                    { id: 'productVariant', label: 'Product Variant', type: 'text', required: true },
                    { id: 'productCost', label: 'Product Cost (Per Unit)', type: 'number', required: true },
                    { id: 'moq', label: 'MOQ', type: 'number' },
                    { id: 'logisticsCost', label: 'Logistics Cost (Per Unit)', type: 'number' },
                    { id: 'totalLandedCost', label: 'Total Landed Cost (Per Unit)', type: 'number', readonly: true },
                    { id: 'employeeIncentivePercentage', label: 'Employee Incentive %', type: 'number' },
                    { id: 'probableSP', label: 'Probable SP (Per Unit)', type: 'number', required: true },
                    { id: 'margin', label: 'Margin', type: 'number', readonly: true },
                    { id: 'marginPercentage', label: 'Margin %', type: 'number', readonly: true },
                    { id: 'tentativeMRP', label: 'Tentative MRP (Per Unit)', type: 'number', required: true },
                    { id: 'gstPercentage', label: 'GST %', type: 'number', required: true },
                    { id: 'expectedTotalInvestment', label: 'Expected Total Investment', type: 'text', readonly: true },
                    { id: 'leadTime', label: 'Lead Time (days)', type: 'number', required: true },
                    { id: 'paymentTermsGroup', label: 'Payment Terms', type: 'group_placeholder', span: 2 },
                    { id: 'remarks', label: 'Remarks', type: 'textarea', span: 2 },
                ]
            },
            agreementProposal: {
                title: 'Agreement (proposal) Details',
                fields: [
                    { id: 'vendorId', label: 'Vendor', type: 'select', options: p.vendorIdentification.data.filter(v => v.status === 'Completed').map(v => ({value: v.id, text: v.vendorName})), span: 2, required: true },
                    { id: 'upload', label: 'Upload Agreement', type: 'file', span: 2, required: true },
                ]
            },
        };

        const config = formConfig[currentStage];
        if (!config) return;
        document.getElementById('stage-entry-modal-title').innerText = (entryData ? 'Edit ' : 'Add ') + config.title;
        const form = document.getElementById('stage-entry-form');
        form.innerHTML = '';
        
        let baseHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
        config.fields.forEach(field => {
            const colSpan = field.span ? `md:col-span-${field.span}` : '';
            const value = entryData ? entryData[field.id] : '';
            
            let inputHtml = '';
            if (field.type === 'group_placeholder' && field.id === 'paymentTermsGroup') {
                 baseHtml += `
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700">Payment Terms</label>
                        <div class="mt-1 p-4 border border-slate-200 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="advancePercentage" class="block text-sm font-medium text-slate-700">Advance % <span class="text-red-500">*</span></label>
                                <input type="number" id="advancePercentage" value="${(entryData && entryData.advancePercentage)}" min="0" max="100" step="1" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm" required>
                            </div>
                            <div id="balancePaymentContainer">
                                <label for="balancePaymentType" class="block text-sm font-medium text-slate-700">Balance Payment <span class="text-red-500">*</span></label>
                                <select id="balancePaymentType" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                                    <option value="" ${(!entryData || !entryData.balancePaymentType) ? 'selected' : ''}>Select</option>
                                    <option value="Before Dispatch" ${entryData && entryData.balancePaymentType === 'Before Dispatch' ? 'selected' : ''}>Before Dispatch</option>
                                    <option value="After Dispatch" ${entryData && entryData.balancePaymentType === 'After Dispatch' ? 'selected' : ''}>After Dispatch</option>
                                </select>
                            </div>
                            <div id="creditDaysContainer" class="md:col-span-2"></div>
                        </div>
                    </div>
                `;
                return; // Skip default rendering for this group
            }
            if (field.type === 'textarea') {
                inputHtml = `<textarea id="${field.id}" rows="2" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">${value || ''}</textarea>`;
            } else if (field.type === 'file') {
                inputHtml = `<div class="flex items-center space-x-2 mt-1"><input type="file" id="${field.id}" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/><span class="text-xs text-slate-500">${value ? `Current: ${value}`: ''}</span></div>`;
            } else if (field.type === 'date') {
                inputHtml = `<input type="date" id="${field.id}" value="${formatDateToYYYYMMDD(value)}" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">`;
            } else if(field.type === 'search-select') {
                inputHtml = `<div class="relative">
                                <input type="search" id="${field.id}" value="${value || ''}" autocomplete="off" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <div id="${field.id}-results" class="absolute z-20 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-40 overflow-y-auto hidden shadow-lg"></div>
                            </div>`;
            } else if (field.type === 'select') { // <-- THIS BLOCK WAS ADDED
                const optionsHtml = field.options.map(opt => {
                    const optionValue = typeof opt === 'object' ? opt.value : opt;
                    const optionText = typeof opt === 'object' ? opt.text : opt;
                    
                    // --- MODIFICATION START ---
                    let isSelected = false;
                    if (value) { // If value is not empty (i.e., we are editing)
                        isSelected = (optionValue == value);
                    } else if (field.id === 'labTesting' && optionValue === 'Not Tested') { // If new, and it's labTesting, and it's "Not Tested"
                        isSelected = true;
                    } else if (field.id === 'vendorType' && optionValue === 'Domestic') { // If new, and it's vendorType, default to "Domestic"
                        isSelected = true;
                    }
                    // --- MODIFICATION END ---
                    
                    return `<option value="${optionValue}" ${isSelected ? 'selected' : ''}>${optionText}</option>`;
                }).join('');
                
                // --- MODIFICATION START ---
                let selectHtml = '';
                let isDisabled = false;
                let defaultOption = '<option value="">Select...</option>';

                if (field.id === 'vendorId' && currentStage === 'commercials') { // <-- MODIFICATION: Added currentStage check
                    if (field.options.length === 0) {
                        defaultOption = '<option value="">No vendors available to select</option>';
                        isDisabled = true;
                    }
                } else if (field.id === 'sampleId') {
                    // This will be dynamically populated, but set initial state
                    defaultOption = '<option value="">Select Vendor first</option>';
                    isDisabled = true;
                } else if (field.id === 'labTesting' || field.id === 'vendorType') {
                    defaultOption = ''; // Remove "Select..."
                }

                // --- MODIFICATION START ---
                if (currentStage === 'agreementProposal' && field.id === 'vendorId') {
                    if (field.options.length === 0) {
                        defaultOption = '<option value="">No completed vendors available</option>';
                        isDisabled = true;
                    }
                }
                // --- MODIFICATION END ---
                
                selectHtml = `<select id="${field.id}" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm ${isDisabled ? 'bg-slate-100' : ''}" ${isDisabled ? 'disabled' : ''} ${field.required ? 'required' : ''}>`;
                
                selectHtml += defaultOption;
                
                selectHtml += optionsHtml + '</select>';
                inputHtml = selectHtml;
                // --- MODIFICATION END ---
            } else if (field.type === 'placeholder') {
                 // The placeholder div itself is the container for dynamic content (label + input)
                 baseHtml += `<div id="${field.id}" class="${colSpan}"></div>`;
                 return; // Skip the default label/wrapper below
            }
            else {
                inputHtml = `<input type="${field.type}" id="${field.id}" value="${value || ''}" ${field.step ? `step="${field.step}"`: ''} class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm ${field.readonly ? 'bg-slate-100' : ''}" ${field.readonly ? 'readonly' : ''}>`;
            }
            baseHtml += `<div class="${colSpan}"><label for="${field.id}" class="block text-sm font-medium text-slate-700">${field.label}${field.required ? ' <span class="text-red-500">*</span>' : ''}</label>${inputHtml}</div>`;
        });
        baseHtml += `</div>`;
        form.innerHTML = baseHtml;

        if (currentStage === 'commercials') {
            const vendorSelect = form.querySelector('#vendorId');
            const sampleSelect = form.querySelector('#sampleId');
            const balancePaymentSelect = form.querySelector('#balancePaymentType');
            const creditDaysContainer = form.querySelector('#creditDaysContainer');

            // Advance % and Balance Payment visibility/requirement handling
            const advanceInput = form.querySelector('#advancePercentage');
            const balanceContainer = form.querySelector('#balancePaymentContainer');
            const balanceSelect = balancePaymentSelect; // alias

            const updateBalanceVisibility = () => {
                if (!advanceInput || !balanceContainer || !balanceSelect) return;
                let raw = advanceInput.value;
                // If empty, treat as hidden (user requested behavior)
                if (raw === null || raw === undefined || raw === '') {
                    balanceContainer.classList.add('hidden');
                    balanceSelect.removeAttribute('required');
                    balanceSelect.value = '';
                    if (creditDaysContainer) creditDaysContainer.innerHTML = '';
                    return;
                }
                // Clamp numeric input to [0,100]
                const parsed = parseFloat(raw);
                let val = isNaN(parsed) ? NaN : parsed;
                if (!isNaN(val)) {
                    if (val < 0) {
                        val = 0;
                        advanceInput.value = '0';
                    } else if (val > 100) {
                        val = 100;
                        advanceInput.value = '100';
                    }
                } else {
                    // If not a number (shouldn't happen for number input), treat as 0
                    val = 0;
                }
                if (val < 100) {
                    balanceContainer.classList.remove('hidden');
                    balanceSelect.setAttribute('required', '');
                } else {
                    balanceContainer.classList.add('hidden');
                    balanceSelect.removeAttribute('required');
                    balanceSelect.value = '';
                    if (creditDaysContainer) creditDaysContainer.innerHTML = '';
                }
            };

            if (advanceInput) {
                advanceInput.addEventListener('input', updateBalanceVisibility);
                // initialize visibility based on current value (covers add & edit flows)
                updateBalanceVisibility();
            }
            
            // Fields for calculation
            const productCostInput = form.querySelector('#productCost');
            const moqInput = form.querySelector('#moq');
            const logisticsCostInput = form.querySelector('#logisticsCost');
            const landedCostInput = form.querySelector('#totalLandedCost');
            const gstInput = form.querySelector('#gstPercentage');
            const totalInvestmentInput = form.querySelector('#expectedTotalInvestment');

            // New fields for margin calculation
            const incentiveInput = form.querySelector('#employeeIncentivePercentage');
            const spInput = form.querySelector('#probableSP');
            const marginInput = form.querySelector('#margin');
            const marginPercentageInput = form.querySelector('#marginPercentage');

            const calculateMargin = () => {
                const sp = parseFloat(spInput.value) || 0;
                const landedCost = parseFloat(landedCostInput.value) || 0;
                const incentive = parseFloat(incentiveInput.value) || 0;

                if (sp > 0 && landedCost > 0) {
                    const incentiveAmount = (incentive / 100) * sp;
                    const margin = sp - landedCost - incentiveAmount;
                    marginInput.value = margin.toFixed(2);

                    // --- MODIFICATION START: Calculate Margin % ---
                    if (sp > 0) {
                        const marginPercent = (margin / sp) * 100;
                        marginPercentageInput.value = marginPercent.toFixed(2);
                    } else {
                        marginPercentageInput.value = '';
                    }
                    // --- MODIFICATION END ---

                } else {
                    marginInput.value = '';
                    marginPercentageInput.value = ''; // <-- ADDED
                }
            };
            
            const calculateExpectedInvestment = () => {
                const productCost = parseFloat(productCostInput.value) || 0;
                const moq = parseFloat(moqInput.value) || 0;
                const logisticsCost = parseFloat(logisticsCostInput.value) || 0;
                const gst = parseFloat(gstInput.value) || 0;
                
                if (productCost > 0 && moq > 0) {
                     const totalBaseCost = productCost * moq;
                     const totalLogistics = logisticsCost * moq;
                     const totalGST = totalBaseCost * (gst / 100);
                     const investment = totalBaseCost + totalLogistics + totalGST;
                     totalInvestmentInput.value = investment.toFixed(2);
                } else {
                    totalInvestmentInput.value = '';
                }
            };
            
            const calculateLandedCost = () => {
                const productCost = parseFloat(productCostInput.value) || 0;
                const logisticsCost = parseFloat(logisticsCostInput.value) || 0;
                
                const landedCostPerUnit = productCost + logisticsCost;
                landedCostInput.value = landedCostPerUnit.toFixed(2);
                
                // This is a chained calculation, so after updating the per-unit cost,
                // we also need to update the total investment and margin.
                calculateExpectedInvestment();
                calculateMargin();
            };

            [productCostInput, logisticsCostInput].forEach(input => {
                if(input) input.addEventListener('input', calculateLandedCost);
            });
            
            [moqInput, gstInput].forEach(input => {
                if(input) input.addEventListener('input', calculateExpectedInvestment);
            });

            [incentiveInput, spInput].forEach(input => {
                if(input) input.addEventListener('input', calculateMargin);
            });

            const populateSampleDropdown = (selectedVendorId) => {
    // Get samples only for the selected vendor
    const samplesForVendor = p.sample.data.filter(s => s.vendorId == selectedVendorId);

    // Filter based on your rules
    const validSamples = samplesForVendor.filter(s => {
        // 1 Include only samples that are marked as Completed or WIP
        if (s.status !== "Completed" && s.status !== "WIP") return false;

        // 2 Exclude if Lab Testing Status is "Tested & Failed"
        if (s.labTesting === "Tested & Failed") return false;

        // 3 Include if Lab Testing Status is "Tested & Passed" or "Not Tested"
        if (["Tested & Passed", "Not Tested"].includes(s.labTesting)) return true;

        // 4 Include if completed but lab test status is blank
        return !s.labTesting;
    });

    // Reset dropdown
    sampleSelect.innerHTML = ''; // Clear all options

    // Populate only valid samples
    if (validSamples.length > 0) {
        sampleSelect.innerHTML = '<option value="">Select Sample</option>'; // Add default "Select"
        validSamples.forEach(s => {
            const option = document.createElement("option");
            option.value = s.id;
            option.textContent = s.sampleName || `Sample ID: ${s.id}`;
            sampleSelect.appendChild(option);
        });
        sampleSelect.disabled = false; // Enable dropdown
        sampleSelect.classList.remove('bg-slate-100');
    } else {
        sampleSelect.innerHTML = '<option value="">No valid samples found for this vendor</option>';
        sampleSelect.disabled = true; // Disable dropdown
        sampleSelect.classList.add('bg-slate-100');
    }
};
            
            const toggleCreditDays = () => {
                if (balancePaymentSelect.value === 'After Dispatch') {
                    // This now targets the inner container
                    creditDaysContainer.innerHTML = `
                        <div>
                           <label for="creditDays" class="block text-sm font-medium text-slate-700">Credit Days</label>
                           <input type="number" id="creditDays" value="${(entryData && entryData.creditDays) || ''}" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                        </div>
                    `;
                } else {
                    creditDaysContainer.innerHTML = '';
                }
            };

            vendorSelect.addEventListener('change', (e) => populateSampleDropdown(e.target.value));
            balancePaymentSelect.addEventListener('change', toggleCreditDays);

            // Initial population
            populateSampleDropdown(entryData ? entryData.vendorId : vendorSelect.value);
            toggleCreditDays();
            calculateLandedCost(); // This will also trigger other calculations

            // If editing, set the correct sample value
            if (entryData && entryData.sampleId) {
                sampleSelect.value = entryData.sampleId;
            }
        }

        if (currentStage === 'vendorIdentification') {
            const locationContainer = form.querySelector('#locationContainer');
            const vendorTypeSelect = form.querySelector('#vendorType');

            const attachStateSearch = () => {
                const stateSearch = form.querySelector('#vendorState');
                const stateResults = form.querySelector('#vendorState-results');
                if (!stateSearch || !stateResults) return;

                stateSearch.addEventListener('input', () => {
                    const searchTerm = stateSearch.value.toLowerCase();
                    stateResults.innerHTML = '';
                    if (searchTerm.length < 1) {
                        stateResults.classList.add('hidden');
                        return;
                    }
                    const results = indianStatesAndUTs.filter(s => s.toLowerCase().includes(searchTerm));
                    if (results.length > 0) {
                        results.forEach(state => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'p-2 hover:bg-indigo-100 cursor-pointer';
                            resultItem.textContent = state;
                            resultItem.addEventListener('click', () => {
                                stateSearch.value = state;
                                stateResults.classList.add('hidden');
                            });
                            stateResults.appendChild(resultItem);
                        });
                        stateResults.classList.remove('hidden');
                    } else {
                        stateResults.classList.add('hidden');
                    }
                });

                document.addEventListener('click', function(event) {
                    if (!stateSearch.parentElement.contains(event.target)) {
                        stateResults.classList.add('hidden');
                    }
                });
            };

            const attachCountrySearch = () => {
                const countrySearch = form.querySelector('#vendorCountry');
                const countryResults = form.querySelector('#vendorCountry-results');
                if (!countrySearch || !countryResults) return;

                countrySearch.addEventListener('input', () => {
                    const searchTerm = countrySearch.value.toLowerCase();
                    countryResults.innerHTML = '';
                    if (searchTerm.length < 1) {
                        countryResults.classList.add('hidden');
                        return;
                    }
                    const results = countries.filter(c => c.toLowerCase().includes(searchTerm));
                    if (results.length > 0) {
                        results.forEach(country => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'p-2 hover:bg-indigo-100 cursor-pointer';
                            resultItem.textContent = country;
                            resultItem.addEventListener('click', () => {
                                countrySearch.value = country;
                                countryResults.classList.add('hidden');
                            });
                            countryResults.appendChild(resultItem);
                        });
                        countryResults.classList.remove('hidden');
                    } else {
                        countryResults.classList.add('hidden');
                    }
                });

                document.addEventListener('click', function(event) {
                    if (!countrySearch.parentElement.contains(event.target)) {
                        countryResults.classList.add('hidden');
                    }
                });
            };

            const updateLocationFields = (type, currentData) => {
                const stateValue = (currentData && currentData.vendorType !== 'International') ? currentData.vendorState : '';
                const countryValue = (currentData && currentData.vendorType === 'International') ? currentData.vendorCountry : '';

                if (type === 'International') {
                    locationContainer.innerHTML = `
                        <label for="vendorCountry" class="block text-sm font-medium text-slate-700">Vendor Country <span class="text-red-500">*</span></label>
                         <div class="relative">
                            <input type="search" id="vendorCountry" value="${countryValue}" autocomplete="off" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                            <div id="vendorCountry-results" class="absolute z-20 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-40 overflow-y-auto hidden shadow-lg"></div>
                        </div>
                    `;
                    attachCountrySearch();
                } else { // Domestic
                    locationContainer.innerHTML = `
                        <label for="vendorState" class="block text-sm font-medium text-slate-700">Vendor State <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="search" id="vendorState" value="${stateValue}" autocomplete="off" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
                            <div id="vendorState-results" class="absolute z-20 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-40 overflow-y-auto hidden shadow-lg"></div>
                        </div>
                    `;
                    attachStateSearch();
                }
            };

            vendorTypeSelect.addEventListener('change', (e) => updateLocationFields(e.target.value, null));

            // Initial population
            updateLocationFields(entryData ? entryData.vendorType : vendorTypeSelect.value, entryData);
            
            const pocSection = document.createElement('div');
            pocSection.className = 'mt-4 pt-4 border-t border-slate-200';
            pocSection.innerHTML = `
                <h3 class="text-lg font-medium text-slate-800 mb-2">POC Details</h3>
                <div id="pocs-container" class="space-y-4"></div>
                <button type="button" id="add-poc-btn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-semibold">+ Add another POC</button>
            `;
            form.appendChild(pocSection);
            
            const pocs = entryData ? entryData.pocs : [{}];
            pocs.forEach((poc, index) => addPocFields(poc, index === 0));

            document.getElementById('add-poc-btn').addEventListener('click', () => addPocFields({}, false));
        }

        // Set Stage entry modal submit label to 'Save' when editing, 'Add' when creating
        const stageSaveBtn = document.getElementById('save-stage-entry-btn');
        if (stageSaveBtn) stageSaveBtn.textContent = currentEntryId ? 'Save' : 'Add';
        document.getElementById('stage-entry-modal').classList.remove('hidden');
    };

    function addPocFields(pocData = {}, isFirst = false) {
        const container = document.getElementById('pocs-container');
        const pocGroup = document.createElement('div');
        pocGroup.className = 'poc-entry grid grid-cols-1 md:grid-cols-2 gap-4 border-b border-slate-200 pb-4 relative';
        
        // --- MODIFICATION START ---
        const nameStar = '<span class="text-red-500">*</span>'; // Always required
        const otherStar = isFirst ? '<span class="text-red-500">*</span>' : ''; // Required only for first

        pocGroup.innerHTML = `
            <div>
                <label class="block text-sm font-medium text-slate-700">POC Name ${nameStar}</label>
                <input type="text" data-poc-field="pocName" value="${pocData.pocName || ''}" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700">POC Mobile No. ${otherStar}</label>
                <input type="tel" data-poc-field="pocMobileNo" value="${pocData.pocMobileNo || ''}" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700">E-mail ID ${otherStar}</label>
                <input type="email" data-poc-field="email" value="${pocData.email || ''}" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700">POC Role ${otherStar}</label>
                <input type="text" data-poc-field="pocRole" value="${pocData.pocRole || ''}" class="mt-1 block w-full border-slate-300 rounded-lg shadow-sm">
            </div>
        `;
        // --- MODIFICATION END ---
        
        if (!isFirst) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'absolute top-0 right-0 text-red-500 hover:text-red-700 font-bold text-xl';
            removeBtn.onclick = () => pocGroup.remove();
            pocGroup.appendChild(removeBtn);
        }

        container.appendChild(pocGroup);
    }
    
    const handleSaveStageEntry = () => {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;
        const form = document.getElementById('stage-entry-form');
        const errorContainer = document.getElementById('stage-entry-error-message');
        
        // Clear previous errors
        errorContainer.classList.add('hidden');
        errorContainer.textContent = '';
        form.querySelectorAll('.border-red-500').forEach(el => {
            el.classList.remove('border-red-500');
        });

        // --- MODIFICATION START: Add validation for Sample stage ---
        if (currentStage === 'sample') {
            const vendorInput = form.querySelector('#vendorId');
            const sampleNameInput = form.querySelector('#sampleName');
            let isValid = true;
            let firstInvalidField = null;

            // Check vendor input: must have a value AND not be disabled
            if (!vendorInput.value || vendorInput.disabled) {
                vendorInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = vendorInput;
                isValid = false;
            }

            // Check sample name input: must not be empty
            if (!sampleNameInput.value.trim()) {
                sampleNameInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = sampleNameInput;
                isValid = false;
            }

            if (!isValid) {
                errorContainer.textContent = `Please fill all mandatory fields marked with an asterisk (*).`;
                errorContainer.classList.remove('hidden');
                setTimeout(() => {
                    errorContainer.classList.add('hidden');
                    errorContainer.textContent = '';
                }, 3000); // Hide after 3 seconds
                if(firstInvalidField) firstInvalidField.focus();
                return; // Stop the function
            }
        }
        // --- MODIFICATION END ---

        // --- MODIFICATION START: Add validation for Product Variant ---
        if (currentStage === 'commercials') {
            const productVariantInput = form.querySelector('#productVariant');
            const vendorInput = form.querySelector('#vendorId');
            const sampleInput = form.querySelector('#sampleId');
            const leadTimeInput = form.querySelector('#leadTime');
            const productCostInput = form.querySelector('#productCost');
            const probableSPInput = form.querySelector('#probableSP');
            const tentativeMRPInput = form.querySelector('#tentativeMRP');
            const gstPercentageInput = form.querySelector('#gstPercentage');
            const advancePercentageInput = form.querySelector('#advancePercentage');
            
            let isValid = true;
            let firstInvalidField = null;

            if (!productVariantInput.value.trim()) {
                productVariantInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = productVariantInput;
                isValid = false;
            }
            if (!vendorInput.value) {
                vendorInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = vendorInput;
                isValid = false;
            }
            if (!sampleInput.value) {
                sampleInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = sampleInput;
                isValid = false;
            }
            if (!leadTimeInput.value.trim()) {
                leadTimeInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = leadTimeInput;
                isValid = false;
            }
            // Validate new mandatory fields
            if (!productCostInput.value.trim()) {
                productCostInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = productCostInput;
                isValid = false;
            }
            if (!probableSPInput.value.trim()) {
                probableSPInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = probableSPInput;
                isValid = false;
            }
            if (!tentativeMRPInput.value.trim()) {
                tentativeMRPInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = tentativeMRPInput;
                isValid = false;
            }
            if (!gstPercentageInput.value.trim()) {
                gstPercentageInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = gstPercentageInput;
                isValid = false;
            }
            if (!advancePercentageInput.value.trim() && advancePercentageInput.value !== '0') {
                advancePercentageInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = advancePercentageInput;
                isValid = false;
            }

            // If balance payment field is visible, it must have a selected value
            const balanceContainerCheck = form.querySelector('#balancePaymentContainer');
            const balanceSelectCheck = form.querySelector('#balancePaymentType');
            if (balanceContainerCheck && !balanceContainerCheck.classList.contains('hidden')) {
                if (!balanceSelectCheck || !balanceSelectCheck.value) {
                    if (balanceSelectCheck) balanceSelectCheck.classList.add('border-red-500');
                    if (!firstInvalidField) firstInvalidField = balanceSelectCheck || null;
                    isValid = false;
                }
            }

            if (!isValid) {
                errorContainer.textContent = `Please fill all mandatory fields marked with an asterisk (*).`;
                errorContainer.classList.remove('hidden');
                setTimeout(() => {
                    errorContainer.classList.add('hidden');
                    errorContainer.textContent = '';
                }, 3000); // Hide after 3 seconds
                if(firstInvalidField) firstInvalidField.focus();
                return;
            }
        }

        // --- MODIFICATION START: Add validation for Agreement (proposal) ---
        if (currentStage === 'agreementProposal') {
            const vendorInput = form.querySelector('#vendorId');
            const uploadInput = form.querySelector('#upload');
            
            let isValid = true;
            let firstInvalidField = null;

            if (!vendorInput.value || vendorInput.disabled) {
                vendorInput.classList.add('border-red-500');
                if (!firstInvalidField) firstInvalidField = vendorInput;
                isValid = false;
            }
            
            // For files, 'required' means a new file must be selected OR an old file must already exist (if editing)
            let fileHasValue = false;
            if (uploadInput.files.length > 0) {
                fileHasValue = true;
            } else if (currentEntryId) { // We are editing
                const existingEntry = p[currentStage].data.find(e => e.id === currentEntryId);
                if (existingEntry && existingEntry.upload) {
                    fileHasValue = true; // An existing file is present
                }
            }
            
            if (!fileHasValue) {
                // Cant highlight file input well, but can show error
                if (!firstInvalidField) firstInvalidField = uploadInput; // It won't be focused, but good to have
                isValid = false;
            }

            if (!isValid) {
                errorContainer.textContent = `Please fill all mandatory fields marked with an asterisk (*).`;
                errorContainer.classList.remove('hidden');
                setTimeout(() => {
                    errorContainer.classList.add('hidden');
                    errorContainer.textContent = '';
                }, 3000); // Hide after 3 seconds
                if(firstInvalidField && firstInvalidField.type !== 'file') firstInvalidField.focus();
                return;
            }
        }
        // --- MODIFICATION END ---

        if (currentStage === 'vendorIdentification') {
            let isValid = true;
            let firstInvalidField = null;
            let specificErrorMessage = ''; // Track specific error messages

            const highlightError = (el) => {
                if (el) {
                    el.classList.add('border-red-500');
                    if (!firstInvalidField) {
                        firstInvalidField = el;
                    }
                }
                isValid = false;
            };
            
            const vendorName = form.querySelector('#vendorName');
            if (!vendorName.value.trim()) highlightError(vendorName);
            
            const vendorType = form.querySelector('#vendorType').value;
            if (vendorType === 'Domestic') {
                const state = form.querySelector('#vendorState');
                if (!state.value.trim()) highlightError(state);
            } else if (vendorType === 'International') {
                const country = form.querySelector('#vendorCountry');
                if (!country.value.trim()) highlightError(country);
            }

            const gstNo = form.querySelector('#gstNo');
            if (!gstNo.value.trim()) highlightError(gstNo);

            // --- MODIFICATION START: Replace POC validation logic ---
            const pocEntries = form.querySelectorAll('.poc-entry');
            if (pocEntries.length === 0) {
                 // This case should not happen as one is added by default, but as a safeguard:
                 isValid = false; 
                 // We can't highlight a field, but the main error message will show.
            } else {
                 pocEntries.forEach((pocEntry, index) => {
                    const pocNameInput = pocEntry.querySelector('[data-poc-field="pocName"]');
                    const pocMobileInput = pocEntry.querySelector('[data-poc-field="pocMobileNo"]');
                    const pocEmailInput = pocEntry.querySelector('[data-poc-field="email"]');
                    const pocRoleInput = pocEntry.querySelector('[data-poc-field="pocRole"]');
                    
                    if (index === 0) {
                        // First POC - all fields are required
                        if (!pocNameInput.value.trim()) highlightError(pocNameInput);
                        
                        // Mobile number validation
                        if (!pocMobileInput.value.trim()) {
                            highlightError(pocMobileInput);
                        } else if (!isValidPhoneNumber(pocMobileInput.value)) {
                            highlightError(pocMobileInput);
                            specificErrorMessage = `Invalid POC Mobile No. format. Please use a valid phone number (10 digits or with country code).`;
                        }
                        
                        // Email validation
                        if (!pocEmailInput.value.trim()) {
                            highlightError(pocEmailInput);
                        } else if (!isValidEmail(pocEmailInput.value)) {
                            highlightError(pocEmailInput);
                            if (!specificErrorMessage) { // Only set if no previous error
                                specificErrorMessage = `Invalid E-mail ID format. Please use a valid email address (e.g., name@domain.com).`;
                            }
                        }
                        
                        if (!pocRoleInput.value.trim()) highlightError(pocRoleInput);

                    } else {
                        // Subsequent POCs
                        const hasOtherData = pocMobileInput.value.trim() || 
                                             pocEmailInput.value.trim() || 
                                             pocRoleInput.value.trim();
                        
                        if (hasOtherData && !pocNameInput.value.trim()) {
                            // If the user started filling out other fields but not the name, it's an error
                            highlightError(pocNameInput);
                        }
                        
                        // If POC name is filled, validate other fields if provided
                        if (pocNameInput.value.trim()) {
                            if (pocMobileInput.value.trim() && !isValidPhoneNumber(pocMobileInput.value)) {
                                highlightError(pocMobileInput);
                                specificErrorMessage = `Invalid POC Mobile No. format. Please use a valid phone number (10 digits or with country code).`;
                            }
                            if (pocEmailInput.value.trim() && !isValidEmail(pocEmailInput.value)) {
                                highlightError(pocEmailInput);
                                if (!specificErrorMessage) { // Only set if no previous error
                                    specificErrorMessage = `Invalid E-mail ID format. Please use a valid email address (e.g., name@domain.com).`;
                                }
                            }
                        }
                        // If all fields (including name) are blank, it's fine, it will be skipped on save.
                    }
                });
            }
            // --- MODIFICATION END ---

            if (!isValid) {
                // Use specific error message if available, otherwise use generic message
                const finalErrorMessage = specificErrorMessage || `Please fill all mandatory fields marked with an asterisk (*).`;
                errorContainer.textContent = finalErrorMessage;
                errorContainer.classList.remove('hidden');
                setTimeout(() => {
                    errorContainer.classList.add('hidden');
                    errorContainer.textContent = '';
                }, 3000); // Hide after 3 seconds
                if (firstInvalidField) {
                    firstInvalidField.focus();
                }
                return;
            }
        }
        
        const formData = {};

        if (currentStage === 'vendorIdentification') {
            const baseFieldIds = ['vendorName', 'vendorType', 'categoryCompositionExpertise', 'keyPartnersBrands', 'gstNo', 'plantVisit', 'remarks'];
            baseFieldIds.forEach(id => {
                const input = form.querySelector(`#${id}`);
                if (input) {
                    formData[id] = (input.type === 'date' && input.value) ? formatDateToDDMMYYYY(input.value) : input.value;
                }
            });
            
            if (formData.vendorType === 'International') {
                const countryInput = form.querySelector('#vendorCountry');
                if (countryInput) formData.vendorCountry = countryInput.value;
                delete formData.vendorState;
            } else {
                const stateInput = form.querySelector('#vendorState');
                if (stateInput) formData.vendorState = stateInput.value;
                delete formData.vendorCountry;
            }

            const pocs = [];
            document.querySelectorAll('.poc-entry').forEach(pocGroup => {
                const pocNameInput = pocGroup.querySelector('[data-poc-field="pocName"]');
                if (pocNameInput && pocNameInput.value.trim() !== '') {
                     pocs.push({
                        pocName: pocNameInput.value,
                        pocMobileNo: pocGroup.querySelector('[data-poc-field="pocMobileNo"]').value,
                        email: pocGroup.querySelector('[data-poc-field="email"]').value,
                        pocRole: pocGroup.querySelector('[data-poc-field="pocRole"]').value
                    });
                }
            });
            if (pocs.length === 0) {
                // This check is now primarily a fallback, as validation should prevent this.
                alert('At least one POC with a name is mandatory.');
                return;
            }
            formData.pocs = pocs;
        } else {
            form.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.type === 'date' && input.value) {
                    formData[input.id] = formatDateToDDMMYYYY(input.value);
                } else if (input.type === 'file' && input.files.length > 0) {
                    formData[input.id] = input.files[0].name; // This gets just the filename
                } else if (input.type !== 'file') { 
                    formData[input.id] = input.value;
                }
            });
        }
        
        if (currentEntryId) {
            const entryIndex = p[currentStage].data.findIndex(e => e.id === currentEntryId);
            if (entryIndex > -1) {
                const existingEntry = p[currentStage].data[entryIndex];
                
                // --- MODIFICATION START ---
                const oldUpload = existingEntry.upload; // <-- CAPTURE OLD FILENAME

                // Handle file upload: if no new file is selected, keep the old one
                if (form.querySelector(`#upload`) && form.querySelector(`#upload`).type === 'file' && !form.querySelector(`#upload`).files[0]) {
                    formData.upload = existingEntry.upload;
                }
                // --- MODIFICATION END ---

                p[currentStage].data[entryIndex] = { ...existingEntry, ...formData };
                if (currentStage === 'agreementProposal') { // <--- ADD THIS BLOCK
                    p[currentStage].data[entryIndex].source = 'proposal';
                }
                if (['sample', 'commercials', 'agreementProposal'].includes(currentStage)) {
                    const vendor = p.vendorIdentification.data.find(v => v.id == formData.vendorId);
                    p[currentStage].data[entryIndex].vendorName = vendor ? vendor.vendorName : 'N/A';
                }

                // --- NEW LOGIC FOR EDITS (PROPAGATION) ---
                if (currentStage === 'agreementProposal') {
                    const newUpload = formData.upload;
                    // --- MODIFICATION START: Get the new vendorId ---
                    const newVendorId = formData.vendorId; 
                    // --- MODIFICATION END ---

                    // Check if the file has actually changed
                    if (newUpload && oldUpload !== newUpload) {
                        const tasksForProposal = wipTasks.filter(task => task.proposalId === currentProposalId);
                        tasksForProposal.forEach(task => {
                            if (!task.stages.agreement) task.stages.agreement = { data: [] };
                            
                            // Find and remove the old agreement entry, if it exists
                            if(oldUpload) {
                                const oldEntryIndex = task.stages.agreement.data.findIndex(entry => entry.upload === oldUpload && entry.source === 'proposal'); // <--- CHECK SOURCE
                                if (oldEntryIndex > -1) {
                                    task.stages.agreement.data.splice(oldEntryIndex, 1);
                                }
                            }

                            // --- MODIFICATION START: Only add to tasks with matching vendor AND owner ---
                            if (task.vendorId == newVendorId && task.owner === currentUser.name) { // <-- MODIFIED THIS LINE
                                const newAgreementExists = task.stages.agreement.data.some(entry => entry.upload === newUpload && entry.source === 'proposal'); // <--- CHECK SOURCE
                                if (!newAgreementExists) {
                                    task.stages.agreement.data.push({
                                        id: Date.now() + Math.random(),
                                        upload: newUpload,
                                        status: 'Completed',
                                        source: 'proposal' // <--- ADDED SOURCE
                                    });
                                }
                            }
                            // --- MODIFICATION END ---
                        });
                    }
                }
                // --- END NEW LOGIC FOR EDITS ---
            }
        } else {
            // const newStatus = currentStage === 'commercials' ? 'Completed' : 'WIP'; // OLD
            let newStatus;
            if (currentStage === 'commercials') {
                newStatus = 'Completed';
            } else if (currentStage === 'agreementProposal') {
                newStatus = 'Completed'; // New agreements are 'Completed' by default
            } else {
                newStatus = 'WIP';
            }
            const newEntry = { id: Date.now(), status: newStatus, ...formData };
            if (currentStage === 'agreementProposal') { // <--- ADD THIS BLOCK
                newEntry.source = 'proposal';
            }
            if (['sample', 'commercials', 'agreementProposal'].includes(currentStage)) {
                const vendor = p.vendorIdentification.data.find(v => v.id == newEntry.vendorId);
                newEntry.vendorName = vendor ? vendor.vendorName : 'N/A';
            }
            p[currentStage].data.push(newEntry);

            // --- NEW LOGIC FOR NEW ENTRIES (PROPAGATION) ---
            if (currentStage === 'agreementProposal') {
                const agreementFile = newEntry.upload;
                // --- MODIFICATION START: Get vendorId ---
                const vendorId = newEntry.vendorId; 
                // --- MODIFICATION END ---

                if (agreementFile) { // Only proceed if a file was actually uploaded
                    // Find all associated WIP tasks
                    const tasksForProposal = wipTasks.filter(task => task.proposalId === currentProposalId);
                    tasksForProposal.forEach(task => {
                        // --- MODIFICATION START: Check vendorId and owner match ---
                        if (task.vendorId == vendorId && task.owner === currentUser.name) { // <-- MODIFIED THIS LINE
                        // --- MODIFICATION END ---
                            // Ensure the agreement stage data array exists
                            if (!task.stages.agreement) task.stages.agreement = { data: [] };
                            // Check if this specific agreement file is already listed
                            const agreementExists = task.stages.agreement.data.some(entry => entry.upload === agreementFile && entry.source === 'proposal'); // <--- CHECK SOURCE
                            if (!agreementExists) {
                                // Add the new agreement entry to the product's stage
                                task.stages.agreement.data.push({
                                    id: Date.now() + Math.random(), // Ensure unique ID
                                    upload: agreementFile,
                                    status: 'Completed',
                                    source: 'proposal' // <--- ADDED SOURCE
                                });
                            }
                        }
                    });
                }
            }
            // --- END NEW LOGIC FOR NEW ENTRIES ---
        }
        
        currentEntryId = null;
        document.getElementById('stage-entry-modal').classList.add('hidden');
        renderStageDetail();
        renderProposalDetail(false, contextIsFromApprovedTab);
    };


    function handleEditStageEntry(entryId) { const p = proposals.find(prop => prop.id === currentProposalId); const entry = p[currentStage].data.find(e => e.id === entryId); if (entry) { currentEntryId = entryId; openStageEntryModal(entry); } }
    
    function handleCloneCommercialEntry(entryId) {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;

        const entryToClone = p.commercials.data.find(e => e.id === entryId);
        if (!entryToClone) return;

        // Create a copy
        const newEntry = { ...entryToClone };

        // Modify for the new entry
        // --- MODIFICATION START: Do not set ID or status, let save handler do it ---
        delete newEntry.id; // No ID, so save handler knows it's new
        delete newEntry.status; // Status will be set on save
        // --- MODIFICATION END ---
        
        // newEntry.sampleId = ''; // <-- MODIFICATION: REMOVED this line to keep the sampleId
        newEntry.productVariant = ``; // Clear the product variant so it can be edited

        // --- MODIFICATION START: Do not push to data, just open modal ---
        // p.commercials.data.push(newEntry); // <-- REMOVED
        
        // Set this as the new "current entry" for the modal
        currentEntryId = null; // <-- Ensure it's null for a new entry

        // Refresh the table
        // renderStageDetail(); // <-- REMOVED (nothing to render yet)

        // Immediately open the modal for editing the new clone
        openStageEntryModal(newEntry); // <-- Pass cloned data to pre-fill
        // --- MODIFICATION END ---
    }

    // --- EVENT HANDLERS ---
    function handleRoleChange(e) {
        isManagerView = e.target.value === 'Manager';
        
        // --- MODIFICATION START ---
        // const userSelectorContainer = document.getElementById('user-selector-container'); // Removed
        if (isManagerView) {
            // userSelectorContainer.classList.add('hidden'); // Removed
            // Manager view is active, no specific user needed, logic relies on isManagerView flag
        } else {
            // userSelectorContainer.classList.remove('hidden'); // Removed
            // Set current user to Alice when "Employee" is selected
            currentUser = dummyEmployees.find(emp => emp.name === 'Alice') || dummyEmployees[0];
        }
        // --- MODIFICATION END ---

        // Refresh the currently active main view to reflect the role change
        const activeTab = document.querySelector('.tab-btn.tab-active');
        if (activeTab) {
            switch (activeTab.id) {
                case 'tab-proposals':
                    renderProposalsTable();
                    renderApprovedProposalsTable(); // <-- ADDED
                    break;
                case 'tab-new-products':
                    renderNewProductsList();
                    break;
                case 'tab-summary':
                default:
                    renderSummaryTable();
                    break;
            }
        } else {
            // Default to summary if no tab is somehow active
            renderSummaryTable();
        }

        // Also re-render any detail/sub-view that might be open, as permissions/actions might change
        if (views.proposalDetail.classList.contains('view-active')) renderProposalDetail(false, contextIsFromApprovedTab);
        if (views.stageDetail.classList.contains('view-active')) renderStageDetail();
        if (views.wipDetail.classList.contains('view-active')) renderWipDetail();
        if (views.wipStageDetail.classList.contains('view-active')) renderWipStageTableView();
        // if (views.proposalTasks.classList.contains('view-active')) renderProposalTasksView(); // This view seems to be part of a different flow

        // Show/hide Create Proposal button for manager vs employee
        const createProposalBtn = document.getElementById('btn-create-proposal');
        if (createProposalBtn) {
            createProposalBtn.style.display = isManagerView ? 'none' : '';
        }
    }
    function handleTabClick(e) { 
        const targetButton = e.currentTarget; // <-- Use currentTarget
        const targetId = targetButton.id; // <-- Use currentTarget's id

        // Get all tab buttons *inside the sidebar*
        const allTabButtons = document.getElementById('main-sidebar').querySelectorAll('.tab-btn');
        
        // Deactivate all buttons
        allTabButtons.forEach(tab => { 
            tab.classList.remove('tab-active'); 
        }); 
        
        // Activate the clicked button
        targetButton.classList.add('tab-active'); 
        
        if (targetId === 'tab-proposals') {
            renderProposalsTable(); // <-- ADDED
            renderApprovedProposalsTable(); // <-- ADDED
            renderArchivedProposalsTable(); // <-- ADDED
            showView('proposals'); 
        }
        else if (targetId === 'tab-summary') { renderSummaryTable(); showView('summary'); }
        else if (targetId === 'tab-new-products') { renderNewProductsList(); showView('newProductsList'); }
        // The "Home" button has its own listener, so it's not part of this logic.
        
        closeSidebar(); // This should now work correctly.
    }
    function handleCreateProposalClick() { currentEntryId = null; const form = document.getElementById('proposal-form'); form.reset(); form.querySelector('#productType').dispatchEvent(new Event('change')); document.getElementById('proposal-form-title-modal').innerText = "Create New Product Proposal"; document.getElementById('create-proposal-modal').classList.remove('hidden'); }
    function handleProposalFormSubmit(e) { 
        e.preventDefault(); 
        
        // Get the current financial year start to create a relevant ID
        const today = new Date(2025, 9, 14); // Using the same mock "today" as populateFyFilters
        const currentYearStart = today.getMonth() >= 3 ? today.getFullYear() : today.getFullYear() - 1;
        
        const newProposal = { 
            id: `P${currentYearStart}-${String(Date.now()).slice(-4)}`, // Use dynamic year
            productType: document.getElementById('productType').value, 
            packSize: document.getElementById('packSize').value, 
            description: document.getElementById('description').value, 
            auditForm: document.getElementById('auditForm').value, 
            composition: document.getElementById('composition').value, 
            categoryL1: document.getElementById('categoryL1').value, 
            categoryL2: document.getElementById('categoryL2').value, 
            categoryL3: document.getElementById('categoryL3').value, 
            createdDate: formatDateToDDMMYYYY(new Date().toISOString().split('T')[0]), 
            owner: currentUser.name, 
            createdBy: currentUser.name, 
            isApproved: false, 
            vendorIdentification: { status: 'Pending', data: [] }, // <-- BUG 1 FIX: Was 'pending'
            sample: { status: 'Pending', data: [] }, 
            commercials: { status: 'Pending', data: [] }, 
            agreementProposal: { status: 'Pending', data: [] }, // <-- BUG 2 FIX: Was 'otherDetails'
        }; 
        proposals.push(newProposal); 
        renderProposalsTable(); 
        document.getElementById('create-proposal-modal').classList.add('hidden'); 
    }
    function handleInitiateApproval() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;
        if (p.commercials.data.length === 0) {
            alert('No commercials have been added for this proposal. Cannot proceed with approval.');
            return;
        }
        renderFinalApprovalComparisonView();
        document.getElementById('final-approval-modal').classList.remove('hidden');
    }

    function renderFinalApprovalComparisonView() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;

        const contentContainer = document.getElementById('final-approval-content');
        
        const approvableCommercials = p.commercials.data.filter(comm => {
            if (comm.status !== 'Completed') return false;
            if (p.rejectedCommercialIds && p.rejectedCommercialIds.includes(comm.id)) return false;
            const sample = p.sample.data.find(s => s.id == comm.sampleId && s.status === 'Completed');
            if (!sample) return false;
            const vendor = p.vendorIdentification.data.find(v => v.id == sample.vendorId && v.status === 'Completed');
            return !!vendor;
        });

        approvableCommercials.sort((a, b) => b.id - a.id); // <-- ADDED: Sort by ID (timestamp) descending

        const headers = ['Select', 'Vendor', 'Sample', 'Product Variant', 'Product Cost (Per Unit)', 'Logistics Cost (Per Unit)', 'Total Landed Cost (Per Unit)', 'Employee Incentive %', 'Probable SP (Per Unit)', 'Margin', 'Margin %', 'Tentative MRP (Per Unit)', 'MOQ', 'GST %', 'Expected Total Investment', 'Lead Time', 'Advance %', 'Balance Payment', 'Credit Days', 'Tentative Launch Date'];

        const headerCells = headers.map((h, index) => {
            if (index === 0) {
                return `<th class="px-3 py-3 text-left font-semibold text-slate-500 uppercase tracking-wider"><input type="checkbox" id="select-all-commercials" class="h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500"></th>`;
            }
            return `<th class="px-3 py-3 text-left font-semibold text-slate-500 uppercase tracking-wider">${h}</th>`;
        }).join('');

        let tableHtml = `<form id="final-approval-form"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200 text-sm">
                            <thead class="bg-slate-50/75"><tr>
                                ${headerCells}
                            </tr></thead>
                            <tbody class="bg-white divide-y divide-slate-200">`;

        approvableCommercials.forEach((comm, index) => {
            const vendor = p.vendorIdentification.data.find(v => v.id == comm.vendorId);
            const sample = p.sample.data.find(s => s.id == comm.sampleId);

            const today = new Date(); // Assuming today is the approval date
            const launchDate = new Date(today);
            launchDate.setDate(today.getDate() + (parseInt(comm.leadTime) || 0));
            const tentativeLaunchDate = formatDateToDDMMYYYY(launchDate.toISOString().split('T')[0]);
            const creditDaysText = comm.balancePaymentType === 'After Dispatch' ? (comm.creditDays || '0') : 'N/A';

            tableHtml += `<tr>
                <td class="px-3 py-4 whitespace-nowrap">
                    <input 
                        type="checkbox" 
                        name="selectedCommercial" 
                        value="${comm.id}" 
                        class="commercial-checkbox h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500"
                    >
                </td>
                <td class="px-3 py-4 whitespace-nowrap">${vendor.vendorName}</td>
                <td class="px-3 py-4 whitespace-nowrap">${sample.sampleName}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.productVariant || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.productCost || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.logisticsCost || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.totalLandedCost || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.employeeIncentivePercentage || '0'}%</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.probableSP || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.margin || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.marginPercentage || ''}${comm.marginPercentage ? '%' : ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.tentativeMRP || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.moq || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.gstPercentage || '0'}%</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.expectedTotalInvestment || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.leadTime || ''} days</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.advancePercentage || '0'}%</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.balancePaymentType || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${creditDaysText}</td>
                <td class="px-3 py-4 whitespace-nowrap">${tentativeLaunchDate}</td>
            </tr>`;
        });

        tableHtml += `</tbody></table></div></form>`;
        contentContainer.innerHTML = tableHtml;

        // Add event listeners for checkbox logic
        const selectAllCheckbox = document.getElementById('select-all-commercials');
        const commercialCheckboxes = document.querySelectorAll('.commercial-checkbox');
        
        selectAllCheckbox.addEventListener('change', (e) => {
            commercialCheckboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = e.target.checked;
                }
            });
        });
    }

    function handleApproveProposal() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;

        const selectedCommercialInputs = document.querySelectorAll('#final-approval-form input[name="selectedCommercial"]:checked');
        if (selectedCommercialInputs.length === 0) {
            alert('Please select at least one option to approve.');
            return;
        }

        p.approvedCommercialIds = Array.from(selectedCommercialInputs).map(input => parseInt(input.value));

        let approvedCount = 0;
        selectedCommercialInputs.forEach(input => {
            const selectedCommercialId = parseInt(input.value);
            const selectedCommercial = p.commercials.data.find(c => c.id === selectedCommercialId);
            if (!selectedCommercial) {
                console.error(`Could not find commercial data for ID: ${selectedCommercialId}`);
                return; // Skips to the next item in forEach
            }
            const selectedVendorId = selectedCommercial.vendorId;
            const vendor = p.vendorIdentification.data.find(v => v.id == selectedVendorId);
            
            // Auto-create a new WIP task from the approved commercial
            const productName = `${p.description || p.composition || p.productType}${selectedCommercial.productVariant ? '-' + selectedCommercial.productVariant : ''}`;
            
            // Check if a task with the same product name and proposal ID already exists to prevent duplicates.
            const taskAlreadyExists = wipTasks.some(task => task.proposalId === p.id && task.productName === productName);
            
            if (!taskAlreadyExists) {
                 // --- MODIFICATION START: Find agreements for this specific vendor ---
                 const agreementsForVendor = p.agreementProposal.data.filter(
                    a => a.vendorId == selectedVendorId && a.source === 'proposal'
                 );
                 // --- MODIFICATION END ---

                 const newWipTask = {
                    id: `WIP-${String(Date.now() + approvedCount).slice(-4)}`, // Add count to ensure unique ID in loop
                    proposalId: p.id,
                    commercialId: selectedCommercialId, // <-- ***** ADD THIS *****
                    productId: '', // Initially blank, fetched from PO Released stage
                    productName: productName,
                    vendorName: vendor ? vendor.vendorName : 'N/A',
                    vendorId: vendor ? vendor.id : null,
                    owner: p.owner,
                    createdBy: p.createdBy, // In a real app, this would be the current user
                    createdDate: formatDateToDDMMYYYY(new Date().toISOString().split('T')[0]),
                    isCancelled: false,
                    stages: { 
                        // --- MODIFICATION START: Use vendor-specific agreements ---
                        agreement: { data: JSON.parse(JSON.stringify(agreementsForVendor)) },
                        // --- MODIFICATION END ---
                        artWork: { data: [] }, 
                        pricing: { data: [] }, 
                        branding: { data: [] }, 
                        vendorKYC: { data: [] }, 
                        poReleased: { data: [] }, 
                        productionStarted: { data: [] }, 
                        rawMaterialsProcured: { data: [] }, 
                        packingMaterialProcured: { data: [] }, 
                        grn: { data: [] } 
                    }
                };
                wipTasks.push(newWipTask);
                approvedCount++;
            }
        });

        p.isApproved = true;
        p.approvedDate = formatDateToDDMMYYYY(new Date().toISOString().split('T')[0]);
        p.approvedBy = isManagerView ? 'Manager' : currentUser.name;
        
        // --- MODIFICATION START ---
        // Set the finalized vendor to the one from the first selected commercial
        if (p.approvedCommercialIds && p.approvedCommercialIds.length > 0) {
            const firstSelectedCommercialId = p.approvedCommercialIds[0];
            const firstSelectedCommercial = p.commercials.data.find(c => c.id === firstSelectedCommercialId);
            if (firstSelectedCommercial && firstSelectedCommercial.vendorId) { // Check if commercial and vendorId exist
                p.finalizedVendorId = parseInt(firstSelectedCommercial.vendorId);
            } else {
                console.error(`Could not find valid commercial data or vendorId for commercial ID: ${firstSelectedCommercialId}`);
                // Handle error case, maybe set finalizedVendorId to null or a default
                p.finalizedVendorId = null; 
            }
        } else {
             console.error(`No approved commercial IDs found for proposal ${p.id} during approval.`);
             p.finalizedVendorId = null; // No vendor if no commercials
        }
        // --- MODIFICATION END ---


        document.getElementById('final-approval-modal').classList.add('hidden');
        renderProposalsTable();
        renderApprovedProposalsTable();
        // Re-render the current proposal detail and remain on the same page (do not redirect)
        renderProposalDetail();
    }
    
    function handleRejectProposal() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;
        const modal = document.getElementById('confirmation-modal');
        document.getElementById('confirmation-modal-title').innerText = 'Reject Proposal';
        document.getElementById('confirmation-modal-text').innerText = `Are you sure you want to reject proposal ${p.id}? This action cannot be undone.`;
        document.getElementById('confirmation-modal-confirm-btn').className = 'bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-red-700 transition';
        confirmationAction = () => {
            p.isRejected = true;
            p.rejectedDate = formatDateToDDMMYYYY(new Date().toISOString().split('T')[0]);
            p.rejectedBy = isManagerView ? 'Manager' : currentUser.name;
            renderProposalDetail();
            renderProposalsTable();
            renderArchivedProposalsTable();
        };
        modal.classList.remove('hidden');
    }

    function handleWithdrawProposal() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;
        const modal = document.getElementById('confirmation-modal');
        document.getElementById('confirmation-modal-title').innerText = 'Withdraw Proposal';
        document.getElementById('confirmation-modal-text').innerText = `Are you sure you want to withdraw proposal ${p.id}?`;
        document.getElementById('confirmation-modal-confirm-btn').className = 'bg-yellow-500 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-yellow-600 transition';
        confirmationAction = () => {
            p.isWithdrawn = true;
            p.withdrawnDate = formatDateToDDMMYYYY(new Date().toISOString().split('T')[0]);
            p.withdrawnBy = isManagerView ? 'Manager' : currentUser.name;
            renderProposalDetail();
            renderProposalsTable();
            renderArchivedProposalsTable();
        };
        modal.classList.remove('hidden');
    }

    function handleTransferOwner() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;

        // --- MODIFICATION START ---
        currentWipId = null; // <-- THE FIX: Clear any stale WIP ID
        // --- MODIFICATION END ---

        // --- MODIFICATION START ---
        if (p.isApproved) {
            // Proposal is approved, first show product selection modal
            renderProductSelectionModal();
        } else {
            // Proposal is not approved, show owner transfer modal directly
            
            // --- FIX START ---
            // We must clear productsToTransfer here, otherwise it might
            // contain stale data from a previous approved transfer.
            productsToTransfer = []; 
            // --- FIX END ---
            
            document.getElementById('newOwnerSearch').value = '';
            document.getElementById('newOwnerName').value = '';
            document.getElementById('owner-search-results').innerHTML = '';
            document.getElementById('owner-search-results').classList.add('hidden');
            document.getElementById('transfer-owner-modal').classList.remove('hidden');
        }
        // --- MODIFICATION END ---
    }

    // --- MODIFICATION START: Added new function ---
    function renderProductSelectionModal() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;
        
        // --- MODIFICATION START ---
        // let tasks = wipTasks.filter(task => task.proposalId === p.id); // <-- OLD
        let tasks = wipTasks.filter(task => task.proposalId === p.id && !task.isCancelled); // <-- NEW: Exclude withdrawn (cancelled) tasks
        // --- MODIFICATION END ---

        // --- MODIFICATION START: Filter products by owner if in Employee View ---
        if (!isManagerView) {
            tasks = tasks.filter(task => task.owner === currentUser.name);
        }
        // --- MODIFICATION END ---
        
        const listContainer = document.getElementById('product-selection-list');
        const modal = document.getElementById('product-selection-modal');
        const selectAllCheckbox = document.getElementById('select-all-products');
        
        selectAllCheckbox.checked = true; // <-- MODIFICATION: Set "Select All" to checked by default
        listContainer.innerHTML = '';

        if (tasks.length === 0) {
            listContainer.innerHTML = '<p class="text-sm text-slate-500 text-center py-4">No products are associated with this proposal.</p>';
            selectAllCheckbox.checked = false; // <-- MODIFICATION: Uncheck if no tasks
            selectAllCheckbox.disabled = true; // <-- MODIFICATION: Disable if no tasks
        } else {
            selectAllCheckbox.disabled = false; // <-- MODIFICATION: Enable if tasks exist
            tasks.forEach(task => {
                listContainer.innerHTML += `
                    <label class="flex items-center space-x-3 p-3 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">
                        <input type="checkbox" name="selectedProduct" value="${task.id}" class="product-transfer-checkbox h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500" checked> <!-- MODIFICATION: Added 'checked' -->
                        <span class="text-sm font-medium text-slate-800">${task.productName} (Owner: ${task.owner})</span>
                    </label>
                `;
            });
        }
        
        // Add listener for "Select All"
        selectAllCheckbox.onchange = (e) => {
            modal.querySelectorAll('.product-transfer-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        };
        
        // Check "Select All" if all individuals are checked
        const allCheckboxes = modal.querySelectorAll('.product-transfer-checkbox');
        allCheckboxes.forEach(checkbox => {
            checkbox.onchange = () => {
                const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
            };
        });

        modal.classList.remove('hidden');
    }
    // --- MODIFICATION END ---

    function handleSaveEntryStatus(entryId, status) {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;
        const entry = p[currentStage].data.find(e => e.id === entryId);
        if (!entry) return;

        // --- NEW VALIDATION LOGIC ---
        if (currentStage === 'vendorIdentification' && status === 'Completed') {
            const expertise = entry.categoryCompositionExpertise;
            const partners = entry.keyPartnersBrands;

            if (!expertise || expertise.trim() === '' || !partners || partners.trim() === '') {
                // Fields are missing.
                
                // 1. Open the modal with existing details
                currentEntryId = entryId; // Set the currentEntryId for the modal
                openStageEntryModal(entry); // This function will pre-fill the form

                // 2. Show an error message inside the modal
                const errorContainer = document.getElementById('stage-entry-error-message');
                if (errorContainer) {
                    errorContainer.textContent = 'To mark as "Completed", please fill in "Category / Composition Expertise" and "Key Partners/Brands".';
                    errorContainer.classList.remove('hidden');
                    
                    // Highlight the specific fields in the modal
                    const form = document.getElementById('stage-entry-form');
                    const expertiseInput = form.querySelector('#categoryCompositionExpertise');
                    const partnersInput = form.querySelector('#keyPartnersBrands');
                    let focused = false;
                    
                    if (expertiseInput && (!expertise || expertise.trim() === '')) {
                        expertiseInput.classList.add('border-red-500');
                        expertiseInput.focus();
                        focused = true;
                    }
                    if (partnersInput && (!partners || partners.trim() === '')) {
                        partnersInput.classList.add('border-red-500');
                        if (!focused) {
                           partnersInput.focus();
                        }
                    }
                }
                return; // Stop the function from marking as completed
            }
        }
        // If trying to mark a sample as Completed, ensure testedOn and avgRating are present
        if (currentStage === 'sample' && status === 'Completed') {
            const testedOn = entry.testedOn;
            const avgRating = entry.avgRating;
            
            // Check if testedOn is missing (allow 0 as valid)
            const testedOnMissing = (testedOn === undefined || testedOn === null || testedOn === '');
            
            // Check if avgRating is missing (allow 0 as valid)
            const avgRatingMissing = (avgRating === undefined || avgRating === null || avgRating === '');

            if (testedOnMissing || avgRatingMissing) {
                // Open the modal to let user fill/edit these fields
                currentEntryId = entryId;
                openStageEntryModal(entry);

                const errorContainer = document.getElementById('stage-entry-error-message');
                if (errorContainer) {
                    errorContainer.textContent = 'To mark as "Completed", please provide "No. of People Tested On" and "Avg. Rating (Out of 5)".';
                    errorContainer.classList.remove('hidden');

                    // Auto-hide error message after 5 seconds
                    setTimeout(() => {
                        if (errorContainer && !errorContainer.classList.contains('hidden')) {
                            errorContainer.classList.add('hidden');
                            errorContainer.textContent = '';
                        }
                    }, 5000);

                    // Highlight missing fields
                    const form = document.getElementById('stage-entry-form');
                    const testedOnInput = form ? form.querySelector('#testedOn') : null;
                    const avgRatingInput = form ? form.querySelector('#avgRating') : null;
                    let focused = false;
                    if (testedOnInput && testedOnMissing) {
                        testedOnInput.classList.add('border-red-500');
                        if (!focused) { testedOnInput.focus(); focused = true; }
                    }
                    if (avgRatingInput && avgRatingMissing) {
                        avgRatingInput.classList.add('border-red-500');
                        if (!focused) { avgRatingInput.focus(); focused = true; }
                    }
                }
                return; // Stop the function from marking as completed
            }
        }
        // --- END NEW VALIDATION LOGIC ---

        // If validation passes (or doesn't apply), proceed as normal
        entry.status = status;
        renderStageDetail();
    }
    function handleSaveProduct(e) {
        e.preventDefault();
        const proposal = proposals.find(p => p.id === currentProposalId);
        const productName = document.getElementById('productName').value;
        
        if (!proposal || !productName) return;
        const primaryVendor = proposal.vendorIdentification.data.length > 0 ? proposal.vendorIdentification.data.find(v => v.id == proposal.finalizedVendorId).vendorName : 'N/A';
        const newWipTask = {
            id: `WIP-${String(Date.now()).slice(-4)}`,
            proposalId: proposal.id,
            productId: 'N/A', // Set to N/A initially
            productName: productName,
            vendorName: primaryVendor,
            owner: proposal.owner,
            createdBy: proposal.owner,
            createdDate: formatDateToDDMMYYYY(new Date().toISOString().split('T')[0]),
            isCancelled: false,
            stages: { agreement: { data: [] }, artWork: { data: [] }, pricing: { data: [] }, branding: { data: [] }, vendorKYC: { data: [] }, poReleased: { data: [] }, productionStarted: { data: [] }, rawMaterialsProcured: { data: [] }, packingMaterialProcured: { data: [] }, grn: { data: [] } }
        };
        wipTasks.push(newWipTask);
        document.getElementById('add-product-modal').classList.add('hidden');
        renderProposalTasksView();
    }
    
    const buildPricingDetailsHtml = (pricingData) => {
        
        // if (!pricingData) return '<li>No pricing data available.</li>'; // OLD
        if (!pricingData) return null; // NEW

        // const fieldsToShow = [...]; // OLD - Now global
        
        const processedData = {}; // NEW

        // let html = ''; // OLD
        PRICING_FIELDS_CONFIG.forEach(field => { // NEW - use global config
        
            let value = pricingData[field.key] || 'N/A';
            if ((field.key.endsWith('Percentage') || field.key.endsWith('Percent')) && value !== 'N/A' && !String(value).endsWith('%')) {
                 value += '%';
            }
            if (field.key === 'upload' && value !== 'N/A' && value !== '') {
                value = `<a href="#" onclick="event.preventDefault()" class="app-link" title="File: ${value}">${value}</a>`;
            } else if (field.key === 'upload' && (value === 'N/A' || value === '')) {
                value = 'N/A';
            }
            
            // html += `<li>${field.label}: <span class="font-medium text-slate-900">${value}</span></li>`; // OLD
            processedData[field.key] = `<span class="font-medium text-slate-900">${value}</span>`; // NEW
            
        });
        
        // return html; // OLD
        return processedData; // NEW
        
    };
    

    // --- MODIFICATION START: Add new approval/rejection functions ---
    function handleApproveWipPricing(taskId) {
        const task = wipTasks.find(t => t.id === taskId);
        if (!task) return;

        // --- MODIFICATION START ---
        const pricingStage = task.stages.pricing;
        const newPricing = pricingStage?.data?.[0];
        const oldPricing = pricingStage?.oldData;
        
        
        const newPricingData = buildPricingDetailsHtml(newPricing);
        const oldPricingData = buildPricingDetailsHtml(oldPricing);

        const detailsEl = document.getElementById('confirmation-modal-details');
        
        let detailsHtml = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200 text-sm">';
        detailsHtml += `<thead class="bg-slate-50/75">
                            <tr>
                                <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50/75 z-10">Version</th>
        `;
        
        PRICING_FIELDS_CONFIG.forEach(field => {
            detailsHtml += `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">${field.label}</th>`;
        });

        detailsHtml += '</tr></thead>';
        detailsHtml += '<tbody class="bg-white divide-y divide-slate-200">';

        // --- NEW ROW ---
        detailsHtml += '<tr>';
        detailsHtml += '<td class="px-4 py-2 font-medium text-slate-600 sticky left-0 bg-white z-10">New (Edited)</td>';

        PRICING_FIELDS_CONFIG.forEach(field => {
            const newValueHtml = newPricingData ? (newPricingData[field.key] || '<span class="text-slate-400">N/A</span>') : '<span class="text-slate-400">N/A</span>';
            const oldValueHtml = oldPricingData ? (oldPricingData[field.key] || '<span class="text-slate-400">N/A</span>') : '<span class="text-slate-400">N/A</span>';
            const isDifferent = (newValueHtml !== oldValueHtml);
            
            detailsHtml += `<td class="px-4 py-2 whitespace-nowrap ${isDifferent ? 'bg-yellow-50' : ''}">${newValueHtml}</td>`;
        });
        detailsHtml += '</tr>';

        // --- OLD ROW ---
        detailsHtml += '<tr>';
        detailsHtml += '<td class="px-4 py-2 font-medium text-slate-600 sticky left-0 bg-white z-10">Previous (Approved)</td>';

        PRICING_FIELDS_CONFIG.forEach(field => {
            const newValueHtml = newPricingData ? (newPricingData[field.key] || '<span class="text-slate-400">N/A</span>') : '<span class="text-slate-400">N/A</span>';
            const oldValueHtml = oldPricingData ? (oldPricingData[field.key] || '<span class="text-slate-400">N/A</span>') : '<span class="text-slate-400">N/A</span>';
            const isDifferent = (newValueHtml !== oldValueHtml);
            
            detailsHtml += `<td class="px-4 py-2 whitespace-nowrap ${isDifferent ? 'bg-yellow-50' : ''}">${oldValueHtml}</td>`;
        });
        detailsHtml += '</tr>';


        detailsHtml += '</tbody></table></div>';
        
        
        detailsEl.innerHTML = detailsHtml;
        detailsEl.classList.remove('hidden');
        // --- MODIFICATION END ---

        const modal = document.getElementById('confirmation-modal');
        document.getElementById('confirmation-modal-title').innerText = 'Approve Pricing';
        document.getElementById('confirmation-modal-text').innerText = `Are you sure you want to approve the pricing changes for "${task.productName}"?`;
        document.getElementById('confirmation-modal-confirm-btn').className = 'bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-green-700 transition';
        
        confirmationAction = () => {
            // --- MODIFICATION START ---
            const pricingStage = task.stages.pricing;
            const pricingEntry = pricingStage?.data?.[0];
            if (pricingEntry) {
                pricingEntry.status = 'Completed';
                // Clear the approval flag
                pricingStage.needsManagerApproval = false;
                // Clear the old data cache, as the new data is now 'Completed'
                if (pricingStage.oldData) {
                    delete pricingStage.oldData;
                }
            }
            // --- MODIFICATION END ---
            renderWipDetail(); // Re-render to show new status and hide buttons
            renderWipStageTableView(); // Re-render table if user is viewing it
            // Ensure the main lists are updated immediately so New Products shows the updated status
            try { renderNewProductsList(); } catch (e) { /* ignore if not present */ }
            try { renderSummaryTable(); } catch (e) { /* ignore if not present */ }
        };
        
        modal.classList.remove('hidden');
    }

    function handleRejectWipPricing(taskId) {
        const task = wipTasks.find(t => t.id === taskId);
        if (!task) return;

        // --- MODIFICATION START ---
        const pricingStage = task.stages.pricing;
        const newPricing = pricingStage?.data?.[0];
        const oldPricing = pricingStage?.oldData;
        
        
        const newPricingData = buildPricingDetailsHtml(newPricing);
        const oldPricingData = buildPricingDetailsHtml(oldPricing);

        const detailsEl = document.getElementById('confirmation-modal-details');
        
        let detailsHtml = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200 text-sm">';
        detailsHtml += `<thead class="bg-slate-50/75">
                            <tr>
                                <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-50/75 z-10">Version</th>
        `;
        
        PRICING_FIELDS_CONFIG.forEach(field => {
            detailsHtml += `<th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">${field.label}</th>`;
        });

        detailsHtml += '</tr></thead>';
        detailsHtml += '<tbody class="bg-white divide-y divide-slate-200">';

        // --- NEW ROW ---
        detailsHtml += '<tr>';
        detailsHtml += '<td class="px-4 py-2 font-medium text-slate-600 sticky left-0 bg-white z-10">New (To be Rejected)</td>';

        PRICING_FIELDS_CONFIG.forEach(field => {
            const newValueHtml = newPricingData ? (newPricingData[field.key] || '<span class="text-slate-400">N/A</span>') : '<span class="text-slate-400">N/A</span>';
            const oldValueHtml = oldPricingData ? (oldPricingData[field.key] || '<span class="text-slate-400">N/A</span>') : '<span class="text-slate-400">N/A</span>';
            const isDifferent = (newValueHtml !== oldValueHtml);
            
            detailsHtml += `<td class="px-4 py-2 whitespace-nowrap ${isDifferent ? 'bg-yellow-50' : ''}">${newValueHtml}</td>`;
        });
        detailsHtml += '</tr>';

        // --- OLD ROW ---
        detailsHtml += '<tr>';
        detailsHtml += '<td class="px-4 py-2 font-medium text-slate-600 sticky left-0 bg-white z-10">Reverting to (Original)</td>';

        PRICING_FIELDS_CONFIG.forEach(field => {
            const newValueHtml = newPricingData ? (newPricingData[field.key] || '<span class="text-slate-400">N/A</span>') : '<span class="text-slate-400">N/A</span>';
            const oldValueHtml = oldPricingData ? (oldPricingData[field.key] || '<span class="text-slate-400">N/A</span>') : '<span class="text-slate-400">N/A</span>';
            const isDifferent = (newValueHtml !== oldValueHtml);
            
            detailsHtml += `<td class="px-4 py-2 whitespace-nowrap ${isDifferent ? 'bg-yellow-50' : ''}">${oldValueHtml}</td>`;
        });
        detailsHtml += '</tr>';

        detailsHtml += '</tbody></table></div>';
        
        if (!oldPricing) {
             detailsHtml += '<p class="mt-3 text-sm text-slate-600">No previous version to revert to. The status will be set to "WIP".</p>';
        }
        
        
        detailsEl.innerHTML = detailsHtml;
        detailsEl.classList.remove('hidden');
        // --- MODIFICATION END ---

        const modal = document.getElementById('confirmation-modal');
        document.getElementById('confirmation-modal-title').innerText = 'Reject Pricing';
        document.getElementById('confirmation-modal-text').innerText = `Are you sure you want to reject these pricing changes for "${task.productName}"?`;
        document.getElementById('confirmation-modal-confirm-btn').className = 'bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-red-700 transition';
        
        confirmationAction = () => {
            const pricingStage = task.stages.pricing;
            const pricingEntry = pricingStage?.data?.[0];

            if (pricingEntry) {
                // --- MODIFICATION START ---
                // Check if there is old data to restore
                if (pricingStage.oldData) {
                    // Restore the old data (which includes 'Completed' status)
                    pricingStage.data[0] = { ...pricingStage.oldData };
                    // Clear the temporary cache
                    delete pricingStage.oldData;
                } else {
                    // If no old data (e.g., it was rejected from a 'WIP' state or 'Completed' state
                    // that was set by the employee directly),
                    // just set the status back to 'WIP'. The new values will remain,
                    // as there is no "old" data to revert to.
                    pricingEntry.status = 'WIP';
                }
                // In all rejection cases, clear the approval flag
                pricingStage.needsManagerApproval = false;
                // --- MODIFICATION END ---
            }
            renderWipDetail(); // Re-render to show new status and hide buttons
            renderWipStageTableView(); // Re-render table if user is viewing it
            // Ensure the main lists are updated immediately so New Products shows the updated status
            try { renderNewProductsList(); } catch (e) { /* ignore if not present */ }
            try { renderSummaryTable(); } catch (e) { /* ignore if not present */ }
        };
        
        modal.classList.remove('hidden');
    }
    // --- MODIFICATION END ---

    function viewProposalInReadOnly(proposalId, backView) {
        currentProposalId = proposalId;
        renderProposalDetail(true); // render in view-only mode
        const proposalDetailBackBtn = document.getElementById('proposal-detail-back-btn');
        
        if (backView === 'proposalTasks') {
            proposalDetailBackBtn.textContent = ' Back to Proposal Details';
            proposalDetailBackBtn.onclick = () => { 
                renderProposalDetailsView();
                showView('Proposal Details'); 
            };
        } else if (backView === 'wipDetail') {
            proposalDetailBackBtn.textContent = ' Back to Product Details';
            proposalDetailBackBtn.onclick = () => { 
                renderWipDetail();
                showView('wipDetail'); 
            };
        } else if (backView === 'summary') {
             proposalDetailBackBtn.textContent = ' Back to Summary';
            proposalDetailBackBtn.onclick = () => { 
                renderSummaryTable();
                showView('summary'); 
            };
        } else if (backView === 'newProductsList') {
            proposalDetailBackBtn.textContent = ' Back to New Products List';
            proposalDetailBackBtn.onclick = () => { 
                renderNewProductsList();
                showView('newProductsList'); 
            };
        }
        showView('proposalDetail');
    }
    
    function viewWipTaskDetail(taskId, backView = 'summary') {
        currentWipId = taskId;
        renderWipDetail(backView);
        showView('wipDetail');
    }

    function handleCancelWipTask(taskId) { 
        const task = wipTasks.find(t => t.id === taskId); 
        if (task) { 
            const modal = document.getElementById('confirmation-modal'); 
            document.getElementById('confirmation-modal-title').innerText = 'Withdraw Task'; 
            document.getElementById('confirmation-modal-text').innerText = `Are you sure you want to withdraw the task "${task.productName}"?`; 
            document.getElementById('confirmation-modal-confirm-btn').className = 'bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-red-700 transition'; 
            
            confirmationAction = () => { 
                task.isCancelled = true; 
                // Mark withdrawn and persist metadata at withdrawal time (only once)
                task.isWithdrawn = true;
                if (!task.withdrawnOn) {
                    task.withdrawnOn = formatDateToDDMMYYYY(new Date().toISOString().split('T')[0]);
                }
                if (!task.withdrawnBy) {
                    task.withdrawnBy = isManagerView ? 'Manager' : (currentUser && currentUser.name ? currentUser.name : '');
                }
                
                // Re-render all lists that might be affected
                // --- MODIFICATION START ---
                if (currentProposalId) { // Only render this if we are in a proposal context
                    renderProposalTasksView(); 
                }
                // --- MODIFICATION END ---
                renderSummaryTable(); 
                renderNewProductsList(); 
                
                // Check if we came from the New Products List
                if (currentWipDetailBackView === 'newProductsList') {
                    // Navigate back to the list
                    showView('newProductsList');
                    
                    // Activate the 'Withdrawn' tab to show the user where the product went
                    document.getElementById('inner-tab-wip').classList.remove('inner-tab-active');
                    document.getElementById('inner-panel-wip').classList.remove('inner-panel-active');
                    
                    document.getElementById('inner-tab-launched').classList.remove('inner-tab-active');
                    document.getElementById('inner-panel-launched').classList.remove('inner-panel-active');

                    document.getElementById('inner-tab-withdrawn').classList.add('inner-tab-active');
                    document.getElementById('inner-panel-withdrawn').classList.add('inner-panel-active');
                } else {
                    // Default behavior: just re-render the detail view (which will show 'Withdrawn')
                    renderWipDetail();
                }
            }; 
            modal.classList.remove('hidden'); 
        } 
    }
    function handleTransferWipOwner(taskId) {
        currentWipId = taskId;
        const task = wipTasks.find(t => t.id === taskId);
        if (!task) return;
        document.getElementById('newOwnerSearch').value = '';
        document.getElementById('newOwnerName').value = '';
        document.getElementById('owner-search-results').innerHTML = '';
        document.getElementById('owner-search-results').classList.add('hidden');
        document.getElementById('transfer-owner-modal').classList.remove('hidden');
    }
    function showEmployeeProductsByStatus(employeeName, status) {
        const filteredTasks = wipTasks.filter(p => {
            const taskStatus = calculateWipStatus(p);
            if (status === 'WIP') {
                return p.owner === employeeName && (taskStatus === 'WIP' || taskStatus === 'Project Approved');
            }
            return p.owner === employeeName && taskStatus === status;
        });
        filteredTasks.sort((a, b) => parseDateForSorting(b.createdDate) - parseDateForSorting(a.createdDate)); // <-- ADDED
        const employee = dummyEmployees.find(emp => emp.name === employeeName);

        const modal = document.getElementById('proposal-list-modal');
        const title = document.getElementById('proposal-list-modal-title');
        const content = document.getElementById('proposal-list-content');
        
        title.innerText = `Products for ${employeeName} with status: ${status}`;
        
            if (filteredTasks.length === 0) {
            content.innerHTML = `<p class="text-center py-8 text-slate-500">No products found.</p>`;
        } else {
            let tableHtml = `<table class="min-w-full divide-y divide-slate-200 text-sm">
                                <thead class="bg-slate-50/75">
                                    <tr>
                                        <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Emp ID</th>
                                        <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Emp Name</th>
                                        <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Product ID</th>
                                        <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Product Name</th>
                                        <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Proposal ID</th>
                                        <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Commercial ID</th>
                                        <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Vendor Name</th>
                                        <th class="px-4 py-2 text-left font-semibold text-slate-500 uppercase tracking-wider">Created On</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-slate-200">`;
            filteredTasks.forEach(task => {
                const proposal = proposals.find(p => p.id === task.proposalId);
                const vendorId = proposal ? proposal.finalizedVendorId : null;
                
                const productIdHtml = task.productId ? `<a href="#" onclick="document.getElementById('proposal-list-modal').classList.add('hidden'); viewWipTaskDetail('${task.id}')" class="app-link">${task.productId}</a>` : '';
                const productNameHtml = `<a href="#" onclick="document.getElementById('proposal-list-modal').classList.add('hidden'); viewWipTaskDetail('${task.id}')" class="app-link">${task.productName}</a>`;
                const proposalIdHtml = `<a href="#" onclick="document.getElementById('proposal-list-modal').classList.add('hidden'); viewProposalInReadOnly('${task.proposalId}', 'summary')" class="app-link">${task.proposalId}</a>`;
                const vendorNameHtml = vendorId 
                    ? `<a href="#" onclick="document.getElementById('proposal-list-modal').classList.add('hidden'); showVendorDetailsPopup('${task.proposalId}', ${vendorId})" class="app-link">${task.vendorName}</a>`
                    : task.vendorName;
                
                tableHtml += `<tr>
                                <td class="px-4 py-2">${employee.id}</td>
                                <td class="px-4 py-2">${employee.name}</td>
                                <td class="px-4 py-2">${productIdHtml}</td>
                                <td class="px-4 py-2">${productNameHtml}</td>
                                <td class="px-4 py-2">${proposalIdHtml}</td>
                                <td class="px-4 py-2">${task.commercialId || ''}</td>
                                <td class="px-4 py-2">${vendorNameHtml}</td>
                                <td class="px-4 py-2">${task.createdDate}</td>
                              </tr>`;
            });
            tableHtml += '</tbody></table>';
            content.innerHTML = tableHtml;
        }

        
        modal.classList.remove('hidden');
    }
    // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENT INITIALIZATION ---
        roleSelector = document.getElementById('roleSelector');
        tabs = { 
            proposals: document.getElementById('tab-proposals'), 
            // approvedProposals: document.getElementById('tab-approved-proposals'), // <-- REMOVED
            summary: document.getElementById('tab-summary'), 
            newProducts: document.getElementById('tab-new-products') 
        };
        views = { 
            proposals: document.getElementById('view-proposals'), 
            // approvedProposals: document.getElementById('view-approved-proposals'), // <-- REMOVED
            proposalTasks: document.getElementById('view-proposal-tasks'), 
            summary: document.getElementById('view-summary'), 
            proposalDetail: document.getElementById('view-proposal-detail'), 
            stageDetail: document.getElementById('view-stage-detail'), 
            wipDetail: document.getElementById('view-wip-detail'), 
            wipStageDetail: document.getElementById('view-wip-stage-detail'), 
            newProductsList: document.getElementById('view-new-products-list'), 
        };
        // --- END DOM ELEMENT INITIALIZATION ---

        const dashboardView = document.getElementById('dashboard-view');
        const trackerView = document.getElementById('tracker-view');
        const npdCard = document.getElementById('npd-card-main');
        // const homeBtn = document.getElementById('home-btn'); // No longer exists, replaced by menu-btn

        // --- NEW ELEMENTS ---
        const menuBtn = document.getElementById('menu-btn');
        // --- Initialize global variables ---
        mainSidebar = document.getElementById('main-sidebar');
        sidebarOverlay = document.getElementById('sidebar-overlay');
        // --- End initialization ---
        const closeMainSidebarBtn = document.getElementById('close-main-sidebar-btn');
        const sidebarHomeBtn = document.getElementById('sidebar-home-btn');
        // --- END NEW ELEMENTS ---

        // --- ADDED ---
        // const userSelector = document.getElementById('userSelector'); // Removed
        // const userSelectorContainer = document.getElementById('user-selector-container'); // Removed
        // --- END ADDED ---

        const showDashboard = () => {
            if (dashboardView && trackerView) {
                dashboardView.style.display = 'block';
                trackerView.style.display = 'none';
            } else {
                console.error("Dashboard or Tracker view not found!");
            }
        };

        const showTracker = () => {
            if (dashboardView && trackerView) {
                trackerView.style.display = 'block';
                dashboardView.style.display = 'none';
            } else {
                console.error("Dashboard or Tracker view not found!");
            }
        };

        // --- NEW FUNCTIONS ---
        // --- These are now defined globally ---
        // const openSidebar = () => {
        //     if (mainSidebar && sidebarOverlay) {
        //         sidebarOverlay.classList.remove('hidden');
        //         setTimeout(() => sidebarOverlay.classList.add('opacity-100'), 10); // For transition
        //         mainSidebar.classList.remove('-translate-x-full');
        //     }
        // };

        // const closeSidebar = () => {
        //     if (mainSidebar && sidebarOverlay) {
        //         mainSidebar.classList.add('-translate-x-full');
        //         sidebarOverlay.classList.remove('opacity-100');
        //         setTimeout(() => sidebarOverlay.classList.add('hidden'), 300); // Wait for transition
        //     }
        // };
        // --- END NEW FUNCTIONS ---

        if(npdCard) npdCard.addEventListener('click', showTracker);
        // if(homeBtn) homeBtn.addEventListener('click', showDashboard); // <-- This listener is removed

        // --- ADD NEW LISTENERS ---
        if(menuBtn) menuBtn.addEventListener('click', openSidebar);
        if(closeMainSidebarBtn) closeMainSidebarBtn.addEventListener('click', closeSidebar);
        if(sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);
        if(sidebarHomeBtn) sidebarHomeBtn.addEventListener('click', () => {
            // Deactivate all other tabs
            const allTabButtons = document.getElementById('main-sidebar').querySelectorAll('.tab-btn');
            allTabButtons.forEach(tab => { 
                tab.classList.remove('tab-active'); 
            }); 
            // Activate home button
            sidebarHomeBtn.classList.add('tab-active');
            
            closeSidebar();
            showDashboard();
        });
        // --- END NEW LISTENERS ---

        // --- ADDED BLOCK START ---
        // (This entire block has been removed as it's no longer needed)
        // --- ADDED BLOCK END ---

        roleSelector.addEventListener('change', handleRoleChange);
        tabs.proposals.addEventListener('click', handleTabClick);
        // tabs.approvedProposals.addEventListener('click', handleTabClick); // <-- REMOVED
        tabs.summary.addEventListener('click', handleTabClick);
        tabs.newProducts.addEventListener('click', handleTabClick);

        // Wire Create Proposal button and set initial visibility based on role
        const createProposalBtn = document.getElementById('btn-create-proposal');
        if (createProposalBtn) {
            createProposalBtn.addEventListener('click', handleCreateProposalClick);
            createProposalBtn.style.display = isManagerView ? 'none' : '';
        }
        
        const modals = ['create-proposal-modal', 'stage-entry-modal', 'wip-stage-entry-modal', 'add-product-modal', 'vendor-selection-modal', 'final-approval-modal', 'transfer-owner-modal', 'yes-no-modal', 'vendor-details-modal', 'proposal-list-modal', 'edit-product-name-modal', 'pending-variants-approval-modal']; 
        modals.forEach(id => { 
            const modal = document.getElementById(id); 
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); }); 
            const closeBtn = modal.querySelector('button[id^="close-"]');
            if(closeBtn) closeBtn.addEventListener('click', () => modal.classList.add('hidden')); 
        });

        // --- MODIFICATION START: Add listeners for new modal ---
        const productSelectionModal = document.getElementById('product-selection-modal');
        if (productSelectionModal) {
            document.getElementById('close-product-selection-modal-btn').addEventListener('click', () => {
                productSelectionModal.classList.add('hidden');
                productsToTransfer = []; // Clear selection on close
            });
            document.getElementById('cancel-product-selection-btn').addEventListener('click', () => {
                productSelectionModal.classList.add('hidden');
                productsToTransfer = []; // Clear selection on cancel
            });
            
            document.getElementById('product-selection-next-btn').addEventListener('click', () => {
                const selectedProductInputs = document.querySelectorAll('#product-selection-form input[name="selectedProduct"]:checked');
                
                // --- MODIFICATION START ---
                if (selectedProductInputs.length === 0) {
                    // --- MODIFICATION START ---
                    // Hide the selection modal *first*
                    productSelectionModal.classList.add('hidden'); 
                    // Use the custom alert function
                    showAlertModal("No Products Selected", "Please select at least one product to transfer.", "OK");
                    return; // Stop execution
                    // --- MODIFICATION END ---
                }
                // --- MODIFICATION END ---
                
                productsToTransfer = Array.from(selectedProductInputs).map(input => input.value);
                
                // Hide this modal
                productSelectionModal.classList.add('hidden');
                
                // Now show the owner transfer modal
                document.getElementById('newOwnerSearch').value = '';
                document.getElementById('newOwnerName').value = '';
                document.getElementById('owner-search-results').innerHTML = '';
                document.getElementById('owner-search-results').classList.add('hidden');
                document.getElementById('transfer-owner-modal').classList.remove('hidden');
            });
        }
        // --- MODIFICATION END ---

        // --- MODIFICATION START: Add listener for new bulk transfer button ---
        const bulkTransferBtn = document.getElementById('btn-transfer-wip-owner-bulk');
        if (bulkTransferBtn) {
            bulkTransferBtn.addEventListener('click', startBulkTransferMode);
        }
        // --- MODIFICATION START: Target the static thead element ---
        document.querySelector('#view-summary thead').addEventListener('click', (e) => {
            // Find the button, whether it's the target or a parent
            const button = e.target.closest('#wip-expand-btn');
            if (button) {
        // --- MODIFICATION END ---
                e.preventDefault();
                isWipExpanded = !isWipExpanded;
                renderSummaryTable();
            }
        });

        const confirmationModal = document.getElementById('confirmation-modal');
        // --- MODIFICATION START ---
        // Added cleanup logic for the new details container
        const confirmationModalDetails = document.getElementById('confirmation-modal-details');
        const confirmBtn = document.getElementById('confirmation-modal-confirm-btn');
        const cancelBtn = document.getElementById('confirmation-modal-cancel-btn');

        const closeConfirmationModal = () => {
            confirmationModal.classList.add('hidden');
            if (confirmationModalDetails) {
                confirmationModalDetails.innerHTML = '';
                confirmationModalDetails.classList.add('hidden');
            }
            // Restore defaults
            cancelBtn.classList.remove('hidden');
            confirmBtn.innerText = 'Confirm';
            confirmBtn.className = 'bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-red-700 transition';
        };

        document.getElementById('confirmation-modal-cancel-btn').addEventListener('click', closeConfirmationModal);
        confirmationModal.addEventListener('click', (e) => { 
            if(e.target === confirmationModal) closeConfirmationModal(); 
        });
        document.getElementById('confirmation-modal-confirm-btn').addEventListener('click', () => { 
            if (confirmationAction) confirmationAction(); 
            closeConfirmationModal(); 
        });
        // --- MODIFICATION END ---

        // --- NEW Inner Tab Listeners ---
        const innerTabCurrent = document.getElementById('inner-tab-current');
        const innerTabApproved = document.getElementById('inner-tab-approved');
        const innerPanelCurrent = document.getElementById('inner-panel-current');
        const innerPanelApproved = document.getElementById('inner-panel-approved');
        const innerTabArchived = document.getElementById('inner-tab-archived');
        const innerPanelArchived = document.getElementById('inner-panel-archived');

        if(innerTabCurrent) {
            innerTabCurrent.addEventListener('click', () => {
                innerTabCurrent.classList.add('inner-tab-active');
                innerTabApproved.classList.remove('inner-tab-active');
                innerTabArchived.classList.remove('inner-tab-active');
                innerPanelCurrent.classList.add('inner-panel-active');
                innerPanelApproved.classList.remove('inner-panel-active');
                innerPanelArchived.classList.remove('inner-panel-active');
            });
        }
        
        if(innerTabApproved) {
            innerTabApproved.addEventListener('click', () => {
                innerTabApproved.classList.add('inner-tab-active');
                innerTabCurrent.classList.remove('inner-tab-active');
                innerTabArchived.classList.remove('inner-tab-active');
                innerPanelApproved.classList.add('inner-panel-active');
                innerPanelCurrent.classList.remove('inner-panel-active');
                innerPanelArchived.classList.remove('inner-panel-active');
            });
        }
        
        if(innerTabArchived) {
            innerTabArchived.addEventListener('click', () => {
                innerTabArchived.classList.add('inner-tab-active');
                innerTabCurrent.classList.remove('inner-tab-active');
                innerTabApproved.classList.remove('inner-tab-active');
                innerPanelArchived.classList.add('inner-panel-active');
                innerPanelCurrent.classList.remove('inner-panel-active');
                innerPanelApproved.classList.remove('inner-panel-active');
                renderArchivedProposalsTable();
            });
        }
        // --- END Inner Tab Listeners ---

        // --- Column filter listeners for Current Proposals ---
        const colFilterIds = ['col-filter-productType','col-filter-description','col-filter-status','col-filter-owner','col-filter-createdOn','col-filter-createdBy','filter-proposal-fy'];
        colFilterIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const ev = (el.tagName.toLowerCase() === 'select' || el.type === 'date') ? 'change' : 'input';
            el.addEventListener(ev, () => renderProposalsTable());
        });

        // --- Column filter listeners for Approved Proposals ---
        const approvedFilterIds = ['col-filter-approved-productType','col-filter-approved-description','col-filter-approved-owner','col-filter-approved-approvedBy','col-filter-approved-approvedOn','col-filter-approved-createdOn','col-filter-approved-createdBy','filter-approved-fy'];
        approvedFilterIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const ev = (el.tagName.toLowerCase() === 'select' || el.type === 'date') ? 'change' : 'input';
            el.addEventListener(ev, () => renderApprovedProposalsTable());
        });

        // --- Column filter listeners for Archived Proposals ---
        const archivedFilterIds = ['col-filter-arch-productType','col-filter-arch-description','col-filter-arch-status','col-filter-arch-owner','col-filter-arch-rejectedBy','col-filter-arch-rejectedOn','col-filter-arch-createdOn','col-filter-arch-createdBy','filter-archived-fy'];
        archivedFilterIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const ev = (el.tagName.toLowerCase() === 'select' || el.type === 'date') ? 'change' : 'input';
            el.addEventListener(ev, () => renderArchivedProposalsTable());
        });

        // --- Clear Filters helpers ---
        const getCurrentFy = () => {
            const today = new Date();
            const month = today.getMonth();
            const year = today.getFullYear();
            const startYear = month >= 3 ? year : year - 1;
            return `${startYear}-${startYear + 1}`;
        };

        function clearCurrentFilters() {
            const ids = ['col-filter-productType','col-filter-description','col-filter-status','col-filter-owner','col-filter-createdOn','col-filter-createdBy'];
            ids.forEach(id => { const el = document.getElementById(id); if (!el) return; el.value = ''; if (el.tagName.toLowerCase() === 'input') el.dispatchEvent(new Event('input')); else el.dispatchEvent(new Event('change')); });
            const fyEl = document.getElementById('filter-proposal-fy'); if (fyEl) { Array.from(fyEl.options).forEach(opt => opt.selected = true); fyEl.dispatchEvent(new Event('change')); }
            renderProposalsTable();
        }

        function clearApprovedFilters() {
            const ids = ['col-filter-approved-productType','col-filter-approved-description','col-filter-approved-owner','col-filter-approved-approvedBy','col-filter-approved-approvedOn','col-filter-approved-createdOn','col-filter-approved-createdBy'];
            ids.forEach(id => { const el = document.getElementById(id); if (!el) return; el.value = ''; if (el.tagName.toLowerCase() === 'input') el.dispatchEvent(new Event('input')); else el.dispatchEvent(new Event('change')); });
            const fyEl = document.getElementById('filter-approved-fy'); if (fyEl) { Array.from(fyEl.options).forEach(opt => opt.selected = (opt.value === getCurrentFy())); fyEl.dispatchEvent(new Event('change')); }
            renderApprovedProposalsTable();
        }

        function clearArchivedFilters() {
            const ids = ['col-filter-arch-productType','col-filter-arch-description','col-filter-arch-status','col-filter-arch-owner','col-filter-arch-rejectedBy','col-filter-arch-rejectedOn','col-filter-arch-createdOn','col-filter-arch-createdBy'];
            ids.forEach(id => { const el = document.getElementById(id); if (!el) return; el.value = ''; if (el.tagName.toLowerCase() === 'input') el.dispatchEvent(new Event('input')); else el.dispatchEvent(new Event('change')); });
            const fyEl = document.getElementById('filter-archived-fy'); if (fyEl) { Array.from(fyEl.options).forEach(opt => opt.selected = (opt.value === getCurrentFy())); fyEl.dispatchEvent(new Event('change')); }
            renderArchivedProposalsTable();
        }

        function clearNewProductsFilters() {
            const ids = ['col-filter-wip-productName','col-filter-wip-proposalId','col-filter-wip-vendorName','col-filter-wip-status','col-filter-wip-owner','col-filter-wip-createdOn','col-filter-wip-createdBy','col-filter-launched-productName','col-filter-launched-proposalId','col-filter-launched-vendorName','col-filter-launched-owner','col-filter-launched-createdOn','col-filter-launched-createdBy','col-filter-launched-launchedOn','col-filter-launched-launchedBy','col-filter-withdrawn-productName','col-filter-withdrawn-proposalId','col-filter-withdrawn-vendorName','col-filter-withdrawn-owner','col-filter-withdrawn-createdOn','col-filter-withdrawn-createdBy','col-filter-withdrawn-withdrawnOn','col-filter-withdrawn-withdrawnBy'];
            ids.forEach(id => { const el = document.getElementById(id); if (!el) return; 
                if (el.tagName.toLowerCase() === 'input' || el.tagName.toLowerCase() === 'select') {
                    if (el.type === 'date') el.value = '';
                    else el.value = '';
                } else { el.value = ''; }
                const ev = (el.tagName.toLowerCase() === 'select' || el.type === 'date') ? 'change' : 'input';
                el.dispatchEvent(new Event(ev));
            });
            const fyEl = document.getElementById('filter-new-products-fy'); if (fyEl) { Array.from(fyEl.options).forEach(opt => opt.selected = (opt.value === getCurrentFy())); fyEl.dispatchEvent(new Event('change')); }
            renderNewProductsList();
        }

        // Wire clear buttons (if present)
        const clearCurrBtn = document.getElementById('clear-filters-current'); if (clearCurrBtn) clearCurrBtn.addEventListener('click', clearCurrentFilters);
        const clearApprBtn = document.getElementById('clear-filters-approved'); if (clearApprBtn) clearApprBtn.addEventListener('click', clearApprovedFilters);
        const clearArchBtn = document.getElementById('clear-filters-archived'); if (clearArchBtn) clearArchBtn.addEventListener('click', clearArchivedFilters);
        const clearNewBtn = document.getElementById('clear-filters-new-products'); if (clearNewBtn) clearNewBtn.addEventListener('click', clearNewProductsFilters);


        // --- ADDED: Inner Tab Listeners for New Products List ---
        const innerTabWip = document.getElementById('inner-tab-wip');
        const innerTabLaunched = document.getElementById('inner-tab-launched');
        const innerTabWithdrawn = document.getElementById('inner-tab-withdrawn');
        const innerPanelWip = document.getElementById('inner-panel-wip');
        const innerPanelLaunched = document.getElementById('inner-panel-launched');
        const innerPanelWithdrawn = document.getElementById('inner-panel-withdrawn');
        
        const allNewProductTabs = [innerTabWip, innerTabLaunched, innerTabWithdrawn];
        const allNewProductPanels = [innerPanelWip, innerPanelLaunched, innerPanelWithdrawn];

        if(innerTabWip) {
            innerTabWip.addEventListener('click', () => {
                allNewProductTabs.forEach(t => t.classList.remove('inner-tab-active'));
                allNewProductPanels.forEach(p => p.classList.remove('inner-panel-active'));
                innerTabWip.classList.add('inner-tab-active');
                innerPanelWip.classList.add('inner-panel-active');
                // Show Transfer Ownership bulk button only on WIP tab
                const bulkBtn = document.getElementById('btn-transfer-wip-owner-bulk');
                if (bulkBtn) bulkBtn.classList.remove('hidden');
                // If user had an active transfer (modal or bulk mode), cancel it when switching tabs
                try { if (isBulkTransferMode) cancelBulkTransferMode(true); } catch(e) {}
                try { const tmodal = document.getElementById('transfer-owner-modal'); if (tmodal && !tmodal.classList.contains('hidden')) { tmodal.classList.add('hidden'); productsToTransfer = []; currentWipId = null; currentProposalId = null; } } catch(e) {}
            });
        }
        if(innerTabLaunched) {
            innerTabLaunched.addEventListener('click', () => {
                allNewProductTabs.forEach(t => t.classList.remove('inner-tab-active'));
                allNewProductPanels.forEach(p => p.classList.remove('inner-panel-active'));
                innerTabLaunched.classList.add('inner-tab-active');
                innerPanelLaunched.classList.add('inner-panel-active');
                // Hide Transfer Ownership bulk button on non-WIP tabs
                const bulkBtn = document.getElementById('btn-transfer-wip-owner-bulk');
                if (bulkBtn) bulkBtn.classList.add('hidden');
                // Cancel transfer operations if active
                try { if (isBulkTransferMode) cancelBulkTransferMode(true); } catch(e) {}
                try { const tmodal = document.getElementById('transfer-owner-modal'); if (tmodal && !tmodal.classList.contains('hidden')) { tmodal.classList.add('hidden'); productsToTransfer = []; currentWipId = null; currentProposalId = null; } } catch(e) {}
            });
        }
        if(innerTabWithdrawn) {
            innerTabWithdrawn.addEventListener('click', () => {
                allNewProductTabs.forEach(t => t.classList.remove('inner-tab-active'));
                allNewProductPanels.forEach(p => p.classList.remove('inner-panel-active'));
                innerTabWithdrawn.classList.add('inner-tab-active');
                innerPanelWithdrawn.classList.add('inner-panel-active');
                // Hide Transfer Ownership bulk button on non-WIP tabs
                const bulkBtn = document.getElementById('btn-transfer-wip-owner-bulk');
                if (bulkBtn) bulkBtn.classList.add('hidden');
                // Cancel transfer operations if active
                try { if (isBulkTransferMode) cancelBulkTransferMode(true); } catch(e) {}
                try { const tmodal = document.getElementById('transfer-owner-modal'); if (tmodal && !tmodal.classList.contains('hidden')) { tmodal.classList.add('hidden'); productsToTransfer = []; currentWipId = null; currentProposalId = null; } } catch(e) {}
            });
        }
        // Ensure initial visibility of the Transfer Ownership bulk button
        (function(){ const bulkBtnInit = document.getElementById('btn-transfer-wip-owner-bulk'); if (!bulkBtnInit) return; if (innerTabWip && innerTabWip.classList.contains('inner-tab-active')) bulkBtnInit.classList.remove('hidden'); else bulkBtnInit.classList.add('hidden'); })();
        // --- END: Inner Tab Listeners for New Products List ---

        // --- Column filter listeners for New Products (WIP / Launched / Withdrawn) ---
        const newProductsFilterIds = ['col-filter-wip-productName','col-filter-wip-proposalId','col-filter-wip-vendorName','col-filter-wip-status','col-filter-wip-owner','col-filter-wip-createdOn','col-filter-wip-createdBy','col-filter-launched-productName','col-filter-launched-proposalId','col-filter-launched-vendorName','col-filter-launched-owner','col-filter-launched-createdOn','col-filter-launched-createdBy','col-filter-launched-launchedOn','col-filter-launched-launchedBy','col-filter-withdrawn-productName','col-filter-withdrawn-proposalId','col-filter-withdrawn-vendorName','col-filter-withdrawn-owner','col-filter-withdrawn-createdOn','col-filter-withdrawn-createdBy','col-filter-withdrawn-withdrawnOn','col-filter-withdrawn-withdrawnBy','filter-new-products-fy'];
        newProductsFilterIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const ev = (el.tagName.toLowerCase() === 'select' || el.type === 'date') ? 'change' : 'input';
            el.addEventListener(ev, () => renderNewProductsList());
        });



        const newOwnerSearch = document.getElementById('newOwnerSearch');
        const ownerSearchResults = document.getElementById('owner-search-results');
        const newOwnerNameInput = document.getElementById('newOwnerName');

        newOwnerSearch.addEventListener('input', () => {
            const searchTerm = newOwnerSearch.value.toLowerCase();
            ownerSearchResults.innerHTML = '';
            
            if (searchTerm.length < 1) {
                ownerSearchResults.classList.add('hidden');
                return;
            }
            
            // --- MODIFICATION START: Filter out the current owner(s) ---
            let ownersToExclude = new Set(); 

            if (currentWipId) { // 1. Single WIP Task transfer
                const task = wipTasks.find(t => t.id === currentWipId);
                // Only exclude current owner in employee view; manager can transfer to anyone
                if (task && !isManagerView) ownersToExclude.add(task.owner);
            } else if (currentProposalId) { // 2. Proposal transfer
                const proposal = proposals.find(p => p.id === currentProposalId);
                if (proposal && !isManagerView) ownersToExclude.add(proposal.owner);
                // Also exclude owners of any products being transferred with the proposal (only in employee view)
                if (!isManagerView) {
                    productsToTransfer.forEach(taskId => {
                        const task = wipTasks.find(t => t.id === taskId);
                        if (task) ownersToExclude.add(task.owner);
                    });
                }
            } else if (productsToTransfer.length > 0) { // 3. Bulk Product transfer
                // This is a bulk product transfer (no proposal context).
                // In manager view, allow transfer to anyone. In employee view, exclude current owners.
                if (!isManagerView) {
                    productsToTransfer.forEach(taskId => {
                        const task = wipTasks.find(t => t.id === taskId);
                        if (task) ownersToExclude.add(task.owner);
                    });
                }
            }

            // --- NEW FIX ---
            // If in Employee view, always exclude the current user from the list of recipients.
            if (!isManagerView && currentUser) {
                // ownersToExclude.add(currentUser.name); // <-- REMOVED THIS LINE
            }
            // --- END NEW FIX ---

            const results = dummyEmployees.filter(emp => {
                // --- MODIFICATION START ---
                // Apply exclusion logic based on view type and context
                if (!isManagerView) { 
                    // In employee view, hide the current user
                    if (emp.name === currentUser.name) {
                        return false;
                    }
                }
                // In manager view, show all employees (no exclusions)
                // --- MODIFICATION END ---
                
                // Standard search logic
                return emp.name.toLowerCase().includes(searchTerm) || 
                       emp.id.toLowerCase().includes(searchTerm);
            });
            // --- MODIFICATION END ---

            if (results.length > 0) {
                results.forEach(emp => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'p-2 hover:bg-indigo-100 cursor-pointer';
                    resultItem.textContent = `${emp.name} (${emp.id})`;
                    resultItem.addEventListener('click', () => {
                        newOwnerSearch.value = `${emp.name} (${emp.id})`;
                        newOwnerNameInput.value = emp.name;
                        ownerSearchResults.classList.add('hidden');
                        ownerSearchResults.innerHTML = '';
                    });
                    ownerSearchResults.appendChild(resultItem);
                });
                ownerSearchResults.classList.remove('hidden');
            } else {
                ownerSearchResults.classList.add('hidden');
            }
        });

        document.addEventListener('click', function(event) {
            const ownerSearchContainer = newOwnerSearch.parentElement;
            if (!ownerSearchContainer.contains(event.target)) {
                ownerSearchResults.classList.add('hidden');
            }
        });

        document.getElementById('transfer-owner-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const newOwner = newOwnerNameInput.value;

            if (!newOwner) {
                alert('Please select a valid employee from the search results.');
                return;
            }
            
            // --- MODIFICATION START: Re-ordered logic to prioritize WIP transfer ---
            if (currentWipId) {
                // This is the logic for transferring a single WIP task (from wipDetail view)
                const originalTask = wipTasks.find(t => t.id === currentWipId);
                if (originalTask && newOwner) {
                    
                    // Simply change the owner of the original task
                    originalTask.owner = newOwner;
                    
                    // Refresh all relevant views
                    renderProposalTasksView();
                    renderSummaryTable();
                    renderNewProductsList();
                    
                    // If we were on the approved proposal detail view, re-render it. The list of products will update.
                    if (contextIsFromApprovedTab || (originalTask.proposalId && proposals.find(p => p.id === originalTask.proposalId)?.isApproved)) {
                        renderProposalDetail(false, true);
                    }

                    // Since the task is gone from the current user's view (in Employee mode),
                    // we should navigate away from the detail page if we're on it.
                    if (!isManagerView) {
                        // Go back to whatever list view we came from
                        switch (currentWipDetailBackView) {
                            case 'summary':
                                showView('summary');
                                break;
                            case 'newProductsList':
                                showView('newProductsList');
                                break;
                            case 'approvedProposalDetail':
                                showView('proposalDetail');
                                break;
                            case 'proposalTasks':
                            default:
                                showView('proposalTasks');
                                break;
                        }
                    } else if (isManagerView) {
                        // If manager, check where they came from
                        if (currentWipDetailBackView === 'summary') {
                            showView('summary'); // Go back to summary
                        } else {
                            // Otherwise, just re-render the detail view
                            renderWipDetail();
                            showView('wipDetail'); // <-- Make sure to show the view
                        }
                    }
                }
            } else if (currentProposalId) {
                // This is the logic for transferring a proposal
                const p = proposals.find(prop => prop.id === currentProposalId);
                if (p) {
                    // --- MODIFICATION START ---
                    // ALWAYS transfer the proposal owner in this block.
                    // This was the missing piece.
                    p.owner = newOwner;
                    // --- MODIFICATION END ---

                    // If products were selected, transfer them too
                    if (productsToTransfer.length > 0) {
                        productsToTransfer.forEach(taskId => {
                            const task = wipTasks.find(t => t.id === taskId);
                            if (task) {
                                task.owner = newOwner;
                            }
                        });
                        // After transferring products, we must also refresh the product-related lists
                        renderProposalTasksView(); 
                        renderSummaryTable(); 
                        renderNewProductsList();
                    }

                    // Refresh all list views
                    renderProposalsTable();
                    renderApprovedProposalsTable();
                    renderArchivedProposalsTable();
                    
                    // --- MODIFICATION START ---
                    // If employee view, navigate away from detail view
                    // if (!isManagerView) { // <-- OLD
                    //      showView('proposals'); // Go back to the proposal list // <-- OLD
                    // } else if (isManagerView) { // <-- OLD
                    //     // If manager, just re-render the detail view to show new owner // <-- OLD
                    //     renderProposalDetail(false, contextIsFromApprovedTab); // <-- OLD
                    //     showView('proposalDetail'); // <-- Make sure to show the view // <-- OLD
                    // } // <-- OLD

                    // If this was a proposal-owner-only transfer (no products selected),
                    // redirect to the proposals list. If products were selected (bulk transfer),
                    // do NOT redirect  instead refresh product lists and keep the current view.
                    if (!productsToTransfer || productsToTransfer.length === 0) {
                        showView('proposals'); // Go back to the proposal list
                    } else {
                        // For bulk product transfer, refresh lists and remain on the current page
                        renderProposalTasksView();
                        renderSummaryTable();
                        renderNewProductsList();
                    }
                    // --- MODIFICATION END ---
                }
            // --- MODIFICATION START: Added new 'else if' block ---
            } else if (productsToTransfer.length > 0) {
                // This is the new bulk product transfer logic
                let transferredCount = 0;
                let firstProposalId = null; // <-- ADD
                let allFromSameProposal = true; // <-- ADD
                
                const tasksToTransfer = productsToTransfer.map(taskId => wipTasks.find(t => t.id === taskId)).filter(Boolean); // <-- ADD
                
                if (tasksToTransfer.length > 0) { // <-- ADD
                    firstProposalId = tasksToTransfer[0].proposalId; // <-- ADD
                    for (const task of tasksToTransfer) { // <-- ADD
                        if (task.proposalId !== firstProposalId) { // <-- ADD
                            allFromSameProposal = false; // <-- ADD
                            break; // <-- ADD
                        } // <-- ADD
                    } // <-- ADD
                } // <-- ADD

                // Transfer products
                tasksToTransfer.forEach(task => { // <-- MODIFIED
                    task.owner = newOwner;
                    transferredCount++;
                });

                // --- NEW LOGIC ---
                // If all transferred products are from the same proposal,
                // check if we should transfer the proposal itself.
                if (allFromSameProposal && firstProposalId) {
                    // Find all products (not just selected ones) for this proposal
                    const allProductsForProposal = wipTasks.filter(t => t.proposalId === firstProposalId);
                    
                    // --- MODIFICATION ---
                    // If all selected products are from the same proposal, transfer the proposal as well,
                    // regardless of whether *all* products from that proposal were selected.
                    // (Removed the "allProductsForProposal.length === tasksToTransfer.length" check)
                    const proposal = proposals.find(p => p.id === firstProposalId);
                    if (proposal) {
                        proposal.owner = newOwner;
                        // Also refresh proposal tables
                        renderProposalsTable();
                        renderApprovedProposalsTable();
                        renderArchivedProposalsTable();
                    }
                    // --- MODIFICATION END ---
                }
                // --- END NEW LOGIC ---

                // Refresh all relevant views
                renderSummaryTable();
                renderNewProductsList();
                
                // Show an alert
                showAlertModal('Transfer Complete', `Successfully transferred ${transferredCount} products to ${newOwner}.`);
            }
            // --- MODIFICATION END ---
            
            document.getElementById('transfer-owner-modal').classList.add('hidden');
            
            // --- MODIFICATION START ---
            // Only clear currentProposalId if we are NOT on a proposal detail page.
            // We clear currentWipId because that's a single-task transfer which is now done.
            // We clear productsToTransfer because that's a bulk transfer which is now done.
            // If currentWipId was set, or productsToTransfer was set, we were on a page
            // (like proposalDetail) that we are returning to, so we MUST keep currentProposalId.
            // We only clear currentProposalId if it was a transfer of the proposal itself (Scenario 2),
            // in which case currentWipId is null AND productsToTransfer is empty.
            if (currentWipId === null && productsToTransfer.length === 0) {
                currentProposalId = null; 
            }
            currentWipId = null; 
            productsToTransfer = [];
            // --- MODIFICATION END ---
    });

    document.getElementById('yes-no-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const task = wipTasks.find(t => t.id === currentWipId);
            if (!task || !currentStage) return;

            const stage = task.stages[currentStage];
            const selectedValue = document.getElementById('yesNoSelect').value;

            if (stage.data.length > 0) {
                stage.data[0].value = selectedValue;
            } else {
                stage.data.push({ id: Date.now(), value: selectedValue });
            }
            
            document.getElementById('yes-no-modal').classList.add('hidden');
            renderWipDetail();
            currentStage = null;
        });

        document.getElementById('cancel-final-approval-btn').addEventListener('click', () => document.getElementById('final-approval-modal').classList.add('hidden'));
        document.getElementById('btn-create-proposal').addEventListener('click', handleCreateProposalClick);
        
        document.querySelectorAll('.back-to-detail-btn').forEach(btn => btn.addEventListener('click', () => { 
            renderProposalDetail(false, contextIsFromApprovedTab); 
            showView('proposalDetail'); 
        }));
        document.querySelector('.back-to-approved-list-btn').addEventListener('click', () => showView('approvedProposals'));
        document.querySelector('.back-to-proposal-tasks-btn').addEventListener('click', () => showView('proposalTasks'));
        
        document.getElementById('btn-add-commercials').addEventListener('click', () => {
            document.getElementById('add-product-form').reset();
            document.getElementById('add-product-modal').classList.remove('hidden');
        });

        document.querySelector('.back-to-wip-detail-btn').addEventListener('click', () => {
            renderWipDetail(); // This will now re-render the view using the stored backView
            showView('wipDetail');
        });
        document.getElementById('btn-add-wip-entry').addEventListener('click', () => openWipStageEntryModal());
        document.getElementById('save-wip-stage-entry-btn').addEventListener('click', handleSaveWipStageEntry);
        document.getElementById('btn-add-stage-entry').addEventListener('click', () => { currentEntryId = null; openStageEntryModal(); });
        document.getElementById('save-stage-entry-btn').addEventListener('click', handleSaveStageEntry);
        
        document.getElementById('confirm-final-approval-btn').addEventListener('click', handleApproveProposal);
        // --- MODIFICATION START ---
        document.getElementById('reject-selected-commercials-btn').addEventListener('click', handleRejectSelectedCommercials);
        document.getElementById('reject-selected-pending-variants-btn').addEventListener('click', handleRejectSelectedPendingVariants);
        // --- MODIFICATION END ---
        document.getElementById('confirm-pending-variants-approval-btn').addEventListener('click', handleApproveSelectedPendingVariants);
        document.getElementById('cancel-pending-variants-approval-btn').addEventListener('click', () => document.getElementById('pending-variants-approval-modal').classList.add('hidden'));

        document.getElementById('card-vendor').addEventListener('click', () => { currentStage = 'vendorIdentification'; renderStageDetail(); showView('stageDetail'); });
        document.getElementById('card-sample').addEventListener('click', () => { currentStage = 'sample'; renderStageDetail(); showView('stageDetail'); });
        document.getElementById('card-commercials').addEventListener('click', () => { currentStage = 'commercials'; renderStageDetail(); showView('stageDetail'); });
        document.getElementById('card-agreement-proposal').addEventListener('click', () => { currentStage = 'agreementProposal'; renderStageDetail(); showView('stageDetail'); });
        document.getElementById('proposal-form').addEventListener('submit', handleProposalFormSubmit);
        document.getElementById('edit-product-name-form').addEventListener('submit', handleSaveProductName);
        
        // Old product-type/status filters removed; column filters in table header replace them.
        // Guard all event listener attachments in case some top-level filters were removed.
        const summaryFyEl = document.getElementById('summary-fy-filter');
        if (summaryFyEl) summaryFyEl.addEventListener('change', renderSummaryTable);
        
        // Column filter listeners for Summary table
        const summaryFilterIds = ['col-filter-summary-empId', 'col-filter-summary-empName', 'summary-fy-filter'];
        summaryFilterIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const ev = (el.tagName.toLowerCase() === 'select' || el.type === 'date') ? 'change' : 'input';
            // --- MODIFICATION START ---
            // Attach ALL listeners here. They are static now.
            el.addEventListener(ev, () => renderSummaryTable());
            // --- MODIFICATION END ---
        });
        
        // Clear filters button for Summary
        const clearSummaryBtn = document.getElementById('clear-filters-summary');
        if (clearSummaryBtn) {
            clearSummaryBtn.addEventListener('click', () => {
                const ids = ['col-filter-summary-empId', 'col-filter-summary-empName'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    el.value = '';
                    if (el.tagName.toLowerCase() === 'input') el.dispatchEvent(new Event('input'));
                });
                const fyEl = document.getElementById('summary-fy-filter');
                if (fyEl) {
                    Array.from(fyEl.options).forEach(opt => opt.selected = (opt.value === getCurrentFy()));
                    fyEl.dispatchEvent(new Event('change'));
                }
                renderSummaryTable();
            });
        }

        const propFyEl = document.getElementById('filter-proposal-fy');
        if (propFyEl) propFyEl.addEventListener('change', renderProposalsTable);

        const apprFyEl = document.getElementById('filter-approved-fy');
        if (apprFyEl) apprFyEl.addEventListener('change', renderApprovedProposalsTable);

        const apprProdTypeEl = document.getElementById('filter-approved-product-type');
        if (apprProdTypeEl) apprProdTypeEl.addEventListener('change', renderApprovedProposalsTable);

        const archFyEl = document.getElementById('filter-archived-fy');
        if (archFyEl) archFyEl.addEventListener('change', renderArchivedProposalsTable);

        const archProdTypeEl = document.getElementById('filter-archived-product-type');
        if (archProdTypeEl) archProdTypeEl.addEventListener('change', renderArchivedProposalsTable);

        const archStatusEl = document.getElementById('filter-archived-status');
        if (archStatusEl) archStatusEl.addEventListener('change', renderArchivedProposalsTable);

        // --- ADDED ---
        const newProdFyEl = document.getElementById('filter-new-products-fy');
        if (newProdFyEl) newProdFyEl.addEventListener('change', renderNewProductsList);
        // --- END ADDED ---

        const productTypeSelect = document.getElementById('productType');
        const form = document.getElementById('proposal-form');
        const auditForm = form.querySelector('#auditForm');
        const composition = form.querySelector('#composition');
        const catL1 = form.querySelector('#categoryL1');
        const catL2 = form.querySelector('#categoryL2');
        const catL3 = form.querySelector('#categoryL3');
        productTypeSelect.innerHTML = '<option value="">Select Type</option><option value="Pharma">Pharma</option><option value="FMCG">FMCG</option><option value="Surgical">Surgical</option><option value="Device">Device</option>';
        auditForm.innerHTML = '<option value="">Select Form</option>' + ['Tablets','Ointments','Liquids','General','Injections','Surgicals','Containers','Powders','Drops','Inhalers','Fridge Items','Frames','Lens'].map(o => `<option>${o}</option>`).join('');
        productTypeSelect.addEventListener('change', (e) => {
            const type = e.target.value;
            // Reset required flags
            auditForm.required = false;
            composition.required = false;
            catL1.required = false;
            catL2.required = false;
            catL3.required = false;

            // Toggle the mandatory-star indicators
            form.querySelectorAll('.mandatory-star').forEach(star => {
                star.style.display = star.dataset.reqFor.split(' ').includes(type) ? 'inline' : 'none';
            });

            // Pack size container (appears only for Pharma)
            const packContainer = document.getElementById('packSize-container');
            const packInput = document.getElementById('packSize');

            if (type === 'Pharma') {
                auditForm.required = true;
                composition.required = true;
                if (packContainer) packContainer.classList.remove('hidden');
            } else {
                if (['FMCG', 'Surgical', 'Device'].includes(type)) {
                    catL1.required = true;
                    catL2.required = true;
                    catL3.required = true;
                }
                if (packContainer) packContainer.classList.add('hidden');
                if (packInput) packInput.value = '';
            }
        });
        catL1.innerHTML = '<option value="">Select L1</option>' + Object.keys(categoryData).map(k => `<option value="${k}">${k}</option>`).join('');
        catL1.addEventListener('change', () => { const l1Value = catL1.value; catL2.innerHTML = '<option value="">Select L2</option>'; catL3.innerHTML = '<option value="">Select L3</option>'; catL2.disabled = true; catL3.disabled = true; if (l1Value && categoryData[l1Value]) { catL2.innerHTML += Object.keys(categoryData[l1Value]).map(k => `<option value="${k}">${k}</option>`).join(''); catL2.disabled = false; } });
        catL2.addEventListener('change', () => { const l1Value = catL1.value; const l2Value = catL2.value; catL3.innerHTML = '<option value="">Select L3</option>'; catL3.disabled = true; if (l1Value && l2Value && categoryData[l1Value][l2Value]) { catL3.innerHTML += categoryData[l1Value][l2Value].map(k => `<option value="${k}">${k}</option>`).join(''); catL3.disabled = false; } });
        populateFyFilters();
        renderProposalsTable();
        renderApprovedProposalsTable();
        renderArchivedProposalsTable();
        renderSummaryTable();
        renderNewProductsList();

        showDashboard(); // <--- MOVED TO HERE, AT THE VERY END
    });

    // --- NEW Reusable Alert Function ---
    function showAlertModal(title, text, confirmButtonText = "OK") {
        const modal = document.getElementById('confirmation-modal');
        document.getElementById('confirmation-modal-title').innerText = title;
        document.getElementById('confirmation-modal-text').innerText = text;
        
        // Hide the details container
        document.getElementById('confirmation-modal-details').classList.add('hidden');
        document.getElementById('confirmation-modal-details').innerHTML = '';

        // Configure buttons
        const confirmBtn = document.getElementById('confirmation-modal-confirm-btn');
        const cancelBtn = document.getElementById('confirmation-modal-cancel-btn');
        
        confirmBtn.innerText = confirmButtonText;
        confirmBtn.className = 'bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition'; // Make it blue
        
        // Hide the cancel button
        cancelBtn.classList.add('hidden');
        
        // Set the action to just close the modal (it will be called by the existing listener)
        confirmationAction = () => {
            // No action, just close
        };
        
        modal.classList.remove('hidden');
    }

    // --- MODIFICATION START: Added new functions ---
    function handleRejectSelectedCommercials() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;

        const selectedCommercialInputs = document.querySelectorAll('#final-approval-form input[name="selectedCommercial"]:checked');
        if (selectedCommercialInputs.length === 0) {
            alert('Please select at least one variant to reject.');
            return;
        }

        // Initialize rejectedCommercialIds if it doesn't exist
        if (!p.rejectedCommercialIds) {
            p.rejectedCommercialIds = [];
        }

        let rejectedCount = 0;
        selectedCommercialInputs.forEach(input => {
            const selectedCommercialId = parseInt(input.value);
            const commercial = p.commercials.data.find(c => c.id === selectedCommercialId);
            if (commercial && commercial.status === 'Completed' && !p.rejectedCommercialIds.includes(selectedCommercialId)) {
                // Keep commercial status as 'Completed', just add to rejectedCommercialIds
                p.rejectedCommercialIds.push(selectedCommercialId);
                rejectedCount++;
            }
        });

        if (rejectedCount > 0) {
            // Recalculate proposal status
            calculateProposalStatus(p); 
        }

        document.getElementById('final-approval-modal').classList.add('hidden');
        // Re-render the detail view to show new status and potentially hide approve button
        renderProposalDetail(false, contextIsFromApprovedTab); 
    }

    function handleRejectSelectedPendingVariants() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;

        const selectedVariantInputs = document.querySelectorAll('#pending-variants-approval-form input[name="selectedPendingVariant"]:checked');
        if (selectedVariantInputs.length === 0) {
            alert('Please select at least one variant to reject.');
            return;
        }

        // Initialize rejectedCommercialIds if it doesn't exist
        if (!p.rejectedCommercialIds) {
            p.rejectedCommercialIds = [];
        }

        let rejectedCount = 0;
        selectedVariantInputs.forEach(input => {
            const selectedCommercialId = parseInt(input.value);
            const commercial = p.commercials.data.find(c => c.id === selectedCommercialId);
            if (commercial && commercial.status === 'Completed' && !p.rejectedCommercialIds.includes(selectedCommercialId)) {
                // Keep commercial status as 'Completed', just add to rejectedCommercialIds
                p.rejectedCommercialIds.push(selectedCommercialId);
                rejectedCount++;
            }
        });

        document.getElementById('pending-variants-approval-modal').classList.add('hidden');
        // Re-render the detail view to show new status
        renderProposalDetail(false, true); 
    }
    
    // --- MODIFICATION START: Added missing function ---
    function openPendingVariantsApprovalModal() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;

        const contentContainer = document.getElementById('pending-variants-approval-content');
        
        const allCommercials = p.commercials.data;
        const approvedIds = p.approvedCommercialIds || [];
        
        // This logic finds variants that are "Completed" and whose sample/vendor are also "Completed"
        const pendingCommercials = allCommercials.filter(comm => {
            if (approvedIds.includes(comm.id) || comm.status !== 'Completed') {
                return false;
            }
            const sample = p.sample.data.find(s => s.id == comm.sampleId);
            if (!sample || sample.status !== 'Completed') {
                return false;
            }
            const vendor = p.vendorIdentification.data.find(v => v.id == sample.vendorId);
            if (!vendor || vendor.status !== 'Completed') {
                return false;
            }
            if (p.rejectedCommercialIds && p.rejectedCommercialIds.includes(comm.id)) {
                return false;
            }
            return true;
        });

        pendingCommercials.sort((a, b) => b.id - a.id);

        const headers = ['Select', 'Vendor', 'Sample', 'Product Variant', 'Product Cost (Per Unit)', 'Logistics Cost (Per Unit)', 'Total Landed Cost (Per Unit)', 'Employee Incentive %', 'Probable SP (Per Unit)', 'Margin', 'Margin %', 'Tentative MRP (Per Unit)', 'MOQ', 'GST %', 'Expected Total Investment', 'Lead Time', 'Advance %', 'Balance Payment', 'Credit Days', 'Tentative Launch Date'];

        const headerCells = headers.map((h, index) => {
            if (index === 0) {
                return `<th class="px-3 py-3 text-left font-semibold text-slate-500 uppercase tracking-wider"><input type="checkbox" id="select-all-pending-variants" class="h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500"></th>`;
            }
            return `<th class="px-3 py-3 text-left font-semibold text-slate-500 uppercase tracking-wider">${h}</th>`;
        }).join('');

        let tableHtml = `<form id="pending-variants-approval-form"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-200 text-sm">
                            <thead class="bg-slate-50/75"><tr>
                                ${headerCells}
                            </tr></thead>
                            <tbody class="bg-white divide-y divide-slate-200">`;

        pendingCommercials.forEach((comm, index) => {
            const vendor = p.vendorIdentification.data.find(v => v.id == comm.vendorId);
            const sample = p.sample.data.find(s => s.id == comm.sampleId);

            const today = new Date(); // Assuming today is the approval date
            const launchDate = new Date(today);
            launchDate.setDate(today.getDate() + (parseInt(comm.leadTime) || 0));
            const tentativeLaunchDate = formatDateToDDMMYYYY(launchDate.toISOString().split('T')[0]);
            const creditDaysText = comm.balancePaymentType === 'After Dispatch' ? (comm.creditDays || '0') : 'N/A';

            tableHtml += `<tr>
                <td class="px-3 py-4 whitespace-nowrap">
                    <input 
                        type="checkbox" 
                        name="selectedPendingVariant" 
                        value="${comm.id}" 
                        class="pending-variant-checkbox h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500"
                    >
                </td>
                <td class="px-3 py-4 whitespace-nowrap">${vendor.vendorName}</td>
                <td class="px-3 py-4 whitespace-nowrap">${sample.sampleName}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.productVariant || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.productCost || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.logisticsCost || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.totalLandedCost || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.employeeIncentivePercentage || '0'}%</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.probableSP || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.margin || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.marginPercentage || ''}${comm.marginPercentage ? '%' : ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.tentativeMRP || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.moq || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.gstPercentage || '0'}%</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.expectedTotalInvestment || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.leadTime || ''} days</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.advancePercentage || '0'}%</td>
                <td class="px-3 py-4 whitespace-nowrap">${comm.balancePaymentType || ''}</td>
                <td class="px-3 py-4 whitespace-nowrap">${creditDaysText}</td>
                <td class="px-3 py-4 whitespace-nowrap">${tentativeLaunchDate}</td>
            </tr>`;
        });

        tableHtml += `</tbody></table></div></form>`;
        contentContainer.innerHTML = tableHtml;

        // Add event listeners for checkbox logic
        const selectAllCheckbox = document.getElementById('select-all-pending-variants');
        const variantCheckboxes = document.querySelectorAll('.pending-variant-checkbox');
        
        selectAllCheckbox.addEventListener('change', (e) => {
            variantCheckboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = e.target.checked;
                }
            });
        });
        
        document.getElementById('pending-variants-approval-modal').classList.remove('hidden');
    }
    // --- MODIFICATION END ---

    // --- MODIFICATION START: Re-added missing function ---
    function handleApproveSelectedPendingVariants() {
        const p = proposals.find(prop => prop.id === currentProposalId);
        if (!p) return;

        const selectedVariantInputs = document.querySelectorAll('#pending-variants-approval-form input[name="selectedPendingVariant"]:checked');
        if (selectedVariantInputs.length === 0) {
            alert('Please select at least one variant to approve.');
            return;
        }

        const selectedCommercialIds = Array.from(selectedVariantInputs).map(input => parseInt(input.value));
        
        if (!p.approvedCommercialIds) p.approvedCommercialIds = [];

        let approvedCount = 0;
        selectedCommercialIds.forEach(commercialId => {
            if (!p.approvedCommercialIds.includes(commercialId)) {
                p.approvedCommercialIds.push(commercialId);

                const selectedCommercial = p.commercials.data.find(c => c.id === commercialId);
                const vendor = p.vendorIdentification.data.find(v => v.id == selectedCommercial.vendorId);
                const productName = `${p.description || p.composition || p.productType}${selectedCommercial.productVariant ? '-' + selectedCommercial.productVariant : ''}`;
                
                // --- MODIFICATION START: Get vendorId and agreements ---
                const selectedVendorId = selectedCommercial.vendorId;
                const agreementsForVendor = p.agreementProposal.data.filter(
                    a => a.vendorId == selectedVendorId && a.source === 'proposal'
                );
                // --- MODIFICATION END ---

                const taskAlreadyExists = wipTasks.some(task => task.proposalId === p.id && task.productName === productName);

                if (!taskAlreadyExists) {
                    const newWipTask = {
                        id: `WIP-${String(Date.now() + approvedCount).slice(-4)}`,
                        proposalId: p.id,
                        commercialId: commercialId, // <-- ***** ADD THIS *****
                        productId: '',
                        productName: productName,
                        vendorName: vendor ? vendor.vendorName : 'N/A',
                        vendorId: vendor ? vendor.id : null,
                        owner: p.owner,
                        createdBy: currentUser.name, // The manager approving it
                        createdDate: formatDateToDDMMYYYY(new Date().toISOString().split('T')[0]),
                        isCancelled: false,
                        stages: { 
                            // --- MODIFICATION START: Use vendor-specific agreements ---
                            agreement: { data: JSON.parse(JSON.stringify(agreementsForVendor)) }, 
                            // --- MODIFICATION END ---
                            artWork: { data: [] }, 
                            pricing: { data: [] }, 
                            branding: { data: [] }, 
                            vendorKYC: { data: [] }, 
                            poReleased: { data: [] }, 
                            productionStarted: { data: [] }, 
                            rawMaterialsProcured: { data: [] }, 
                            packingMaterialProcured: { data: [] }, 
                            grn: { data: [] } 
                        }
                    };
                    wipTasks.push(newWipTask);
                    approvedCount++;
                }
            }
        });

        document.getElementById('pending-variants-approval-modal').classList.add('hidden');
        // Re-render the detail view to reflect the changes
        renderProposalDetail(false, true);
    }
    // --- MODIFICATION END ---

    function populateFyFilters() {
        const filters = ['summary-fy-filter', 'filter-proposal-fy', 'filter-approved-fy', 'filter-archived-fy', 'filter-new-products-fy'];
        const today = new Date(2025, 9, 14); // October 14, 2025
        const getFinancialYear = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth(); // 0-11
            if (month >= 3) { // April (month 3) or later
                return `${year}-${year + 1}`;
            } else { // Jan, Feb, March
                return `${year - 1}-${year}`;
            }
        }
        const currentFy = getFinancialYear(today);
        
        const currentYearStart = today.getMonth() >= 3 ? today.getFullYear() : today.getFullYear() - 1;
        
        let optionsHtml = '';
        // Show current and previous 4 financial years, no future years.
        for (let i = 4; i >= 0; i--) {
            const year = currentYearStart - i;
            const fyValue = `${year}-${year + 1}`;
            const fyText = `${year}-${String(year + 1).slice(-2)}`;
            optionsHtml += `<option value="${fyValue}" ${fyValue === currentFy ? 'selected' : ''}>${fyText}</option>`;
        }
        
        filters.forEach(filterId => {
            const filterEl = document.getElementById(filterId);
            if(filterEl) {
                filterEl.innerHTML = optionsHtml;
                // For Current Proposals tab (filter-proposal-fy), select all by default
                if (filterId === 'filter-proposal-fy') {
                    Array.from(filterEl.options).forEach(opt => opt.selected = true);
                }
                // Upgrade native select into a nicer multiselect UI (keeps native select for logic)
                try { upgradeFyMultiselect(filterId); } catch (e) { console.warn('upgradeFyMultiselect failed for', filterId, e); }
            }
        });
    }

    // --- Fancy FY multiselect UI ---
    function upgradeFyMultiselect(selectId) {
        const sel = document.getElementById(selectId);
        if (!sel) return;
        if (sel.dataset.upgraded === '1') return; // already upgraded

        // inject styles once
        if (!document.getElementById('fy-multiselect-styles')) {
            const style = document.createElement('style');
            style.id = 'fy-multiselect-styles';
            style.innerHTML = `
            .fy-multi { position: relative; display: inline-block; }
            .fy-button { display:inline-flex; align-items:center; justify-content:space-between; gap:8px; width:100%; padding:6px 10px; border:1px solid #cbd5e1; background:white; border-radius:6px; cursor:pointer; }
            .fy-dropdown { position:absolute; z-index:60; background:white; border:1px solid #e2e8f0; box-shadow:0 6px 18px rgba(2,6,23,0.08); border-radius:8px; padding:8px; margin-top:6px; min-width:220px; max-height:220px; overflow:auto; }
            .fy-item { display:flex; align-items:center; gap:8px; padding:6px 4px; }
            .fy-all { font-weight:600; border-bottom:1px solid #f1f5f9; padding-bottom:6px; margin-bottom:6px; }
            `;
            document.head.appendChild(style);
        }

        // hide native select visually but keep in DOM for logic
        sel.style.display = 'none';

        const wrapper = document.createElement('div');
        wrapper.className = 'fy-multi';
        wrapper.style.width = sel.offsetWidth ? sel.offsetWidth + 'px' : '220px';

        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'fy-button';
        button.innerHTML = `<span class="fy-label">All</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;

        const dropdown = document.createElement('div');
        dropdown.className = 'fy-dropdown hidden';
        dropdown.style.display = 'none';

        // build items from select options
        // Add 'All' checkbox at top
        const allDiv = document.createElement('div');
        allDiv.className = 'fy-item fy-all';
        const allChk = document.createElement('input'); allChk.type = 'checkbox'; allChk.id = selectId + '-all';
        const allLbl = document.createElement('label'); allLbl.htmlFor = allChk.id; allLbl.innerText = 'All';
        allDiv.appendChild(allChk); allDiv.appendChild(allLbl);
        dropdown.appendChild(allDiv);

        Array.from(sel.options).forEach((opt, idx) => {
            const item = document.createElement('label');
            item.className = 'fy-item';
            const chk = document.createElement('input'); chk.type = 'checkbox'; chk.value = opt.value; chk.checked = opt.selected || opt.value === 'All'; chk.dataset.index = idx;
            const lbl = document.createElement('span'); lbl.innerText = opt.text || opt.value;
            item.appendChild(chk); item.appendChild(lbl);
            dropdown.appendChild(item);

            chk.addEventListener('change', () => {
                // sync native select option
                if (opt.value === 'All') {
                    // if All checked, select all options
                    if (chk.checked) {
                        Array.from(dropdown.querySelectorAll('input[type="checkbox"]')).forEach(c => { c.checked = (c === chk) ? true : true; });
                        Array.from(sel.options).forEach(o => o.selected = true);
                    } else {
                        Array.from(sel.options).forEach(o => o.selected = false);
                    }
                } else {
                    sel.options[idx].selected = chk.checked;
                    // if any non-All unchecked, uncheck All
                    const allCheckbox = dropdown.querySelector('#' + selectId + '-all');
                    if (allCheckbox && allCheckbox.checked && !chk.checked) allCheckbox.checked = false;
                }
                sel.dispatchEvent(new Event('change'));
                updateFyButtonLabel();
            });
        });

        // clicking All checkbox behavior
        allChk.addEventListener('change', () => {
            if (allChk.checked) {
                Array.from(dropdown.querySelectorAll('input[type="checkbox"]')).forEach(c => c.checked = true);
                Array.from(sel.options).forEach(o => o.selected = true);
            } else {
                Array.from(dropdown.querySelectorAll('input[type="checkbox"]')).forEach(c => c.checked = false);
                Array.from(sel.options).forEach(o => o.selected = false);
            }
            sel.dispatchEvent(new Event('change'));
            updateFyButtonLabel();
        });

        function updateFyButtonLabel() {
            const allCheckboxes = Array.from(dropdown.querySelectorAll('input[type="checkbox"]')).filter(c => c.value !== '');
            const checked = allCheckboxes.filter(c => c.checked).map(c => c.value);
            const lab = wrapper.querySelector('.fy-label');
            if (!lab) return;
            if (checked.length === 0) lab.innerText = 'All';
            else if (checked.length === 1) lab.innerText = checked[0];
            else if (checked.length === allCheckboxes.length) lab.innerText = 'All';
            else lab.innerText = `${checked.length} selected`;
        }

        // show/hide dropdown
        button.addEventListener('click', (e) => { e.preventDefault(); const open = dropdown.style.display !== 'none'; document.querySelectorAll('.fy-dropdown').forEach(d => d.style.display = 'none'); dropdown.style.display = open ? 'none' : 'block'; });

        // update UI when native select changes (so clear helpers sync)
        sel.addEventListener('change', () => {
            // sync checkboxes
            Array.from(dropdown.querySelectorAll('input[type="checkbox"]')).forEach(chk => {
                if (chk === allChk) return; // skip all
                const found = Array.from(sel.options).find(o => o.value === chk.value);
                chk.checked = found ? found.selected : false;
            });
            // set All checkbox accordingly
            const nonAll = Array.from(dropdown.querySelectorAll('input[type="checkbox"]')).filter(c => c !== allChk && c.value !== '');
            const allState = nonAll.length > 0 && nonAll.every(c => c.checked);
            allChk.checked = allState;
            updateFyButtonLabel();
        });

        // assemble
        wrapper.appendChild(button);
        wrapper.appendChild(dropdown);
        sel.parentNode.insertBefore(wrapper, sel.nextSibling);

        // mark upgraded
        sel.dataset.upgraded = '1';

        // initialize label
        // trigger an initial sync based on current select options
        sel.dispatchEvent(new Event('change'));

        // close dropdown on outside click
        document.addEventListener('click', (ev) => {
            if (!wrapper.contains(ev.target)) dropdown.style.display = 'none';
        });
    }

   // --- GRN MODAL LOGIC ---
const grnModal = document.getElementById('grn-modal');
const closeGrnModal = document.getElementById('close-grn-modal');
const grnForm = document.getElementById('grn-form');

let savedGrnDetails = null;

// Open the GRN modal
function openGrnModal() {
  const task = wipTasks.find(t => t.id === currentWipId);
  // --- MODIFICATION START ---
  if (!task || (!isManagerView && task.owner !== currentUser.name)) return; // Guard clause + owner check
  // --- MODIFICATION END ---

  // --- NEW VALIDATION ---
  const poStatus = calculateWipStageOverallStatus(task.stages.poReleased, 'poReleased');
  if (poStatus !== 'Completed') {
      showAlertModal(
          "Cannot Add GRN", 
          "GRN details cannot be added until the 'PO Released' stage is completed."
      );
      return; // Stop execution
  }
  // --- END NEW VALIDATION ---

  currentStage = 'grn';

  // Check if GRN details already exist
  const existing = task.stages.grn?.data?.[0];

  if (existing) {
    // Fill existing details
    document.getElementById('optivalGrnId').value = existing.optivalGrnId;
    document.getElementById('grnDate').value = formatDateToYYYYMMDD(existing.grnDate);
        document.getElementById('grnQuantity').value = existing.grnQuantity || '';

    // Make fields read-only since GRN is completed
    document.getElementById('optivalGrnId').setAttribute('readonly', true);
    document.getElementById('grnDate').setAttribute('readonly', true);
        document.getElementById('grnQuantity').setAttribute('readonly', true);

    // Hide Save button to prevent edits
    grnForm.querySelector('button[type="submit"]').classList.add('hidden');
  } else {
    // No data yet  allow entry
    grnForm.reset();
        // ensure the quantity input is cleared and writable
        document.getElementById('grnQuantity').value = '';
        document.getElementById('grnQuantity').removeAttribute('readonly');
    document.getElementById('optivalGrnId').removeAttribute('readonly');
    document.getElementById('grnDate').removeAttribute('readonly');
    grnForm.querySelector('button[type="submit"]').classList.remove('hidden');
  }

  grnModal.classList.remove('hidden');
}

// Close the modal
closeGrnModal.addEventListener('click', () => {
  grnModal.classList.add('hidden');
});

// Save the GRN form
grnForm.addEventListener('submit', (e) => {
  e.preventDefault();

  const optivalGrnId = document.getElementById('optivalGrnId').value.trim();
  const grnDate = document.getElementById('grnDate').value;
  const grnQuantityRaw = document.getElementById('grnQuantity').value;
  const grnQuantity = parseInt(grnQuantityRaw, 10);
  const task = wipTasks.find(t => t.id === currentWipId);
  if (!task) {
      console.error("Task not found for GRN save:", currentWipId);
      alert("Error saving GRN details. Task not found.");
      return;
  }
  if (!optivalGrnId || !grnDate) {
      alert("Please fill in both Optival GRN ID and GRN Date.");
      return;
  }
  if (isNaN(grnQuantity) || grnQuantity <= 0) {
      alert('Please enter a valid GRN Quantity (greater than 0).');
      return;
  }

  // Save GRN data
  const newData = {
    id: Date.now(),
    optivalGrnId,
    grnDate: formatDateToDDMMYYYY(grnDate), // Ensure date is stored in DD-MM-YYYY
        grnQuantity,
    status: 'Completed'
  };

  if (!task.stages.grn) {
     task.stages.grn = { data: [] }; // Initialize if it doesn't exist
  }
  task.stages.grn.data = [newData]; // Replace or add the new data
  // The status for the GRN stage itself is implicitly 'Completed' when data exists,
  // based on calculateWipStageOverallStatus logic. We don't need a separate status property here.

  // --- No need to call renderGrnTable here, it's for the detail view ---
  // renderGrnTable(task.stages.grn.data);

  // --- No need to call updateGrnCardStatus here, renderWipDetail handles it ---
  // updateGrnCardStatus('Completed');

  // --- ADDED THIS LINE ---
  renderWipDetail(); // Re-render the main WIP detail view to update the card status text

  // If saving GRN causes the product to be marked as Launched, persist launched metadata once
  try {
      const newStatus = calculateWipStatus(task);
      if (newStatus === 'Launched' && !task.launchedOn) {
          // Use GRN date as launchedOn if available, else use today's date
          task.launchedOn = newData.grnDate || formatDateToDDMMYYYY(new Date().toISOString().split('T')[0]);
          task.launchedBy = currentUser && currentUser.name ? currentUser.name : '';
      }
  } catch (e) {
      console.warn('Could not determine new status after GRN save', e);
  }

  // Ensure lists update to show launched product in Launched tab
  renderNewProductsList();

  grnModal.classList.add('hidden');
  alert('GRN details saved successfully!');
});

// --- Render GRN Details Table ---
function renderGrnTable(grnData) {
  const tableContainer = document.getElementById('stage-detail-content');
  if (!tableContainer) return;

  if (!grnData || grnData.length === 0) {
    tableContainer.innerHTML = '<p class="text-slate-500">No GRN details available</p>';
    return;
  }

  const rows = grnData.map((row) => `
    <tr class="border-b">
            <td class="px-4 py-2">${row.optivalGrnId}</td>
            <td class="px-4 py-2">${row.grnDate}</td>
            <td class="px-4 py-2">${row.grnQuantity || ''}</td>
            <td class="px-4 py-2 text-green-600 font-semibold">${row.status}</td>
    </tr>
  `).join('');

  tableContainer.innerHTML = `
    <table class="w-full text-sm text-left border border-slate-200">
      <thead class="bg-slate-100">
        <tr>
                    <th class="px-4 py-2">Optival GRN ID</th>
                    <th class="px-4 py-2">GRN Date</th>
                    <th class="px-4 py-2">GRN Quantity</th>
                    <th class="px-4 py-2">Status</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}
// --- Update GRN Card Status ---
function updateGrnCardStatus(status) {
  const grnCard = document.querySelector('[data-stage="grn"]');
  if (!grnCard) return;

  // Add a small badge or green color to show completion
  if (status === 'Completed') {
    grnCard.classList.add('bg-green-100', 'border-green-400');
    grnCard.querySelector('.stage-status').textContent = 'Completed';
  }
}

    function showVendorDetailsPopup(proposalId, vendorId) {
        const p = proposals.find(prop => prop.id === proposalId);
        if (!p) return;

        const vendor = p.vendorIdentification.data.find(v => v.id == vendorId);
        const samples = p.sample.data.filter(s => s.vendorId == vendorId);
        const commercials = p.commercials.data.filter(c => c.vendorId == vendorId);
        // --- MODIFICATION START ---
        const agreementProposal = p.agreementProposal.data.filter(a => a.vendorId == vendorId); // Filtered proposal agreements
        // --- MODIFICATION END ---
        
        const contentContainer = document.getElementById('vendor-details-content');
        contentContainer.innerHTML = '';

        const buildSection = (title, dataArray) => {
            let sectionHtml = `<div class="mb-4"><h4 class="text-md font-semibold text-slate-800 mb-2 pb-2 border-b border-slate-200">${title}</h4>`;
            if (dataArray && dataArray.length > 0) {
                dataArray.forEach(data => {
                    sectionHtml += '<dl class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 text-sm mb-3 p-2 border border-slate-100 rounded-md">';
                    for (const [key, value] of Object.entries(data)) {
                        
                        // --- START MODIFICATION ---
                        let skipKey = false;
                        let displayKey = key;

                        // Rule 1: Remove 'Source' field only for 'Agreement (proposal) Details'
                        if (title === 'Agreement (proposal) Details' && key === 'source') {
                            skipKey = true;
                        }

                        // Rule 2: Change 'Upload' label to 'Uploaded File' only for 'Agreement (proposal) Details'
                        if (title === 'Agreement (proposal) Details' && key === 'upload') {
                            displayKey = 'Uploaded File';
                        }

                        // Rule 3: For Commercials Details, show 'Sample Name' instead of 'Sample Id'
                        if (title === 'Commercials Details' && key === 'sampleId') {
                            displayKey = 'Sample Name';
                        }
                        
                        // Check if key should be displayed
                        if (key !== 'id' && key !== 'vendorId' && key !== 'status' && key !== 'vendorName' && !skipKey) {
                        // --- END MODIFICATION ---

                            let displayValue = value;
                            if (key === 'pocs' && Array.isArray(value)) {
                                displayValue = value.map(poc => `${poc.pocName} (${poc.pocRole || 'N/A'})`).join(', ');
                            }
                            // Show sample name for commercials instead of sample id
                            else if (title === 'Commercials Details' && key === 'sampleId') {
                                const sampleObj = p && p.sample && p.sample.data ? p.sample.data.find(s => s.id == value) : null;
                                displayValue = sampleObj ? (sampleObj.sampleName || sampleObj.name || value) : value;
                            }
                            else if ((key === 'upload' || key === 'uploadedDocuments' || key === 'brandLogo') && value) {
                                displayValue = `<a href="data:text/plain;charset=utf-8,${encodeURIComponent('This is a dummy file for ' + value)}" download="${value}" class="app-link font-medium">${value}</a>`;
                            }
                            
                            // --- MODIFICATION ---
                            // Use displayKey instead of key
                            sectionHtml += `<div class="py-1"><dt class="font-medium text-slate-500 capitalize">${displayKey.replace(/([A-Z])/g, ' $1').trim()}</dt><dd class="text-slate-900">${displayValue || 'N/A'}</dd></div>`;
                        }
                    }
                    sectionHtml += '</dl>';
                });
            } else {
                sectionHtml += '<p class="text-sm text-slate-500">No data available for this stage.</p>';
            }
            sectionHtml += '</div>';
            return sectionHtml;
        };

        if(vendor) {
           contentContainer.innerHTML += buildSection('Vendor Identification', [vendor]);
        }
        contentContainer.innerHTML += buildSection('Sample Details', samples);
        contentContainer.innerHTML += buildSection('Commercials Details', commercials);
        contentContainer.innerHTML += buildSection('Agreement (proposal) Details', agreementProposal);

        document.getElementById('vendor-details-modal').classList.remove('hidden');
    }


    </script>
</body>
</html>
